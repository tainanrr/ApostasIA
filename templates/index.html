<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApostasIA ‚Äî Engine de An√°lise Preditiva</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --bg-card-hover: #1e2a42;
            --border: #2a3550;
            --border-light: #374163;
            --text-primary: #e8ecf4;
            --text-secondary: #8b95ab;
            --text-muted: #5a6580;
            --accent-green: #00e68a;
            --accent-green-dim: rgba(0,230,138,0.15);
            --accent-blue: #3b82f6;
            --accent-blue-dim: rgba(59,130,246,0.15);
            --accent-yellow: #f59e0b;
            --accent-yellow-dim: rgba(245,158,11,0.15);
            --accent-red: #ef4444;
            --accent-red-dim: rgba(239,68,68,0.15);
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --gradient-green: linear-gradient(135deg, #00e68a, #00b36b);
            --gradient-blue: linear-gradient(135deg, #3b82f6, #2563eb);
            --gradient-main: linear-gradient(135deg, #0a0e17 0%, #111827 50%, #0f1729 100%);
            --shadow-card: 0 4px 24px rgba(0,0,0,0.3);
            --shadow-glow: 0 0 20px rgba(0,230,138,0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 14px 32px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(12px);
        }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { font-size: 28px; }
        .logo h1 { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
        .logo span { color: var(--accent-green); }
        .header-right { display: flex; align-items: center; gap: 14px; }
        .header-badge {
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 20px; font-size: 12px;
            font-weight: 500; color: var(--text-secondary);
        }
        .header-badge.live { border-color: var(--accent-green); color: var(--accent-green); }
        .header-badge.warn { border-color: var(--accent-yellow); color: var(--accent-yellow); }

        /* ‚îÄ‚îÄ API QUOTA BAR ‚îÄ‚îÄ */
        .api-quota {
            display: flex; align-items: center; gap: 10px;
            background: var(--bg-card); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 20px; font-size: 11px;
            font-weight: 600;
        }
        .api-quota-bar {
            width: 80px; height: 6px; background: var(--border);
            border-radius: 3px; overflow: hidden;
        }
        .api-quota-fill {
            height: 100%; border-radius: 3px;
            transition: width 0.5s ease;
        }

        .btn-run {
            background: var(--gradient-green); border: none; color: #000;
            padding: 8px 20px; border-radius: 8px; font-size: 13px;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .btn-run:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,230,138,0.3); }
        .btn-run:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-run.running { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-recalc, .btn-recalc-big {
            background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; color: #fff;
            padding: 8px 16px; border-radius: 8px; font-size: 12px;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            font-family: 'Inter', sans-serif; margin-left: 6px;
        }
        .btn-recalc:hover, .btn-recalc-big:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(59,130,246,0.4); }
        .btn-recalc:disabled, .btn-recalc-big:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-recalc-big { padding: 14px 28px; font-size: 15px; margin-top: 10px; display: block; }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        main { max-width: 1440px; margin: 0 auto; padding: 24px 32px 60px; }

        /* ‚îÄ‚îÄ WELCOME / EMPTY STATE ‚îÄ‚îÄ */
        .welcome-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 60vh; text-align: center;
        }
        .welcome-icon { font-size: 80px; margin-bottom: 24px; animation: pulse 2s infinite; }
        .welcome-title { font-size: 28px; font-weight: 800; margin-bottom: 12px; }
        .welcome-sub { color: var(--text-secondary); font-size: 15px; max-width: 500px; line-height: 1.7; margin-bottom: 32px; }
        .welcome-info {
            display: flex; gap: 24px; margin-bottom: 32px; flex-wrap: wrap; justify-content: center;
        }
        .welcome-info-item {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 16px 24px; text-align: center;
        }
        .welcome-info-item .num { font-size: 20px; font-weight: 800; color: var(--accent-green); }
        .welcome-info-item .lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }
        .btn-run-big {
            background: var(--gradient-green); border: none; color: #000;
            padding: 16px 48px; border-radius: 12px; font-size: 16px;
            font-weight: 800; cursor: pointer; transition: all 0.2s;
            font-family: 'Inter', sans-serif; letter-spacing: -0.3px;
        }
        .btn-run-big:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,230,138,0.3); }
        .btn-run-big:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .welcome-cost {
            margin-top: 16px; font-size: 12px; color: var(--text-muted);
        }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }

        /* ‚îÄ‚îÄ PROGRESS OVERLAY ‚îÄ‚îÄ */
        .progress-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(10,14,23,0.92); backdrop-filter: blur(8px);
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .progress-overlay.show { display: flex; }
        .progress-icon { font-size: 64px; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        .progress-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .progress-sub { color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
        .progress-bar-bg {
            width: 320px; height: 4px; background: var(--border);
            border-radius: 2px; overflow: hidden; margin-bottom: 16px;
        }
        .progress-bar {
            width: 0%; height: 100%; background: var(--gradient-green);
            border-radius: 2px; animation: indeterminate 2s infinite;
        }
        @keyframes indeterminate {
            0% { margin-left: 0; width: 20%; }
            50% { margin-left: 40%; width: 40%; }
            100% { margin-left: 100%; width: 20%; }
        }
        .progress-phase {
            font-size: 13px; color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .progress-timer {
            margin-top: 8px; font-size: 24px; font-weight: 800;
            font-family: 'JetBrains Mono', monospace; color: var(--accent-green);
        }

        /* ‚îÄ‚îÄ LAST RUN INFO BAR ‚îÄ‚îÄ */
        .run-info-bar {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px 20px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; flex-wrap: wrap; gap: 12px;
        }
        .run-info-left { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .run-info-item { font-size: 13px; color: var(--text-secondary); }
        .run-info-item strong { color: var(--text-primary); font-weight: 700; }
        .run-info-item .accent { color: var(--accent-green); font-weight: 700; }
        .run-info-separator { width: 1px; height: 20px; background: var(--border); }

        /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px; margin-bottom: 28px;
        }
        .stat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px;
            transition: all 0.2s;
        }
        .stat-card:hover { border-color: var(--border-light); transform: translateY(-2px); box-shadow: var(--shadow-card); }
        .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 800; letter-spacing: -1px; }
        .stat-value.green { color: var(--accent-green); }
        .stat-value.blue { color: var(--accent-blue); }
        .stat-value.yellow { color: var(--accent-yellow); }
        .stat-value.purple { color: var(--accent-purple); }
        .stat-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 4px; margin-bottom: 24px;
            background: var(--bg-secondary); border-radius: var(--radius);
            padding: 4px; border: 1px solid var(--border); width: fit-content;
        }
        .tab {
            padding: 10px 20px; border-radius: var(--radius-sm);
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; color: var(--text-secondary); border: none;
            background: transparent; font-family: 'Inter', sans-serif;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--accent-green); color: #000; }

        /* ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ */
        .section { display: none; }
        .section.active { display: block; }
        .section-title {
            font-size: 20px; font-weight: 700; margin-bottom: 16px;
            display: flex; align-items: center; gap: 10px;
        }
        .section-title .icon { font-size: 24px; }
        .section-count {
            background: var(--accent-green-dim); color: var(--accent-green);
            padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 700;
        }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .table-wrap {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-lg); overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 1300px; }
        thead th {
            background: var(--bg-secondary); padding: 10px 12px;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px;
            color: var(--text-muted); font-weight: 700; text-align: left;
            border-bottom: 1px solid var(--border); white-space: nowrap;
            position: sticky; top: 0; z-index: 10;
        }
        tbody td {
            padding: 10px 12px; font-size: 13px; border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        tbody tr { transition: background 0.15s; }
        tbody tr:hover { background: var(--bg-card-hover); }
        tbody tr:last-child td { border-bottom: none; }

        .team-cell { font-weight: 600; white-space: nowrap; }
        .vs { color: var(--text-muted); font-weight: 400; margin: 0 4px; font-size: 11px; }

        .badge {
            display: inline-block; padding: 3px 10px; border-radius: 6px;
            font-size: 11px; font-weight: 700; white-space: nowrap;
        }
        .badge-high { background: var(--accent-green-dim); color: var(--accent-green); }
        .badge-med { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .badge-low { background: var(--accent-red-dim); color: var(--accent-red); }

        .edge-cell { font-weight: 800; font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .edge-high { color: var(--accent-green); }
        .edge-med { color: var(--accent-yellow); }

        .odd-cell { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .prob-bar-bg {
            width: 60px; height: 6px; background: var(--border);
            border-radius: 3px; overflow: hidden; display: inline-block;
            vertical-align: middle; margin-left: 6px;
        }
        .prob-bar { height: 100%; border-radius: 3px; }

        .market-tag {
            display: inline-block; padding: 3px 8px; border-radius: 5px;
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .market-1x2 { background: var(--accent-blue-dim); color: var(--accent-blue); }
        .market-dc { background: rgba(46, 134, 222, 0.2); color: #2e86de; }
        .market-ou { background: var(--accent-purple); color: #fff; opacity: 0.85; }
        .market-btts { background: var(--accent-cyan); color: #000; opacity: 0.85; }
        .market-corners { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .market-cards { background: var(--accent-red-dim); color: var(--accent-red); }
        .market-cs { background: rgba(0,206,209,0.18); color: #00ced1; }
        .market-wtn { background: rgba(255,165,0,0.18); color: #ffa500; }
        .market-ht { background: rgba(147,112,219,0.18); color: #9370db; }
        .market-oe { background: rgba(255,105,180,0.18); color: #ff69b4; }
        .market-exact { background: rgba(34,139,34,0.18); color: #228b22; }
        .market-shots { background: rgba(255,69,0,0.18); color: #ff4500; }
        .market-shots-real { background: rgba(255,69,0,0.30); color: #ff4500; border: 1px solid #ff4500; font-weight: 600; }
        .market-player-shots { background: rgba(186,85,211,0.18); color: #ba55d3; }
        .market-team-ou { background: rgba(255,215,0,0.18); color: #daa520; }

        /* ‚îÄ‚îÄ RESULT STATUS BADGES ‚îÄ‚îÄ */
        .result-green { background: var(--accent-green-dim); color: var(--accent-green); padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 800; display:inline-block; }
        .result-red { background: var(--accent-red-dim); color: var(--accent-red); padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 800; display:inline-block; }
        .result-void { background: rgba(107,114,128,0.2); color: #9ca3af; padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 800; display:inline-block; }
        .result-pending { background: rgba(245,158,11,0.12); color: var(--accent-yellow); padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; display:inline-block; }

        /* ‚îÄ‚îÄ GAME STATUS BADGES ‚îÄ‚îÄ */
        .game-live {
            background: linear-gradient(135deg, rgba(239,68,68,0.25), rgba(239,68,68,0.10));
            color: #ff6b6b; padding: 2px 7px; border-radius: 4px; font-size: 9px;
            font-weight: 800; display: inline-block; letter-spacing: 0.5px;
            animation: livePulse 2s infinite; border: 1px solid rgba(239,68,68,0.35);
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.65; }
        }
        .game-finished {
            background: rgba(107,114,128,0.15); color: #9ca3af; padding: 2px 7px;
            border-radius: 4px; font-size: 9px; font-weight: 700; display: inline-block;
        }
        .game-upcoming {
            background: rgba(59,130,246,0.12); color: var(--accent-blue); padding: 2px 7px;
            border-radius: 4px; font-size: 9px; font-weight: 700; display: inline-block;
        }

        /* ‚îÄ‚îÄ ROW HIGHLIGHTS BY GAME STATUS ‚îÄ‚îÄ */
        tr.row-live { background: rgba(239,68,68,0.04) !important; }
        tr.row-live:hover { background: rgba(239,68,68,0.08) !important; }
        tr.row-finished { opacity: 0.85; }
        tr.row-green { background: rgba(0,230,138,0.03) !important; }
        tr.row-green:hover { background: rgba(0,230,138,0.07) !important; }
        tr.row-red { background: rgba(239,68,68,0.03) !important; }
        tr.row-red:hover { background: rgba(239,68,68,0.07) !important; }

        /* ‚îÄ‚îÄ DATE PICKER ‚îÄ‚îÄ */
        .date-picker-group {
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; padding: 4px 12px;
        }
        .date-picker-group label { font-size: 11px; color: var(--text-muted); font-weight: 600; }
        .date-picker-group input[type="date"],
        .date-picker-group input[type="datetime-local"] {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 5px; color: var(--text-primary); font-size: 12px;
            padding: 4px 8px; font-family: 'JetBrains Mono', monospace;
        }
        .date-picker-group input[type="date"]:focus,
        .date-picker-group input[type="datetime-local"]:focus { border-color: var(--accent-green); outline: none; }

        /* Column datetime range filter */
        .col-filter-datetime {
            display: flex; flex-direction: column; gap: 2px; min-width: 135px;
        }
        .col-filter-datetime input[type="datetime-local"] {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 4px; color: var(--text-primary); font-size: 10px;
            padding: 2px 4px; font-family: 'JetBrains Mono', monospace;
            width: 100%;
        }
        .col-filter-datetime input[type="datetime-local"]:focus {
            border-color: var(--accent-green); outline: none;
        }
        .col-filter-datetime label {
            font-size: 8px; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
        }

        .btn-check-results {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; color: #fff;
            padding: 8px 16px; border-radius: 8px; font-size: 12px;
            font-weight: 700; cursor: pointer; transition: all 0.2s;
            font-family: 'Inter', sans-serif; min-width: 120px; text-align: center;
            line-height: 1.3;
        }
        .btn-check-results:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(139,92,246,0.4); }
        .btn-check-results:disabled { opacity: 0.7; cursor: wait; transform: none;
            animation: btnPulse 1.5s infinite; }
        @keyframes btnPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139,92,246,0.4); }
            50% { box-shadow: 0 0 0 8px rgba(139,92,246,0); }
        }

        /* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .dash-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px; overflow: hidden;
        }
        .dash-card-title {
            font-size: 13px; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        .dash-summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px; margin-bottom: 24px;
        }
        .dash-summary-card {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 16px; text-align: center;
        }
        .dash-summary-card .num { font-size: 28px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .dash-summary-card .lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; font-weight: 600; }
        .dash-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .dash-table thead th {
            padding: 8px 10px; font-size: 10px; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-muted); font-weight: 700;
            text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap;
        }
        .dash-table tbody td {
            padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.03);
            vertical-align: middle;
        }
        .dash-table tbody tr:hover { background: var(--bg-card-hover); }
        .profit-positive { color: var(--accent-green); font-weight: 800; }
        .profit-negative { color: var(--accent-red); font-weight: 800; }
        .roi-positive { color: var(--accent-green); }
        .roi-negative { color: var(--accent-red); }
        .hit-rate-bar {
            display: inline-block; width: 50px; height: 6px; background: var(--border);
            border-radius: 3px; overflow: hidden; vertical-align: middle; margin-left: 6px;
        }
        .hit-rate-bar-fill { height: 100%; border-radius: 3px; }

        /* ‚îÄ‚îÄ SORTABLE TABLE HEADERS ‚îÄ‚îÄ */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            white-space: nowrap;
            transition: background 0.15s;
        }
        th.sortable:hover {
            background: rgba(0, 230, 118, 0.08);
        }
        th.sortable::after {
            content: '‚áÖ';
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.3;
        }
        th.sortable.sort-asc::after {
            content: '‚ñ≤';
            opacity: 0.9;
            color: var(--accent-green);
        }
        th.sortable.sort-desc::after {
            content: '‚ñº';
            opacity: 0.9;
            color: var(--accent-green);
        }

        /* ‚îÄ‚îÄ COLUMN FILTERS ‚îÄ‚îÄ */
        .col-filter-row th {
            padding: 4px 3px;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border);
        }
        .col-filter {
            width: 100%;
            box-sizing: border-box;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 10px;
            padding: 3px 4px;
            outline: none;
        }
        .col-filter:focus {
            border-color: var(--accent-green);
        }
        .col-filter::placeholder {
            color: var(--text-muted);
            font-size: 9px;
        }
        select.col-filter {
            font-size: 10px;
            padding: 3px 2px;
        }
        .col-filter-num {
            width: 100%;
            display: flex;
            gap: 2px;
        }
        .col-filter-num input {
            width: 50%;
            box-sizing: border-box;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 9px;
            padding: 3px 3px;
            outline: none;
        }
        .col-filter-num input:focus {
            border-color: var(--accent-green);
        }
        .col-filter-num input::placeholder {
            color: var(--text-muted);
            font-size: 8px;
        }

        /* ‚îÄ‚îÄ DETAIL MODAL ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);
            display: none; align-items: flex-start; justify-content: center;
            padding: 20px 10px;
            overflow-y: auto;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-lg); width: 98%; max-width: 1400px;
            max-height: none; box-shadow: 0 25px 60px rgba(0,0,0,0.6);
            margin: auto;
        }
        .modal-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        .modal-header h2 { font-size: 18px; font-weight: 700; }
        .modal-header .subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .modal-header .close {
            background: none; border: none; color: var(--text-muted);
            font-size: 24px; cursor: pointer; padding: 4px 8px; line-height: 1;
        }
        .modal-header .close:hover { color: var(--text-primary); }
        .modal-body { padding: 24px; }
        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;
        }
        .detail-item { }
        .detail-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; letter-spacing: 0.5px; }
        .detail-value { font-size: 15px; font-weight: 600; }
        .detail-reasoning {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 16px; margin-top: 16px;
            font-size: 13px; line-height: 1.7; color: var(--text-secondary);
        }
        .detail-reasoning strong { color: var(--text-primary); }

        /* ‚îÄ‚îÄ MODAL TABS ‚îÄ‚îÄ */
        .modal-tabs {
            display: flex; gap: 0; border-bottom: 2px solid var(--border);
            margin-bottom: 20px; overflow-x: auto;
        }
        .modal-tab {
            padding: 10px 18px; font-size: 12px; font-weight: 600;
            color: var(--text-muted); cursor: pointer; border: none;
            background: transparent; border-bottom: 2px solid transparent;
            margin-bottom: -2px; white-space: nowrap; transition: all 0.2s;
            font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .modal-tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.02); }
        .modal-tab.active { color: var(--accent-green); border-bottom-color: var(--accent-green); }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }

        /* ‚îÄ‚îÄ TEAM COMPARISON ‚îÄ‚îÄ */
        .team-compare {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 0;
            margin-bottom: 20px;
        }
        .team-col { padding: 16px; }
        .team-col-home { text-align: right; }
        .team-col-away { text-align: left; }
        .team-col-vs {
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700; color: var(--text-muted);
            padding: 0 12px; min-width: 40px;
        }
        .team-name-lg {
            font-size: 18px; font-weight: 800; margin-bottom: 4px;
        }
        .team-badge-info {
            font-size: 11px; color: var(--text-muted); margin-bottom: 12px;
        }

        /* ‚îÄ‚îÄ STAT ROW (H2H bar) ‚îÄ‚îÄ */
        .stat-row {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03);
            align-items: center;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-row-val { font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 700; }
        .stat-row-val.home { text-align: right; padding-right: 12px; }
        .stat-row-val.away { text-align: left; padding-left: 12px; }
        .stat-row-label {
            text-align: center; font-size: 10px; text-transform: uppercase;
            color: var(--text-muted); letter-spacing: 0.8px; font-weight: 600;
        }
        .stat-bar-wrap {
            display: flex; height: 6px; border-radius: 3px; overflow: hidden;
            background: var(--border); margin-top: 4px;
        }
        .stat-bar-home {
            background: var(--accent-green); border-radius: 3px 0 0 3px; transition: width 0.6s ease;
        }
        .stat-bar-away {
            background: var(--accent-blue); border-radius: 0 3px 3px 0; transition: width 0.6s ease;
        }

        /* ‚îÄ‚îÄ ODDS GRID ‚îÄ‚îÄ */
        .odds-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px; margin-bottom: 16px;
        }
        .odds-card {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px; text-align: center;
        }
        .odds-card-label {
            font-size: 10px; text-transform: uppercase; color: var(--text-muted);
            font-weight: 600; letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .odds-card-value {
            font-family: 'JetBrains Mono', monospace; font-size: 18px;
            font-weight: 800; color: var(--accent-yellow);
        }
        .odds-card-prob {
            font-size: 11px; color: var(--text-secondary); margin-top: 2px;
        }

        /* ‚îÄ‚îÄ CONTEXT CARDS ‚îÄ‚îÄ */
        .ctx-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;
        }
        .ctx-card {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 10px; padding: 14px;
        }
        .ctx-card-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            color: var(--text-muted); letter-spacing: 0.5px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .ctx-card-body { font-size: 13px; color: var(--text-secondary); line-height: 1.7; }

        /* ‚îÄ‚îÄ SECTION TITLE inside modal ‚îÄ‚îÄ */
        .m-section {
            font-size: 13px; font-weight: 700; color: var(--text-primary);
            text-transform: uppercase; letter-spacing: 0.8px;
            margin: 20px 0 12px; padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }
        .m-section:first-child { margin-top: 0; }

        .form-dots { display: flex; gap: 3px; }
        .form-dot {
            width: 18px; height: 18px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 800;
        }
        .form-W { background: var(--accent-green-dim); color: var(--accent-green); }
        .form-D { background: var(--accent-yellow-dim); color: var(--accent-yellow); }
        .form-L { background: var(--accent-red-dim); color: var(--accent-red); }

        /* ‚îÄ‚îÄ LEAGUE CARDS ‚îÄ‚îÄ */
        .league-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .league-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 20px; cursor: default;
            transition: all 0.2s;
        }
        .league-card:hover { border-color: var(--border-light); transform: translateY(-2px); box-shadow: var(--shadow-card); }
        .league-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .league-card-name { font-weight: 700; font-size: 15px; }
        .league-card-country { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .league-card-stats { display: flex; gap: 16px; }
        .league-card-stat { text-align: center; }
        .league-card-stat .num { font-size: 22px; font-weight: 800; }
        .league-card-stat .lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }

        /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
        .filter-bar {
            display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;
        }
        .filter-select {
            background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-primary); padding: 8px 14px; border-radius: var(--radius-sm);
            font-size: 13px; font-family: 'Inter', sans-serif; cursor: pointer;
        }
        .filter-select:focus { outline: none; border-color: var(--accent-green); }
        .filter-input {
            background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-primary); padding: 8px 14px; border-radius: var(--radius-sm);
            font-size: 13px; font-family: 'Inter', sans-serif; width: 200px;
        }
        .filter-input::placeholder { color: var(--text-muted); }
        .filter-input:focus { outline: none; border-color: var(--accent-green); }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; }
            main { padding: 16px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .detail-grid { grid-template-columns: 1fr; }
            .tabs { overflow-x: auto; width: 100%; }
            .filter-bar { flex-direction: column; }
            .welcome-info { flex-direction: column; align-items: center; }
            .header-right { flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<!-- PROGRESS OVERLAY (s√≥ aparece durante execu√ß√£o) -->
<div class="progress-overlay" id="progress-overlay">
    <div class="progress-icon">‚öΩ</div>
    <div class="progress-title">Executando Pipeline de An√°lise</div>
    <div class="progress-sub">Buscando dados, modelando probabilidades, identificando valor...</div>
    <div class="progress-bar-bg"><div class="progress-bar"></div></div>
    <div class="progress-phase" id="progress-phase">Conectando √† API-Football...</div>
    <div class="progress-timer" id="progress-timer">00:00</div>
</div>

<!-- HEADER -->
<header>
    <div class="logo">
        <div class="logo-icon">‚öΩ</div>
        <div>
            <h1>Apostas<span>IA</span></h1>
        </div>
    </div>
    <div class="header-right">
        <div class="date-picker-group">
            <label>De:</label>
            <input type="date" id="date-start" title="Data in√≠cio da an√°lise">
            <label>At√©:</label>
            <input type="date" id="date-end" title="Data fim da an√°lise">
        </div>
        <div class="api-quota" id="api-quota">
            <span>API:</span>
            <div class="api-quota-bar"><div class="api-quota-fill" id="api-quota-fill" style="width:0%;background:var(--accent-green)"></div></div>
            <span id="api-quota-text">--/--</span>
        </div>
        <div class="header-badge" id="badge-status">‚óè Aguardando</div>
        <button class="btn-run" id="btn-run" onclick="executeEngine()">‚ñ∂ Executar</button>
        <button class="btn-recalc" id="btn-recalc" onclick="recalculateEngine()" title="Recalcular modelos usando dados j√° em cache (0 API calls)">üîÑ Recalc</button>
        <button class="btn-check-results" id="btn-check-results" onclick="checkResults()" title="Verificar resultados de jogos finalizados">‚úÖ Resultados</button>
    </div>
</header>

<!-- MAIN -->
<main>
    <!-- WELCOME STATE (quando n√£o h√° dados) -->
    <div id="welcome-state" class="welcome-state">
        <div class="welcome-icon">‚öΩ</div>
        <div class="welcome-title">ApostasIA Engine</div>
        <div class="welcome-sub">
            Sistema Aut√¥nomo de An√°lise Quantitativa Esportiva.<br>
            Clique abaixo para executar o pipeline de an√°lise e identificar oportunidades de valor (+EV) em jogos de futebol.
        </div>
        <div class="welcome-info">
            <div class="welcome-info-item">
                <div class="num" id="w-dates">--</div>
                <div class="lbl">Datas de An√°lise</div>
            </div>
            <div class="welcome-info-item">
                <div class="num" id="w-api-avail">--</div>
                <div class="lbl">Requests Dispon√≠veis</div>
            </div>
            <div class="welcome-info-item">
                <div class="num" id="w-api-used">--</div>
                <div class="lbl">Requests Usadas Hoje</div>
            </div>
            <div class="welcome-info-item">
                <div class="num" id="w-plan">--</div>
                <div class="lbl">Plano</div>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap;justify-content:center">
            <div class="date-picker-group" style="padding:8px 16px">
                <label style="font-size:12px">üìÖ De:</label>
                <input type="date" id="w-date-start" style="font-size:13px;padding:6px 10px">
                <label style="font-size:12px">At√©:</label>
                <input type="date" id="w-date-end" style="font-size:13px;padding:6px 10px">
            </div>
        </div>
        <button class="btn-run-big" id="btn-run-big" onclick="executeEngine()">‚ñ∂ Executar An√°lise Completa</button>
        <button class="btn-recalc-big" id="btn-recalc-big" onclick="recalculateEngine()">üîÑ Recalcular (0 API calls)</button>
        <div class="welcome-cost">Custo estimado: ~620 requests por execu√ß√£o | Recalcular: 0 requests</div>
        <div id="w-last-run" style="margin-top:16px;font-size:13px;color:var(--text-muted)"></div>
        <div id="w-run-history" style="margin-top:12px;font-size:11px;color:var(--text-muted)"></div>
    </div>

    <!-- DASHBOARD (aparece ap√≥s execu√ß√£o) -->
    <div id="dashboard" style="display:none">

        <!-- RUN INFO BAR -->
        <div class="run-info-bar" id="run-info-bar">
            <div class="run-info-left">
                <div class="run-info-item">üïê √öltima execu√ß√£o: <strong id="ri-last-run">--</strong></div>
                <div class="run-info-separator"></div>
                <div class="run-info-item">üìÖ Dados: <strong id="ri-dates">--</strong></div>
                <div class="run-info-separator"></div>
                <div class="run-info-item">‚è± Pipeline: <strong id="ri-runtime">--</strong></div>
                <div class="run-info-separator"></div>
                <div class="run-info-item">üì° API calls: <span class="accent" id="ri-api-calls">--</span></div>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-row" id="stats-row"></div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" data-tab="opportunities" onclick="switchTab('opportunities')">üéØ Oportunidades +EV</button>
            <button class="tab" data-tab="matches" onclick="switchTab('matches')">‚öΩ Todos os Jogos</button>
            <button class="tab" data-tab="leagues" onclick="switchTab('leagues')">üèÜ Ligas</button>
            <button class="tab" data-tab="performance" onclick="switchTab('performance'); loadDashboard()">üìä Dashboard</button>
        </div>

        <!-- OPPORTUNITIES -->
        <div class="section active" id="sec-opportunities">
            <div class="section-title">
                <span class="icon">üéØ</span> Oportunidades de Valor (+EV)
                <span class="section-count" id="opp-count">0</span>
                <span style="font-size:12px;color:var(--text-muted);font-weight:400;margin-left:8px">Clique nas colunas para ordenar | Use os filtros abaixo dos cabe√ßalhos</span>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
                <button onclick="clearAllFilters()" style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-muted);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px">üîÑ Limpar Filtros</button>
                <span id="filter-status" style="font-size:11px;color:var(--text-muted)"></span>
            </div>
            <div class="table-wrap">
                <table id="opp-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="index" data-type="num" onclick="sortTable(this)">#</th>
                            <th class="sortable" data-sort="team" data-type="str" onclick="sortTable(this)">Jogo</th>
                            <th class="sortable" data-sort="league" data-type="str" onclick="sortTable(this)">Liga</th>
                            <th class="sortable" data-sort="date" data-type="str" onclick="sortTable(this)">Data</th>
                            <th class="sortable" data-sort="game_status" data-type="num" onclick="sortTable(this)">Status</th>
                            <th class="sortable" data-sort="result" data-type="str" onclick="sortTable(this)">Resultado</th>
                            <th class="sortable" data-sort="market" data-type="str" onclick="sortTable(this)">Mercado</th>
                            <th class="sortable" data-sort="selection" data-type="str" onclick="sortTable(this)">Sele√ß√£o</th>
                            <th class="sortable sort-desc" data-sort="odd" data-type="num" onclick="sortTable(this)">Odd</th>
                            <th class="sortable sort-desc" data-sort="edge" data-type="num" onclick="sortTable(this)">Edge</th>
                            <th class="sortable" data-sort="prob" data-type="num" onclick="sortTable(this)">Prob.</th>
                            <th class="sortable" data-sort="confidence" data-type="str" onclick="sortTable(this)">N√≠vel</th>
                        </tr>
                        <tr class="col-filter-row">
                            <th></th>
                            <th><input class="col-filter" type="text" id="cf-team" placeholder="Time..." oninput="applyColumnFilters()"></th>
                            <th><select class="col-filter" id="cf-league" onchange="applyColumnFilters()"><option value="">Todas</option></select></th>
                            <th><div class="col-filter-datetime">
                                <input type="datetime-local" id="cf-dt-start" title="De (data/hora)" oninput="applyColumnFilters()">
                                <input type="datetime-local" id="cf-dt-end" title="At√© (data/hora)" oninput="applyColumnFilters()">
                            </div></th>
                            <th><select class="col-filter" id="cf-game-status" onchange="applyColumnFilters()">
                                <option value="">Todos</option>
                                <option value="LIVE">üî¥ Ao Vivo</option>
                                <option value="FINISHED">‚úî Encerrado</option>
                                <option value="UPCOMING">üìÖ Futuro</option>
                            </select></th>
                            <th><select class="col-filter" id="cf-result" onchange="applyColumnFilters()">
                                <option value="">Todos</option>
                                <option value="GREEN">‚úÖ GREEN</option>
                                <option value="RED">‚ùå RED</option>
                                <option value="VOID">‚¨ú VOID</option>
                                <option value="PENDENTE">‚è≥ PENDENTE</option>
                            </select></th>
                            <th><select class="col-filter" id="cf-market" onchange="applyColumnFilters()">
                                <option value="">Todos</option>
                                <option value="1x2">1x2</option>
                                <option value="Dupla Chance">Dupla Chance</option>
                                <option value="Gols O/U">Gols O/U</option>
                                <option value="BTTS">BTTS</option>
                                <option value="Gols Casa O/U">Gols Casa</option>
                                <option value="Gols Fora O/U">Gols Fora</option>
                                <option value="Clean Sheet">Clean Sheet</option>
                                <option value="Vit. s/ Sofrer">Vit s/ Sofrer</option>
                                <option value="1o Tempo">1o Tempo</option>
                                <option value="Par/Impar">Par/Impar</option>
                                <option value="Escanteios O/U">Escanteios</option>
                                <option value="Cartoes O/U">Cartoes</option>
                                <option value="Finaliz">Finaliza√ß√µes</option>
                            </select></th>
                            <th><input class="col-filter" type="text" id="cf-selection" placeholder="Sele√ß√£o..." oninput="applyColumnFilters()"></th>
                            <th><div class="col-filter-num"><input type="number" id="cf-odd-min" placeholder="Min" step="0.1" oninput="applyColumnFilters()"><input type="number" id="cf-odd-max" placeholder="Max" step="0.1" oninput="applyColumnFilters()"></div></th>
                            <th><div class="col-filter-num"><input type="number" id="cf-edge-min" placeholder="Min" step="1" oninput="applyColumnFilters()"><input type="number" id="cf-edge-max" placeholder="Max" step="1" oninput="applyColumnFilters()"></div></th>
                            <th><div class="col-filter-num"><input type="number" id="cf-prob-min" placeholder="Min" step="1" oninput="applyColumnFilters()"><input type="number" id="cf-prob-max" placeholder="Max" step="1" oninput="applyColumnFilters()"></div></th>
                            <th><select class="col-filter" id="cf-confidence" onchange="applyColumnFilters()">
                                <option value="">Todos</option>
                                <option value="ALTO">ALTO</option>
                                <option value="M√âDIO">M√âDIO</option>
                                <option value="BAIXO">BAIXO</option>
                            </select></th>
                        </tr>
                    </thead>
                    <tbody id="opp-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- MATCHES -->
        <div class="section" id="sec-matches">
            <div class="section-title">
                <span class="icon">‚öΩ</span> Todas as Partidas
                <span class="section-count" id="match-count">0</span>
            </div>
            <div class="filter-bar">
                <select class="filter-select" id="filter-match-league" onchange="filterMatches()">
                    <option value="all">Todas as Ligas</option>
                </select>
                <div class="col-filter-datetime" style="flex-direction:row;gap:6px;align-items:center;min-width:auto">
                    <label style="font-size:10px;white-space:nowrap">De:</label>
                    <input type="datetime-local" id="filter-match-dt-start" oninput="filterMatches()" style="font-size:11px;padding:4px 6px">
                    <label style="font-size:10px;white-space:nowrap">At√©:</label>
                    <input type="datetime-local" id="filter-match-dt-end" oninput="filterMatches()" style="font-size:11px;padding:4px 6px">
                </div>
                <input class="filter-input" type="text" id="filter-match-search" placeholder="Buscar time..." oninput="filterMatches()">
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Jogo</th>
                            <th>Liga</th>
                            <th>Data/Hora</th>
                            <th>xG Casa</th>
                            <th>xG Fora</th>
                            <th>H%</th>
                            <th>D%</th>
                            <th>A%</th>
                            <th>O/U 2.5</th>
                            <th>BTTS</th>
                            <th>Corners</th>
                            <th>Cart√µes</th>
                            <th>Clima</th>
                        </tr>
                    </thead>
                    <tbody id="match-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- LEAGUES -->
        <div class="section" id="sec-leagues">
            <div class="section-title">
                <span class="icon">üèÜ</span> Ligas Analisadas
            </div>
            <div class="league-grid" id="league-grid"></div>
        </div>

        <!-- PERFORMANCE DASHBOARD -->
        <div class="section" id="sec-performance">
            <div class="section-title">
                <span class="icon">üìä</span> Dashboard de Performance
                <span class="section-count" id="dash-total">0</span>
                <span style="font-size:12px;color:var(--text-muted);font-weight:400;margin-left:8px">An√°lise completa de resultados ‚Äî 1 unidade por aposta</span>
            </div>
            <div id="dashboard-content">
                <div style="text-align:center;padding:40px;color:var(--text-muted)">
                    <div style="font-size:40px;margin-bottom:12px">üìä</div>
                    <div style="font-size:14px">Clique em <strong>‚úÖ Resultados</strong> para verificar jogos finalizados e popular o dashboard.</div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- DETAIL MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h2 id="modal-title"></h2>
                <div style="color:var(--text-secondary);font-size:13px;margin-top:4px" id="modal-subtitle"></div>
            </div>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA STORES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allOpps = [];
let allMatches = [];
let allLeagues = [];
let stats = {};
let apiStatus = {};
let engineRunning = false;
let timerInterval = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME STATUS HELPER (LIVE / FINISHED / UPCOMING)
// Considera 120 min para jogo em andamento e conclu√≠do
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGameStatus(matchDate, matchTime) {
    const now = new Date();
    // Construir datetime do jogo
    const timeParts = (matchTime || '00:00').split(':');
    const hh = parseInt(timeParts[0]) || 0;
    const mm = parseInt(timeParts[1]) || 0;
    
    const dateParts = (matchDate || '').split('-');
    if (dateParts.length < 3) return { status: 'UPCOMING', timeLabel: '?', minutesUntil: 0 };
    
    const matchDt = new Date(
        parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]),
        hh, mm, 0
    );
    
    const diffMs = now - matchDt;
    const diffMin = diffMs / 60000;
    
    if (diffMin < 0) {
        // Jogo ainda n√£o come√ßou
        const minUntil = Math.abs(diffMin);
        let timeLabel;
        if (minUntil < 60) timeLabel = Math.round(minUntil) + 'min';
        else if (minUntil < 1440) timeLabel = Math.round(minUntil / 60) + 'h';
        else timeLabel = Math.round(minUntil / 1440) + 'd';
        return { status: 'UPCOMING', timeLabel: timeLabel, minutesUntil: minUntil };
    } else if (diffMin <= 120) {
        // Jogo em andamento (< 120 min desde o in√≠cio)
        return { status: 'LIVE', timeLabel: Math.round(diffMin) + "'", minutesUntil: 0 };
    } else {
        // Jogo encerrado (> 120 min desde o in√≠cio)
        return { status: 'FINISHED', timeLabel: 'FT', minutesUntil: 0 };
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKET CLASS HELPER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getMarketClass(market) {
    if (!market) return 'market-ou';
    const m = market.toLowerCase();
    if (m === '1x2') return 'market-1x2';
    if (m.includes('dupla chance')) return 'market-dc';
    if (m.includes('btts')) return 'market-btts';
    if (m.includes('clean sheet')) return 'market-cs';
    if (m.includes('sofrer')) return 'market-wtn';
    if (m.includes('1o tempo') || m.includes('1¬∞ tempo')) return 'market-ht';
    if (m.includes('par/impar') || m.includes('par') || m.includes('impar')) return 'market-oe';
    if (m.includes('placar exato')) return 'market-exact';
    if (m.includes('fin. jogador') || m.includes('sot jogador')) return 'market-player-shots';
    if (m.includes('finaliz') && m.includes('1x2')) return 'market-shots-real';
    if (m.includes('finaliz') || m.includes('sot')) return 'market-shots';
    if (m.includes('escanteio') || m.includes('corners')) return 'market-corners';
    if (m.includes('cart')) return 'market-cards';
    if (m.includes('gols casa') || m.includes('gols fora')) return 'market-team-ou';
    if (m.includes('gols') || m.includes('o/u')) return 'market-ou';
    return 'market-ou';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALL MARKETS ODDS BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildAllMarketsOdds(m) {
    const _MARKET_LABELS = {
        "1x2": "‚öΩ 1x2 (Match Winner)",
        "double_chance": "üéØ Dupla Chance",
        "goals_ou": "‚öΩ Gols Over/Under",
        "btts": "ü§ù Ambas Marcam (BTTS)",
        "home_goals_ou": "üè† Gols Casa O/U",
        "away_goals_ou": "‚úàÔ∏è Gols Fora O/U",
        "cs_home": "üß§ Clean Sheet Casa",
        "cs_away": "üß§ Clean Sheet Fora",
        "wtn_home": "üí™ Vit√≥ria s/ Sofrer Casa",
        "wtn_away": "üí™ Vit√≥ria s/ Sofrer Fora",
        "odd_even": "üé≤ Par/Impar Gols",
        "ht_result": "‚è±Ô∏è 1¬∞ Tempo (Resultado)",
        "ht_goals_ou": "‚è±Ô∏è 1¬∞ Tempo Gols O/U",
        "h2_goals_ou": "‚è±Ô∏è 2¬∞ Tempo Gols O/U",
        "corners_ou": "üèÅ Escanteios O/U",
        "cards_ou": "üü® Cartoes O/U",
        "exact_score": "üéØ Placar Exato (Top)",
        "asian_handicap": "üìê Asian Handicap",
        "ht_ft": "‚è±Ô∏è HT/FT",
        "win_both_halves": "üí™ Vencer Ambos Tempos",
        "both_halves_score": "‚öΩ Gol em Ambos Tempos",
        "result_total": "üìä Resultado & Total",
        "sot_1x2": "üéØ Finaliz. Gol 1x2",
        "shots_1x2": "üéØ Finaliza√ß√µes 1x2",
        "sot_ou": "üéØ Finaliz. Gol O/U",
        "shots_ou": "üéØ Finaliza√ß√µes O/U",
        "home_shots_ou": "üè† Finaliz. Casa O/U",
        "away_shots_ou": "‚úàÔ∏è Finaliz. Fora O/U",
    };
    const _SEL_LABELS = {
        "home": "Casa", "draw": "Empate", "away": "Fora",
        "home/draw": "1X (Casa ou Empate)", "draw/away": "X2 (Fora ou Empate)", "home/away": "12 (Casa ou Fora)",
        "yes": "Sim", "no": "Nao", "odd": "Impar", "even": "Par",
    };
    const probs = m.model_probs || {};
    const markets = m.all_markets || {};
    // Also include legacy odds
    if (!markets["1x2"]) markets["1x2"] = {home: m.odds_home, draw: m.odds_draw, away: m.odds_away};
    if (!markets["goals_ou"]) markets["goals_ou"] = {over_2_5: m.odds_over25, under_2_5: m.odds_under25};
    if (!markets["btts"]) markets["btts"] = {yes: m.odds_btts_yes, no: m.odds_btts_no};

    // Helper: BOOKMAKER_COLORS
    const _BK_COLORS = {
        "bet365": "#007b5e", "pinnacle": "#e74c3c", "1xbet": "#1a5276",
        "betway": "#00a0e3", "bwin": "#ffcc00", "william hill": "#003b2f",
        "marathonbet": "#1e4d8c", "unibet": "#147b45", "betfair": "#ffb80c",
        "888sport": "#1a1a1a", "sportingbet": "#006e33", "betano": "#ff6600",
    };
    const bkColor = (name) => {
        const k = (name || '').toLowerCase();
        for (const [bk, c] of Object.entries(_BK_COLORS)) { if (k.includes(bk)) return c; }
        return '#3b82f6';
    };

    let html = '';
    const orderedKeys = ["1x2","double_chance","goals_ou","btts","home_goals_ou","away_goals_ou",
        "ht_result","ht_goals_ou","h2_goals_ou","cs_home","cs_away","wtn_home","wtn_away","odd_even",
        "corners_ou","cards_ou","sot_1x2","shots_1x2","sot_ou","shots_ou","home_shots_ou","away_shots_ou",
        "exact_score","asian_handicap","ht_ft","win_both_halves","both_halves_score","result_total"];
    const allKeys = new Set([...orderedKeys, ...Object.keys(markets)]);
    for (const mk of allKeys) {
        const mkt = markets[mk];
        if (!mkt || typeof mkt !== 'object') continue;
        const bkData = mkt._bookmakers || {};
        const bkNames = Object.keys(bkData);
        const hasMultiBk = bkNames.length > 1;
        const entries = Object.entries(mkt).filter(([k,v]) => typeof v === 'number' && v > 1.0);
        if (!entries.length) continue;
        const label = _MARKET_LABELS[mk] || mk.replace(/_/g,' ').toUpperCase();
        const sourceNote = mkt._source ? ` <span style="font-size:10px;color:var(--text-muted)">(${mkt._source})</span>` : '';
        const multiBkBadge = hasMultiBk ? ` <span style="font-size:9px;padding:2px 6px;background:rgba(59,130,246,0.15);color:var(--accent-cyan);border-radius:4px;font-weight:700">${bkNames.length} casas</span>` : '';

        html += `<div style="margin-top:14px">
            <div style="font-size:12px;font-weight:700;color:var(--accent-cyan);margin-bottom:6px">${label}${sourceNote}${multiBkBadge}</div>
            <div class="odds-grid">`;

        // ‚îÄ‚îÄ Odds do bookmaker principal ‚îÄ‚îÄ
        for (const [sk, odd] of entries) {
            const selLabel = _SEL_LABELS[sk] || sk.replace(/_/g,' ').replace(/over_/i,'O ').replace(/under_/i,'U ');
            const probKey = `${mk}__${sk}`;
            const modelP = probs[probKey];
            const probStr = modelP ? `<div class="odds-card-prob">Modelo: ${(modelP*100).toFixed(1)}%</div>` : '';
            const fairStr = modelP ? `<div class="odds-card-prob" style="color:var(--accent-yellow)">Fair: ${(1/modelP).toFixed(2)}</div>` : '';
            const isEV = modelP && (modelP * odd - 1) > 0.03;
            const evStyle = isEV ? 'border:1px solid var(--accent-green);background:rgba(46,213,115,0.08)' : '';
            html += `<div class="odds-card" style="${evStyle}">
                <div class="odds-card-label">${selLabel}</div>
                <div class="odds-card-value">${odd}</div>
                ${probStr}${fairStr}
                ${isEV ? '<div style="font-size:9px;color:var(--accent-green);font-weight:700;margin-top:2px">‚úì EV+</div>' : ''}
            </div>`;
        }
        html += '</div>';

        // ‚îÄ‚îÄ Comparativo multi-bookmaker ‚îÄ‚îÄ
        if (hasMultiBk) {
            // Coletar todas as sele√ß√µes dispon√≠veis (chaves num√©ricas/string)
            const allSels = new Set();
            for (const bkn of bkNames) {
                for (const [k, v] of Object.entries(bkData[bkn])) {
                    if (typeof v === 'number' && v > 1.0) allSels.add(k);
                }
            }
            const selsArr = [...allSels].sort();
            if (selsArr.length > 0 && selsArr.length <= 30) {
                html += `<details style="margin-top:6px"><summary style="cursor:pointer;font-size:10px;color:var(--accent-cyan);font-weight:700;padding:2px 0">‚ñ∂ Comparar ${bkNames.length} casas de apostas</summary>`;
                html += `<div style="overflow-x:auto;margin-top:6px"><table style="width:100%;font-size:11px;border-collapse:collapse">
                    <thead><tr style="border-bottom:1px solid var(--border)">
                        <th style="text-align:left;padding:4px 8px;color:var(--text-secondary);font-weight:600;min-width:110px">Casa</th>`;
                for (const sel of selsArr) {
                    const selLbl = _SEL_LABELS[sel] || sel.replace(/_/g,' ').replace(/over_/i,'O ').replace(/under_/i,'U ');
                    html += `<th style="text-align:center;padding:4px 6px;color:var(--text-secondary);font-weight:600;white-space:nowrap">${selLbl}</th>`;
                }
                html += `</tr></thead><tbody>`;

                // Para cada sele√ß√£o, encontrar a melhor odd
                const bestOdds = {};
                for (const sel of selsArr) {
                    let best = 0;
                    for (const bkn of bkNames) {
                        const val = bkData[bkn][sel];
                        if (typeof val === 'number' && val > best) best = val;
                    }
                    bestOdds[sel] = best;
                }

                for (const bkn of bkNames) {
                    const c = bkColor(bkn);
                    const info = getBookmakerInfo(bkn);
                    const link = info.footballUrl;
                    const nameHtml = link
                        ? `<a href="${link}" target="_blank" rel="noopener" style="color:${c};text-decoration:none;font-weight:700" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${info.name}</a>`
                        : `<span style="color:${c};font-weight:700">${bkn}</span>`;
                    html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
                        <td style="padding:5px 8px">${nameHtml}</td>`;
                    for (const sel of selsArr) {
                        const val = bkData[bkn][sel];
                        const isNum = typeof val === 'number' && val > 1.0;
                        const isBest = isNum && val === bestOdds[sel] && bkNames.length > 1;
                        const probKey2 = `${mk}__${sel}`;
                        const mp = probs[probKey2];
                        const isEV2 = mp && isNum && (mp * val - 1) > 0.03;
                        const cellStyle = isBest
                            ? 'font-weight:800;color:var(--accent-green);background:rgba(46,213,115,0.06)'
                            : isEV2 ? 'font-weight:700;color:var(--accent-green)' : 'color:var(--text-primary)';
                        html += `<td style="text-align:center;padding:5px 6px;${cellStyle};font-family:'JetBrains Mono',monospace">${isNum ? val.toFixed(2) : '-'}${isBest ? ' ‚òÖ' : ''}${isEV2 && !isBest ? ' ‚úì' : ''}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div></details>';
            }
        }
        html += '</div>';
    }
    return html || '<div style="color:var(--text-muted);padding:16px">Nenhuma odd dispon√≠vel para este jogo</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOKMAKER URLs + DEEP LINK BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BOOKMAKER_URLS = {
    "bet365":        { name: "Bet365",       color: "#007b5e", football: "https://www.bet365.com/#/AC/B1/C1/D1002/E76/G40/" },
    "1xbet":         { name: "1xBet",        color: "#1a5276", football: "https://1xbet.com/en/line/football/" },
    "pinnacle":      { name: "Pinnacle",     color: "#e74c3c", football: "https://www.pinnacle.com/pt/football/" },
    "betway":        { name: "Betway",       color: "#00a0e3", football: "https://betway.com/pt/sports/soccer" },
    "bwin":          { name: "Bwin",         color: "#ffcc00", football: "https://sports.bwin.com/pt/sports/futebol-4" },
    "william hill":  { name: "William Hill", color: "#003b2f", football: "https://sports.williamhill.com/betting/pt-pt/football" },
    "marathonbet":   { name: "Marathonbet",  color: "#1e4d8c", football: "https://www.marathonbet.com/en/betting/Football/" },
    "unibet":        { name: "Unibet",       color: "#147b45", football: "https://www.unibet.com/betting/sports/football" },
    "betfair":       { name: "Betfair",      color: "#ffb80c", football: "https://www.betfair.com/sport/football" },
    "888sport":      { name: "888sport",     color: "#1a1a1a", football: "https://www.888sport.com/football/" },
    "sportingbet":   { name: "Sportingbet",  color: "#006e33", football: "https://sports.sportingbet.com/pt-br/sports/futebol-4" },
    "betano":        { name: "Betano",       color: "#ff6600", football: "https://www.betano.com/sport/futebol" },
    "rivalo":        { name: "Rivalo",       color: "#1a237e", football: "https://www.rivalo.com/pt-br/sports/football" },
    "novibet":       { name: "Novibet",      color: "#1b1464", football: "https://www.novibet.com/sports/football" },
    "superbet":      { name: "Superbet",     color: "#e60000", football: "https://superbet.com/sports/football" },
};

function getBookmakerInfo(bkName) {
    if (!bkName || bkName === "N/D") {
        return { name: bkName || "N/D", url: null, footballUrl: null, color: "#555" };
    }
    const key = bkName.toLowerCase().trim();
    for (const [k, v] of Object.entries(BOOKMAKER_URLS)) {
        if (key.includes(k) || k.includes(key)) {
            return { name: v.name, url: v.football, footballUrl: v.football, color: v.color };
        }
    }
    return {
        name: bkName,
        url: null,
        footballUrl: null,
        color: "#3b82f6"
    };
}

function buildBetLink(bkName, homeTeam, awayTeam) {
    const info = getBookmakerInfo(bkName);
    // Link direto para a se√ß√£o de futebol da casa
    return info.footballUrl || null;
}

function buildNavPath(leagueCountry, leagueName) {
    // Monta o caminho de navega√ß√£o dentro da casa de apostas
    if (!leagueCountry && !leagueName) return "";
    return `Futebol ‚Üí ${leagueCountry || "?"} ‚Üí ${leagueName || "?"}`;
}

function bookmakerBadgeHtml(bkName, homeTeam, awayTeam, market, selection, small, leagueCountry, leagueName) {
    const info = getBookmakerInfo(bkName);
    const betLink = buildBetLink(bkName, homeTeam, awayTeam);
    const sz = small ? 'font-size:10px;padding:3px 8px;' : 'font-size:12px;padding:5px 12px;';
    
    if (!betLink) {
        return `<span style="${sz}background:rgba(85,85,85,0.2);color:#888;border-radius:5px;white-space:nowrap">${info.name}</span>`;
    }
    const navTip = buildNavPath(leagueCountry, leagueName);
    const titleTxt = navTip ? `Ir para ${info.name} ‚Äî Navegue: ${navTip}` : `Ir para ${info.name} Futebol`;
    return `<a href="${betLink}" target="_blank" rel="noopener" onclick="event.stopPropagation()" 
        style="${sz}background:rgba(59,130,246,0.15);color:var(--accent-blue);border-radius:5px;
        text-decoration:none;white-space:nowrap;display:inline-flex;align-items:center;gap:4px;
        border:1px solid rgba(59,130,246,0.25);transition:all 0.2s;cursor:pointer"
        onmouseover="this.style.background='rgba(59,130,246,0.3)';this.style.borderColor='var(--accent-blue)'"
        onmouseout="this.style.background='rgba(59,130,246,0.15)';this.style.borderColor='rgba(59,130,246,0.25)'"
        title="${titleTxt}">
        üîó ${info.name}
    </a>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT ‚Äî N√ÉO roda pipeline, s√≥ carrega status
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
    // 0. Inicializar date pickers com hoje e amanh√£
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const todayStr = today.toISOString().split('T')[0];
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    document.getElementById("date-start").value = todayStr;
    document.getElementById("date-end").value = tomorrowStr;
    document.getElementById("w-date-start").value = todayStr;
    document.getElementById("w-date-end").value = tomorrowStr;
    
    // Sincronizar date pickers header <-> welcome
    document.getElementById("date-start").addEventListener("change", () => {
        document.getElementById("w-date-start").value = document.getElementById("date-start").value;
    });
    document.getElementById("date-end").addEventListener("change", () => {
        document.getElementById("w-date-end").value = document.getElementById("date-end").value;
    });
    document.getElementById("w-date-start").addEventListener("change", () => {
        document.getElementById("date-start").value = document.getElementById("w-date-start").value;
    });
    document.getElementById("w-date-end").addEventListener("change", () => {
        document.getElementById("date-end").value = document.getElementById("w-date-end").value;
    });

    // 1. Buscar status da API (1 request apenas)
    try {
        const res = await fetch("/api/status");
        apiStatus = await res.json();
        updateApiQuotaDisplay();
    } catch(e) {
        console.error("Erro ao buscar status:", e);
    }

    // 2. Buscar hist√≥rico de runs para mostrar datas j√° analisadas
    try {
        const runsRes = await fetch("/api/run-dates");
        const runs = await runsRes.json();
        if (runs && runs.length > 0) {
            const histHtml = runs.slice(0, 5).map(r => {
                const dates = (r.analysis_dates || []).join(', ');
                const dt = r.executed_at ? new Date(r.executed_at).toLocaleString('pt-BR') : '?';
                return `<span style="background:var(--bg-card);padding:3px 10px;border-radius:5px;border:1px solid var(--border)">${dates} <span style="color:var(--text-muted)">(${dt})</span></span>`;
            }).join(' ');
            const histEl = document.getElementById("w-run-history");
            if (histEl) histEl.innerHTML = `üìã √öltimas an√°lises: ${histHtml}`;
        }
    } catch(e) {}

    // 3. Se j√° tem dados em cache (servidor j√° rodou antes), carregar
    if (apiStatus.has_data) {
        await loadCachedData();
    } else {
        // Mostrar welcome state
        showWelcomeState();
    }
}

function updateApiQuotaDisplay() {
    const used = apiStatus.used || 0;
    const limit = apiStatus.limit || 7500;
    const available = apiStatus.available || (limit - used);
    const pct = (used / limit) * 100;
    
    const fill = document.getElementById("api-quota-fill");
    fill.style.width = pct + "%";
    fill.style.background = pct > 80 ? "var(--accent-red)" : pct > 50 ? "var(--accent-yellow)" : "var(--accent-green)";
    
    document.getElementById("api-quota-text").textContent = `${used}/${limit}`;
    
    // Welcome info items
    document.getElementById("w-api-avail").textContent = available.toLocaleString();
    document.getElementById("w-api-used").textContent = used.toLocaleString();
    document.getElementById("w-plan").textContent = apiStatus.plan || "--";
    
    if (apiStatus.last_run_at) {
        document.getElementById("w-last-run").innerHTML = 
            `üïê √öltima execu√ß√£o: <strong>${apiStatus.last_run_at}</strong> (${apiStatus.api_calls_last_run || 0} requests)`;
    }
}

function showWelcomeState() {
    document.getElementById("welcome-state").style.display = "flex";
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("badge-status").textContent = "‚óè Aguardando";
    document.getElementById("badge-status").style.color = "var(--text-muted)";
    document.getElementById("badge-status").style.borderColor = "var(--border)";
}

function showDashboard() {
    document.getElementById("welcome-state").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD CACHED DATA (sem rodar pipeline)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCachedData() {
    try {
        const [statsRes, oppsRes, matchesRes, leaguesRes] = await Promise.all([
            fetch("/api/stats").then(r => r.json()),
            fetch("/api/opportunities").then(r => r.json()),
            fetch("/api/matches").then(r => r.json()),
            fetch("/api/leagues").then(r => r.json()),
        ]);

        if (statsRes.ok === false) {
            showWelcomeState();
            return;
        }

        stats = statsRes;
        allOpps = oppsRes;
        allMatches = matchesRes;
        allLeagues = leaguesRes;

        renderAll();
        showDashboard();
        
        document.getElementById("badge-status").textContent = "‚óè PRONTO";
        document.getElementById("badge-status").style.color = "var(--accent-green)";
        document.getElementById("badge-status").style.borderColor = "var(--accent-green)";
        document.getElementById("btn-run").textContent = "‚ü≥ Re-Executar";
    } catch(e) {
        console.error(e);
        showWelcomeState();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXECUTE ENGINE (manual only)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function executeEngine() {
    if (engineRunning) return;
    
    // Confirmar com o usu√°rio
    const cost = "~620";
    const avail = apiStatus.available || "?";
    if (!confirm(`Executar pipeline de an√°lise?\n\nCusto estimado: ${cost} requests\nDispon√≠veis hoje: ${avail}\n\nIsso pode levar 5-8 minutos.`)) {
        return;
    }
    
    engineRunning = true;
    
    // Mostrar progresso
    document.getElementById("progress-overlay").classList.add("show");
    document.getElementById("btn-run").disabled = true;
    document.getElementById("btn-run").classList.add("running");
    document.getElementById("btn-run").textContent = "‚ü≥ Executando...";
    document.getElementById("badge-status").textContent = "‚óè PROCESSANDO";
    document.getElementById("badge-status").style.color = "var(--accent-yellow)";
    document.getElementById("badge-status").style.borderColor = "var(--accent-yellow)";
    
    // Timer
    let seconds = 0;
    timerInterval = setInterval(() => {
        seconds++;
        const m = String(Math.floor(seconds / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        document.getElementById("progress-timer").textContent = `${m}:${s}`;
        
        // Update phase messages based on time
        if (seconds < 5) document.getElementById("progress-phase").textContent = "Verificando status da conta...";
        else if (seconds < 15) document.getElementById("progress-phase").textContent = "Buscando fixtures globais (T e T+1)...";
        else if (seconds < 60) document.getElementById("progress-phase").textContent = "Buscando standings de ligas...";
        else if (seconds < 180) document.getElementById("progress-phase").textContent = "Buscando odds reais de mercado...";
        else if (seconds < 300) document.getElementById("progress-phase").textContent = "Buscando dados de les√µes...";
        else if (seconds < 360) document.getElementById("progress-phase").textContent = "Buscando clima (OpenWeatherMap)...";
        else if (seconds < 420) document.getElementById("progress-phase").textContent = "Executando modelos (Dixon-Coles + Monte Carlo)...";
        else document.getElementById("progress-phase").textContent = "Finalizando an√°lise de valor...";
    }, 1000);

    try {
        const startDate = document.getElementById("date-start").value;
        const endDate = document.getElementById("date-end").value;
        const runRes = await fetch("/api/run", { 
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ start_date: startDate, end_date: endDate })
        });
        const runData = await runRes.json();
        
        clearInterval(timerInterval);
        
        if (!runData.ok) {
            alert("Erro ao executar: " + (runData.error || "desconhecido"));
            return;
        }

        // Carregar dados
        const [statsRes, oppsRes, matchesRes, leaguesRes] = await Promise.all([
            fetch("/api/stats").then(r => r.json()),
            fetch("/api/opportunities").then(r => r.json()),
            fetch("/api/matches").then(r => r.json()),
            fetch("/api/leagues").then(r => r.json()),
        ]);

        stats = statsRes;
        allOpps = oppsRes;
        allMatches = matchesRes;
        allLeagues = leaguesRes;

        renderAll();
        showDashboard();
        
        // Atualizar status da API
        try {
            const statusRes = await fetch("/api/status");
            apiStatus = await statusRes.json();
            updateApiQuotaDisplay();
        } catch(e) {}

    } catch (e) {
        clearInterval(timerInterval);
        console.error(e);
        alert("Erro: " + e.message);
    } finally {
        engineRunning = false;
        document.getElementById("progress-overlay").classList.remove("show");
        document.getElementById("btn-run").disabled = false;
        document.getElementById("btn-run").classList.remove("running");
        document.getElementById("btn-run").textContent = "‚ü≥ Re-Executar";
        document.getElementById("badge-status").textContent = "‚óè PRONTO";
        document.getElementById("badge-status").style.color = "var(--accent-green)";
        document.getElementById("badge-status").style.borderColor = "var(--accent-green)";
    }
}

async function recalculateEngine() {
    if (engineRunning) return;

    if (!confirm('Recalcular modelos e oportunidades usando dados j√° em cache?\n\n‚úÖ ZERO requisi√ß√µes √† API (0 cr√©ditos)\n‚úÖ Aplica novos mercados (finaliza√ß√µes, etc.)\n‚úÖ Recalcula todas as probabilidades\n\n‚è±Ô∏è Estimativa: 15-60 segundos')) {
        return;
    }

    engineRunning = true;

    // Mostrar progresso
    document.getElementById("progress-overlay").classList.add("show");
    document.getElementById("btn-run").disabled = true;
    document.getElementById("btn-recalc").disabled = true;
    document.getElementById("badge-status").textContent = "‚óè RECALCULANDO";
    document.getElementById("badge-status").style.color = "var(--accent-blue)";
    document.getElementById("badge-status").style.borderColor = "var(--accent-blue)";

    let seconds = 0;
    timerInterval = setInterval(() => {
        seconds++;
        const m = String(Math.floor(seconds / 60)).padStart(2, '0');
        const s = String(seconds % 60).padStart(2, '0');
        document.getElementById("progress-timer").textContent = `${m}:${s}`;

        if (seconds < 3) document.getElementById("progress-phase").textContent = "Carregando dados do cache...";
        else if (seconds < 10) document.getElementById("progress-phase").textContent = "Reconstruindo partidas...";
        else if (seconds < 30) document.getElementById("progress-phase").textContent = "Executando modelos (Dixon-Coles + Finaliza√ß√µes)...";
        else if (seconds < 50) document.getElementById("progress-phase").textContent = "Escaneando oportunidades +EV...";
        else document.getElementById("progress-phase").textContent = "Salvando resultados...";
    }, 1000);

    try {
        const res = await fetch("/api/recalculate", { method: "POST" });
        const data = await res.json();

        clearInterval(timerInterval);

        if (!data.ok) {
            alert("Erro ao recalcular: " + (data.error || "desconhecido"));
            return;
        }

        // Recarregar dados
        const [statsRes, oppsRes, matchesRes, leaguesRes] = await Promise.all([
            fetch("/api/stats").then(r => r.json()),
            fetch("/api/opportunities").then(r => r.json()),
            fetch("/api/matches").then(r => r.json()),
            fetch("/api/leagues").then(r => r.json()),
        ]);

        stats = statsRes;
        allOpps = oppsRes;
        allMatches = matchesRes;
        allLeagues = leaguesRes;

        renderAll();
        showDashboard();

        alert(`‚úÖ Recalculo concluido!\n\n${data.total_opportunities} oportunidades encontradas\n0 requisicoes a API`);

    } catch (e) {
        clearInterval(timerInterval);
        console.error(e);
        alert("Erro: " + e.message);
    } finally {
        engineRunning = false;
        document.getElementById("progress-overlay").classList.remove("show");
        document.getElementById("btn-run").disabled = false;
        document.getElementById("btn-recalc").disabled = false;
        document.getElementById("badge-status").textContent = "‚óè PRONTO";
        document.getElementById("badge-status").style.color = "var(--accent-green)";
        document.getElementById("badge-status").style.borderColor = "var(--accent-green)";
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHECK RESULTS ‚Äî Verificar jogos finalizados
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkResults() {
    const btn = document.getElementById("btn-check-results");
    btn.disabled = true;
    
    // Timer de progresso visual
    const startTime = Date.now();
    let timerInterval;
    const phases = [
        { t: 0, text: "Buscando oportunidades pendentes..." },
        { t: 3, text: "Filtrando jogos encerrados (>120min)..." },
        { t: 6, text: "Consultando resultados na API..." },
        { t: 15, text: "Processando resultados (pode levar alguns minutos)..." },
        { t: 45, text: "Ainda processando jogos... Quase l√°!" },
        { t: 120, text: "Muitos jogos a processar... Aguarde..." },
    ];
    
    timerInterval = setInterval(() => {
        const elapsed = Math.round((Date.now() - startTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        const timeStr = mins > 0 ? `${mins}m${String(secs).padStart(2,'0')}s` : `${secs}s`;
        
        // Fase atual baseada no tempo
        let phase = phases[0].text;
        for (let i = phases.length - 1; i >= 0; i--) {
            if (elapsed >= phases[i].t) { phase = phases[i].text; break; }
        }
        
        btn.innerHTML = `‚è≥ ${timeStr} <span style="font-size:9px;opacity:0.8;display:block">${phase}</span>`;
    }, 500);
    
    try {
        const res = await fetch("/api/check-results", { method: "POST" });
        const data = await res.json();
        clearInterval(timerInterval);
        
        const elapsed = Math.round((Date.now() - startTime) / 1000);
        const elapsedStr = elapsed > 60 ? `${Math.floor(elapsed/60)}m${elapsed%60}s` : `${elapsed}s`;
        
        if (!data.ok) {
            alert("Erro: " + (data.error || "desconhecido"));
            return;
        }
        
        // Mostrar resultado detalhado
        let msg = `‚úÖ Verifica√ß√£o conclu√≠da em ${elapsedStr}\n\n`;
        msg += `üìã Total pendentes: ${data.total_pending || 0}\n`;
        msg += `‚è≠ Ignorados (ainda em jogo/futuro): ${data.skipped_not_finished || 0}\n`;
        msg += `üîç Jogos consultados (encerrados): ${data.checked}\n`;
        msg += `üìä Jogos com resultado: ${data.finished}\n`;
        msg += `‚úèÔ∏è Oportunidades resolvidas: ${data.resolved}\n`;
        if (data.resolved > 0) {
            msg += `\nüü¢ GREEN: ${data.green}\nüî¥ RED: ${data.red}\n‚¨ú VOID: ${data.void || 0}`;
        }
        if (data.resolved === 0 && data.checked === 0) {
            msg += `\n‚ÑπÔ∏è ${data.msg || 'Nenhum jogo encerrado para verificar.'}`;
        }
        
        alert(msg);
        
        // Recarregar dados para mostrar resultados atualizados na tabela
        btn.innerHTML = "üîÑ Atualizando tabela...";
        await loadCachedData();
        dashboardLoaded = false; // For√ßar reload do dashboard
        loadDashboard();
        
    } catch (e) {
        clearInterval(timerInterval);
        console.error(e);
        alert("Erro de conex√£o: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = "‚úÖ Resultados";
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD ‚Äî Carregar e renderizar
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dashboardData = null;
let dashboardLoaded = false;

async function loadDashboard() {
    if (dashboardLoaded && dashboardData) {
        renderDashboard(dashboardData);
        return;
    }
    
    const container = document.getElementById("dashboard-content");
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:24px;animation:pulse 1.5s infinite">‚è≥</div><div style="margin-top:8px">Carregando dashboard...</div></div>';
    
    try {
        const res = await fetch("/api/dashboard");
        const result = await res.json();
        
        if (!result.ok || !result.data) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:40px;margin-bottom:12px">üìä</div><div>Nenhum dado de performance ainda. Clique em <strong>‚úÖ Resultados</strong> para verificar jogos.</div></div>';
            return;
        }
        
        dashboardData = result.data;
        dashboardLoaded = true;
        document.getElementById("dash-total").textContent = dashboardData.total_count || 0;
        renderDashboard(dashboardData);
    } catch (e) {
        console.error(e);
        container.innerHTML = `<div style="color:var(--accent-red);padding:20px">Erro ao carregar dashboard: ${e.message}</div>`;
    }
}

function renderDashboard(data) {
    const s = data.summary || {};
    const container = document.getElementById("dashboard-content");
    
    const profitClass = (v) => v >= 0 ? 'profit-positive' : 'profit-negative';
    const roiClass = (v) => v >= 0 ? 'roi-positive' : 'roi-negative';
    const hitColor = (hr) => hr >= 60 ? 'var(--accent-green)' : hr >= 45 ? 'var(--accent-yellow)' : 'var(--accent-red)';
    
    let html = '';
    
    // ‚îÄ‚îÄ SUMMARY CARDS ‚îÄ‚îÄ
    html += `<div class="dash-summary-grid">
        <div class="dash-summary-card">
            <div class="num" style="color:var(--accent-blue)">${s.total || 0}</div>
            <div class="lbl">Total Resolvidas</div>
        </div>
        <div class="dash-summary-card">
            <div class="num" style="color:var(--accent-green)">${s.green || 0}</div>
            <div class="lbl">üü¢ Greens</div>
        </div>
        <div class="dash-summary-card">
            <div class="num" style="color:var(--accent-red)">${s.red || 0}</div>
            <div class="lbl">üî¥ Reds</div>
        </div>
        <div class="dash-summary-card">
            <div class="num" style="color:${hitColor(s.hit_rate || 0)}">${s.hit_rate || 0}%</div>
            <div class="lbl">Taxa de Acerto</div>
        </div>
        <div class="dash-summary-card">
            <div class="num ${profitClass(s.profit || 0)}">${(s.profit || 0) >= 0 ? '+' : ''}${(s.profit || 0).toFixed(2)}u</div>
            <div class="lbl">Lucro Total</div>
        </div>
        <div class="dash-summary-card">
            <div class="num ${roiClass(s.roi || 0)}">${(s.roi || 0) >= 0 ? '+' : ''}${s.roi || 0}%</div>
            <div class="lbl">ROI</div>
        </div>
        <div class="dash-summary-card">
            <div class="num" style="color:var(--accent-yellow)">${data.pending_count || 0}</div>
            <div class="lbl">‚è≥ Pendentes</div>
        </div>
        <div class="dash-summary-card">
            <div class="num" style="color:var(--text-secondary)">${s.avg_odd || 0}</div>
            <div class="lbl">Odd M√©dia</div>
        </div>
    </div>`;
    
    // ‚îÄ‚îÄ Tabela helper ‚îÄ‚îÄ
    function renderGroupTable(title, icon, items, extraCols) {
        if (!items || !items.length) return '';
        let h = `<div class="dash-card" style="grid-column: span 1">
            <div class="dash-card-title">${icon} ${title}</div>
            <div style="overflow-x:auto;max-height:400px;overflow-y:auto">
            <table class="dash-table">
                <thead><tr>
                    <th>${extraCols || 'Categoria'}</th>
                    <th style="text-align:center">Total</th>
                    <th style="text-align:center">üü¢</th>
                    <th style="text-align:center">üî¥</th>
                    <th style="text-align:center">Acerto</th>
                    <th style="text-align:right">Lucro</th>
                    <th style="text-align:right">ROI</th>
                </tr></thead>
                <tbody>`;
        items.forEach(item => {
            const hr = item.hit_rate || 0;
            h += `<tr>
                <td style="font-weight:600;white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis">${item.label || '?'}</td>
                <td style="text-align:center">${item.total || 0}</td>
                <td style="text-align:center;color:var(--accent-green);font-weight:700">${item.green || 0}</td>
                <td style="text-align:center;color:var(--accent-red);font-weight:700">${item.red || 0}</td>
                <td style="text-align:center">
                    <span style="color:${hitColor(hr)};font-weight:700">${hr}%</span>
                    <div class="hit-rate-bar"><div class="hit-rate-bar-fill" style="width:${hr}%;background:${hitColor(hr)}"></div></div>
                </td>
                <td style="text-align:right" class="${profitClass(item.profit || 0)}">${(item.profit || 0) >= 0 ? '+' : ''}${(item.profit || 0).toFixed(2)}u</td>
                <td style="text-align:right" class="${roiClass(item.roi || 0)}">${(item.roi || 0) >= 0 ? '+' : ''}${item.roi || 0}%</td>
            </tr>`;
        });
        h += '</tbody></table></div></div>';
        return h;
    }
    
    // ‚îÄ‚îÄ GRIDS ‚îÄ‚îÄ
    html += '<div class="dashboard-grid">';
    html += renderGroupTable('Por Mercado', 'üéØ', data.by_market, 'Mercado');
    html += renderGroupTable('Por Confian√ßa', 'üìà', data.by_confidence, 'N√≠vel');
    html += renderGroupTable('Por Faixa de Edge', 'üìê', data.by_edge_range, 'Faixa Edge');
    html += renderGroupTable('Por Faixa de Odds', 'üí∞', data.by_odds_range, 'Faixa Odds');
    html += renderGroupTable('Por Liga', 'üèÜ', data.by_league, 'Liga');
    html += renderGroupTable('Por Pa√≠s', 'üåç', data.by_country, 'Pa√≠s');
    html += renderGroupTable('Por Casa de Apostas', 'üè¶', data.by_bookmaker, 'Bookmaker');
    html += renderGroupTable('Por Data', 'üìÖ', (data.by_date || []).slice(0, 30), 'Data');
    html += '</div>';
    
    container.innerHTML = html;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ALL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
    renderRunInfo();
    renderStats();
    renderOpportunities();
    renderMatches();
    renderLeagues();
    populateFilters();
}

function renderRunInfo() {
    document.getElementById("ri-last-run").textContent = stats.last_run_at || "--";
    const dates = stats.analysis_dates || [];
    document.getElementById("ri-dates").textContent = 
        dates.length >= 2 ? `${dates[0]} ‚Üí ${dates[dates.length - 1]}` : (dates[0] || "--");
    document.getElementById("ri-runtime").textContent = stats.run_time ? `${stats.run_time}s` : "--";
    document.getElementById("ri-api-calls").textContent = stats.api_calls_this_run || "--";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${tab}"]`).classList.add("active");
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(`sec-${tab}`).classList.add("active");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderStats() {
    const row = document.getElementById("stats-row");
    row.innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Ligas Analisadas</div>
            <div class="stat-value blue">${stats.total_leagues}</div>
            <div class="stat-sub">Cobertura global</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Partidas Processadas</div>
            <div class="stat-value">${stats.total_matches}</div>
            <div class="stat-sub">${(stats.analysis_dates||[])[0] || '?'} ‚Üí ${(stats.analysis_dates||[]).slice(-1)[0] || '?'}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Oportunidades +EV</div>
            <div class="stat-value green">${stats.total_opportunities}</div>
            <div class="stat-sub">Edge ‚â• 5%</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Confian√ßa Alta</div>
            <div class="stat-value green">${stats.high_conf}</div>
            <div class="stat-sub">üü¢ Alta certeza</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Confian√ßa M√©dia</div>
            <div class="stat-value yellow">${stats.med_conf}</div>
            <div class="stat-sub">üü° Moderada</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Maior Edge</div>
            <div class="stat-value green">+${stats.max_edge}%</div>
            <div class="stat-sub">${stats.max_edge_match}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Edge M√©dio</div>
            <div class="stat-value purple">${stats.avg_edge}%</div>
            <div class="stat-sub">Todas oportunidades</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Tempo de Execu√ß√£o</div>
            <div class="stat-value">${stats.run_time}s</div>
            <div class="stat-sub">${stats.api_calls_this_run || 0} requests usadas</div>
        </div>
    `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER OPPORTUNITIES (j√° vem ordenada por Edge desc)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderOpportunities(data) {
    const opps = data || allOpps;
    document.getElementById("opp-count").textContent = opps.length;
    const tbody = document.getElementById("opp-tbody");

    tbody.innerHTML = opps.map((o, i) => {
        const confClass = o.confidence === "ALTO" ? "badge-high" : o.confidence === "M√âDIO" ? "badge-med" : "badge-low";
        const edgeClass = o.edge > 15 ? "edge-high" : "edge-med";
        const marketClass = getMarketClass(o.market);

        const suspectBadge = o.odds_suspect ? ' <span title="Possivel inversao Casa/Fora na API" style="cursor:help;color:var(--accent-yellow);font-size:13px">‚ö†Ô∏è</span>' : '';
        
        // Game status (LIVE / FINISHED / UPCOMING)
        const gs = getGameStatus(o.match_date, o.match_time);
        const gameStatusBadge = gs.status === 'LIVE' 
            ? '<span class="game-live">üî¥ AO VIVO</span>'
            : gs.status === 'FINISHED'
            ? '<span class="game-finished">‚úî Encerrado</span>'
            : '<span class="game-upcoming">üìÖ ' + gs.timeLabel + '</span>';
        
        // Result status badge
        const resultStatus = o.result_status || 'PENDENTE';
        const resultBadge = (() => {
            if (resultStatus === 'GREEN') return '<span class="result-green">‚úÖ GREEN</span>';
            if (resultStatus === 'RED') return '<span class="result-red">‚ùå RED</span>';
            if (resultStatus === 'VOID') return '<span class="result-void">‚¨ú VOID</span>';
            return '<span class="result-pending">‚è≥ Pend.</span>';
        })();
        const resultScore = o.result_score ? ` <span style="font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono'">${o.result_score}</span>` : '';
        
        // Row class based on status
        const rowClass = resultStatus === 'GREEN' ? 'row-green' 
            : resultStatus === 'RED' ? 'row-red'
            : gs.status === 'LIVE' ? 'row-live'
            : gs.status === 'FINISHED' ? 'row-finished' : '';
        const rowBorder = resultStatus === 'GREEN' ? ';border-left:3px solid var(--accent-green)' 
            : resultStatus === 'RED' ? ';border-left:3px solid var(--accent-red)' 
            : gs.status === 'LIVE' ? ';border-left:3px solid #ff6b6b'
            : o.odds_suspect ? ';border-left:3px solid var(--accent-yellow)' : '';
        
        return `<tr class="${rowClass}" onclick="showOppDetail(${allOpps.indexOf(o)})" style="cursor:pointer${rowBorder}">
            <td style="color:var(--text-muted);font-weight:600">${i+1}</td>
            <td class="team-cell">${o.home_team} <span class="vs">vs</span> ${o.away_team}${suspectBadge}</td>
            <td style="font-size:11px">${o.league_name}</td>
            <td style="font-size:11px;color:var(--text-secondary)">${o.match_date}<br>${o.match_time}</td>
            <td>${gameStatusBadge}</td>
            <td>${resultBadge}${resultScore}</td>
            <td><span class="market-tag ${marketClass}">${o.market}</span></td>
            <td style="font-weight:600;font-size:11px;color:var(--accent-green);max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${o.selection}">‚ñ∂ ${o.selection}</td>
            <td class="odd-cell">${o.market_odd.toFixed(2)}</td>
            <td class="edge-cell ${edgeClass}">${o.edge_pct}</td>
            <td style="font-size:12px">${o.model_prob}%</td>
            <td><span class="badge ${confClass}">${o.confidence}</span></td>
        </tr>`;
    }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER MATCHES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMatches(data) {
    const matches = data || allMatches;
    document.getElementById("match-count").textContent = matches.length;
    const tbody = document.getElementById("match-tbody");

    tbody.innerHTML = matches.map(m => {
        const weatherIcon = m.weather_rain > 5 ? "üåßÔ∏è" : m.weather_wind > 20 ? "üí®" : m.weather_temp > 30 ? "üå°Ô∏è" : "‚òÄÔ∏è";
        const fatigueIcons = (m.home_fatigue ? "‚ö°H " : "") + (m.away_fatigue ? "‚ö°A" : "");

        return `<tr onclick="showMatchDetail(${m.match_id})" style="cursor:pointer">
            <td class="team-cell">${m.home_team} <span class="vs">vs</span> ${m.away_team}${fatigueIcons ? '<br><span style="font-size:11px;color:var(--accent-yellow)">' + fatigueIcons + '</span>' : ''}</td>
            <td style="font-size:12px">${m.league_name}</td>
            <td style="font-size:12px;color:var(--text-secondary)">${m.match_date}<br>${m.match_time}</td>
            <td class="odd-cell" style="color:var(--accent-green)">${m.home_xg}</td>
            <td class="odd-cell" style="color:var(--accent-blue)">${m.away_xg}</td>
            <td style="font-weight:700">${m.prob_home}%</td>
            <td>${m.prob_draw}%</td>
            <td>${m.prob_away}%</td>
            <td>${m.prob_over25}%</td>
            <td>${m.prob_btts}%</td>
            <td>${m.corners_expected}</td>
            <td>${m.cards_expected}</td>
            <td>${weatherIcon} ${m.weather_temp}¬∞C</td>
        </tr>`;
    }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LEAGUES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLeagues() {
    const grid = document.getElementById("league-grid");
    grid.innerHTML = allLeagues.sort((a,b) => b.opportunities - a.opportunities).map(l => {
        const oppColor = l.opportunities > 10 ? "var(--accent-green)" : l.opportunities > 0 ? "var(--accent-yellow)" : "var(--text-muted)";
        return `<div class="league-card">
            <div class="league-card-header">
                <div>
                    <div class="league-card-name">${l.name}</div>
                    <div class="league-card-country">${l.country}</div>
                </div>
                <div style="font-size:28px">üèÜ</div>
            </div>
            <div class="league-card-stats">
                <div class="league-card-stat">
                    <div class="num" style="color:var(--accent-blue)">${l.matches}</div>
                    <div class="lbl">Jogos</div>
                </div>
                <div class="league-card-stat">
                    <div class="num" style="color:${oppColor}">${l.opportunities}</div>
                    <div class="lbl">Oportunidades</div>
                </div>
            </div>
        </div>`;
    }).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SORTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSort = { key: 'edge', dir: 'desc' };

function sortTable(th) {
    const key = th.dataset.sort;
    const type = th.dataset.type;
    
    // Toggle direction
    if (currentSort.key === key) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.key = key;
        currentSort.dir = type === 'num' ? 'desc' : 'asc';
    }
    
    // Update header classes
    document.querySelectorAll('#opp-table th.sortable').forEach(h => {
        h.classList.remove('sort-asc', 'sort-desc');
    });
    th.classList.add(currentSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
    
    applyColumnFilters();
}

function getSortValue(o, key) {
    switch(key) {
        case 'index': return 0;
        case 'team': return (o.home_team + ' ' + o.away_team).toLowerCase();
        case 'league': return (o.league_name || '').toLowerCase();
        case 'date': return o.match_date + ' ' + o.match_time;
        case 'market': return o.market || '';
        case 'selection': return o.selection || '';
        case 'bookmaker': return (o.bookmaker || '').toLowerCase();
        case 'odd': return o.market_odd || 0;
        case 'fair_odd': return o.fair_odd || 0;
        case 'edge': return o.edge || 0;
        case 'kelly': return parseFloat((o.kelly_bet_pct || '0').replace('%', '')) || 0;
        case 'prob': return o.model_prob || 0;
        case 'confidence': return o.confidence === 'ALTO' ? 3 : o.confidence === 'M√âDIO' ? 2 : 1;
        case 'dq': return (o.data_quality || 0) * 100;
        case 'result': return o.result_status === 'GREEN' ? 3 : o.result_status === 'RED' ? 2 : o.result_status === 'VOID' ? 1 : 0;
        case 'game_status': {
            const gs = getGameStatus(o.match_date, o.match_time);
            return gs.status === 'LIVE' ? 3 : gs.status === 'UPCOMING' ? 2 : 1;
        }
        default: return 0;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyColumnFilters() {
    const team = (document.getElementById('cf-team')?.value || '').toLowerCase();
    const league = document.getElementById('cf-league')?.value || '';
    const dtStartRaw = document.getElementById('cf-dt-start')?.value || '';
    const dtEndRaw = document.getElementById('cf-dt-end')?.value || '';
    const dtStart = dtStartRaw ? new Date(dtStartRaw) : null;
    const dtEnd = dtEndRaw ? new Date(dtEndRaw) : null;
    const gameStatusFilter = document.getElementById('cf-game-status')?.value || '';
    const resultFilter = document.getElementById('cf-result')?.value || '';
    const market = document.getElementById('cf-market')?.value || '';
    const selection = (document.getElementById('cf-selection')?.value || '').toLowerCase();
    const oddMin = parseFloat(document.getElementById('cf-odd-min')?.value) || null;
    const oddMax = parseFloat(document.getElementById('cf-odd-max')?.value) || null;
    const edgeMin = parseFloat(document.getElementById('cf-edge-min')?.value) || null;
    const edgeMax = parseFloat(document.getElementById('cf-edge-max')?.value) || null;
    const probMin = parseFloat(document.getElementById('cf-prob-min')?.value) || null;
    const probMax = parseFloat(document.getElementById('cf-prob-max')?.value) || null;
    const confidence = document.getElementById('cf-confidence')?.value || '';

    let filtered = allOpps.filter(o => {
        if (team && !(o.home_team.toLowerCase().includes(team) || o.away_team.toLowerCase().includes(team))) return false;
        if (league && o.league_name !== league) return false;
        // Datetime range filter
        if (dtStart || dtEnd) {
            const timeParts = (o.match_time || '00:00').split(':');
            const dateParts = (o.match_date || '').split('-');
            if (dateParts.length >= 3) {
                const matchDt = new Date(
                    parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]),
                    parseInt(timeParts[0]) || 0, parseInt(timeParts[1]) || 0, 0
                );
                if (dtStart && matchDt < dtStart) return false;
                if (dtEnd && matchDt > dtEnd) return false;
            }
        }
        // Game status filter
        if (gameStatusFilter) {
            const gs = getGameStatus(o.match_date, o.match_time);
            if (gs.status !== gameStatusFilter) return false;
        }
        if (resultFilter && (o.result_status || 'PENDENTE') !== resultFilter) return false;
        if (market && !o.market.includes(market)) return false;
        if (selection && !o.selection.toLowerCase().includes(selection)) return false;
        if (oddMin !== null && o.market_odd < oddMin) return false;
        if (oddMax !== null && o.market_odd > oddMax) return false;
        if (edgeMin !== null && o.edge < edgeMin) return false;
        if (edgeMax !== null && o.edge > edgeMax) return false;
        if (probMin !== null && o.model_prob < probMin) return false;
        if (probMax !== null && o.model_prob > probMax) return false;
        if (confidence && o.confidence !== confidence) return false;
        return true;
    });

    // Sort
    filtered.sort((a, b) => {
        const va = getSortValue(a, currentSort.key);
        const vb = getSortValue(b, currentSort.key);
        let cmp = 0;
        if (typeof va === 'number' && typeof vb === 'number') {
            cmp = va - vb;
        } else {
            cmp = String(va).localeCompare(String(vb));
        }
        return currentSort.dir === 'asc' ? cmp : -cmp;
    });

    // Status
    const statusEl = document.getElementById('filter-status');
    if (statusEl) {
        const total = allOpps.length;
        const shown = filtered.length;
        statusEl.textContent = shown < total ? `Exibindo ${shown} de ${total} oportunidades` : `${total} oportunidades`;
    }

    renderOpportunities(filtered);
}

function clearAllFilters() {
    ['cf-team', 'cf-selection', 'cf-dt-start', 'cf-dt-end',
     'cf-odd-min', 'cf-odd-max', 'cf-edge-min', 'cf-edge-max',
     'cf-prob-min', 'cf-prob-max'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    ['cf-league', 'cf-game-status', 'cf-result', 'cf-market', 'cf-confidence'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    currentSort = { key: 'edge', dir: 'desc' };
    document.querySelectorAll('#opp-table th.sortable').forEach(h => {
        h.classList.remove('sort-asc', 'sort-desc');
    });
    applyColumnFilters();
}

function populateFilters() {
    // Column filters - leagues
    const leagues = [...new Set(allOpps.map(o => o.league_name))].sort();
    const cfLeague = document.getElementById("cf-league");
    if (cfLeague) {
        cfLeague.innerHTML = '<option value="">Todas</option>' +
            leagues.map(l => `<option value="${l}">${l}</option>`).join("");
    }

    // Match filters
    const matchLeagues = [...new Set(allMatches.map(m => m.league_name))].sort();
    const matchLeagueSelect = document.getElementById("filter-match-league");
    if (matchLeagueSelect) {
        matchLeagueSelect.innerHTML = '<option value="all">Todas as Ligas</option>' +
            matchLeagues.map(l => `<option value="${l}">${l}</option>`).join("");
    }

}

function filterOpps() {
    applyColumnFilters();
}

function filterMatches() {
    const league = document.getElementById("filter-match-league").value;
    const dtStartRaw = document.getElementById("filter-match-dt-start")?.value || '';
    const dtEndRaw = document.getElementById("filter-match-dt-end")?.value || '';
    const dtStart = dtStartRaw ? new Date(dtStartRaw) : null;
    const dtEnd = dtEndRaw ? new Date(dtEndRaw) : null;
    const search = document.getElementById("filter-match-search").value.toLowerCase();

    let filtered = allMatches;
    if (league !== "all") filtered = filtered.filter(m => m.league_name === league);
    if (dtStart || dtEnd) {
        filtered = filtered.filter(m => {
            const timeParts = (m.match_time || '00:00').split(':');
            const dateParts = (m.match_date || '').split('-');
            if (dateParts.length < 3) return true;
            const matchDt = new Date(
                parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]),
                parseInt(timeParts[0]) || 0, parseInt(timeParts[1]) || 0, 0
            );
            if (dtStart && matchDt < dtStart) return false;
            if (dtEnd && matchDt > dtEnd) return false;
            return true;
        });
    }
    if (search) filtered = filtered.filter(m =>
        m.home_team.toLowerCase().includes(search) ||
        m.away_team.toLowerCase().includes(search)
    );
    renderMatches(filtered);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showOppDetail(idx) {
    const o = allOpps[idx];
    if (!o) return;
    const m = allMatches.find(x => x.match_id === o.match_id);
    
    document.getElementById("modal-title").textContent = `${o.home_team} vs ${o.away_team}`;
    document.getElementById("modal-subtitle").textContent = `${o.league_name} ‚Äî ${o.league_country} | ${o.match_date} ${o.match_time}`;
    
    const confClass = o.confidence === "ALTO" ? "badge-high" : o.confidence === "M√âDIO" ? "badge-med" : "badge-low";
    const marketClass = getMarketClass(o.market);
    // Helper: valor seguro (trata null/undefined mas mant√©m 0 como v√°lido)
    const v = (val, fallback = 'N/D') => (val !== null && val !== undefined) ? val : fallback;
    const dq = o.data_quality ?? 0;
    const dqPct = (dq * 100).toFixed(0);
    const dqColor = dq >= 0.80 ? 'var(--accent-green)' : dq >= 0.60 ? 'var(--accent-blue)' : dq >= 0.40 ? 'var(--accent-yellow)' : 'var(--accent-red)';
    const dqLabel = dq >= 0.80 ? 'EXCELENTE' : dq >= 0.60 ? 'BOA' : dq >= 0.40 ? 'MODERADA' : 'BAIXA';

    // Helper: stat comparison bar
    function statBar(homeVal, awayVal, label, suffix = '', decimals = 1) {
        const hRaw = homeVal;
        const aRaw = awayVal;
        const hv = parseFloat(hRaw);
        const av = parseFloat(aRaw);
        const hValid = hRaw !== null && hRaw !== undefined && !isNaN(hv);
        const aValid = aRaw !== null && aRaw !== undefined && !isNaN(av);
        // Se ambos s√£o inv√°lidos ou ambos s√£o 0 e vieram de cache sem dados, exibir N/D
        if (!hValid && !aValid) {
            return `<div class="stat-row">
                <div class="stat-row-val home" style="color:var(--text-muted)">N/D</div>
                <div style="text-align:center"><div class="stat-row-label">${label}</div><div class="stat-bar-wrap"></div></div>
                <div class="stat-row-val away" style="color:var(--text-muted)">N/D</div>
            </div>`;
        }
        const h = hValid ? hv : 0;
        const a = aValid ? av : 0;
        const total = h + a || 1;
        const hPct = ((h / total) * 100).toFixed(0);
        const aPct = ((a / total) * 100).toFixed(0);
        const hColor = h > a ? 'var(--accent-green)' : h === a ? 'var(--text-secondary)' : 'var(--text-muted)';
        const aColor = a > h ? 'var(--accent-blue)' : a === h ? 'var(--text-secondary)' : 'var(--text-muted)';
        return `<div class="stat-row">
            <div class="stat-row-val home" style="color:${hColor}">${hValid ? h.toFixed(decimals) : 'N/D'}${hValid ? suffix : ''}</div>
            <div style="text-align:center">
                <div class="stat-row-label">${label}</div>
                <div class="stat-bar-wrap"><div class="stat-bar-home" style="width:${hPct}%"></div><div class="stat-bar-away" style="width:${aPct}%"></div></div>
            </div>
            <div class="stat-row-val away" style="color:${aColor}">${aValid ? a.toFixed(decimals) : 'N/D'}${aValid ? suffix : ''}</div>
        </div>`;
    }

    // Helper: form dots
    function formHtml(form) {
        if (!form || !form.length) return '<span style="color:var(--text-muted)">Sem dados</span>';
        return form.map(f => `<div class="form-dot form-${f}">${f}</div>`).join("");
    }
    function formSummary(form) {
        if (!form || !form.length) return '';
        const w = form.filter(x=>x==='W').length, d = form.filter(x=>x==='D').length, l = form.filter(x=>x==='L').length;
        return `${w}V ${d}E ${l}D`;
    }
    function formLabel(form) {
        if (!form || !form.length) return 'FORMA RECENTE';
        return `FORMA RECENTE (${form.length} jogos)`;
    }

    // Build match opps for this match
    const matchOpps = allOpps.filter(op => op.match_id === o.match_id && op !== o);

    // ‚îÄ‚îÄ BUILD HTML ‚îÄ‚îÄ
    document.getElementById("modal-body").innerHTML = `
        <!-- ‚ïê‚ïê ODDS SUSPECT WARNING ‚ïê‚ïê -->
        ${o.odds_suspect ? `
        <div style="background:linear-gradient(135deg,#2d2000,#1f1700);border:2px solid var(--accent-yellow);border-radius:12px;padding:14px 20px;margin-bottom:14px;display:flex;align-items:flex-start;gap:12px">
            <div style="font-size:22px;flex-shrink:0">‚ö†Ô∏è</div>
            <div>
                <div style="font-size:13px;font-weight:800;color:var(--accent-yellow);margin-bottom:4px">POSS√çVEL INVERS√ÉO CASA / FORA</div>
                <div style="font-size:11px;color:var(--text-secondary);line-height:1.5">
                    As odds sugerem que a API pode ter invertido quem √© mandante e visitante nesta partida.
                    O mandante designado (<strong>${o.home_team}</strong>) tem odds ${m ? m.odds_home.toFixed(2) : '?'} enquanto o visitante (<strong>${o.away_team}</strong>) tem odds ${m ? m.odds_away.toFixed(2) : '?'}.
                    Normalmente o mandante tem odds menores (√© favorecido).
                    <br><strong>Ajuste aplicado:</strong> O modelo usou estat√≠sticas NEUTRAS (m√©dia casa+fora) e removeu a vantagem de mando para evitar distor√ß√µes.
                    <strong>Recomenda√ß√£o:</strong> Confirme manualmente na casa de apostas quem √© o real mandante antes de apostar.
                </div>
            </div>
        </div>
        ` : ''}

        <!-- ‚ïê‚ïê SUGGESTION BANNER ‚ïê‚ïê -->
        <div style="background:linear-gradient(135deg,#0d2818,#0a1f12);border:2px solid ${o.odds_suspect ? 'var(--accent-yellow)' : 'var(--accent-green)'};border-radius:12px;padding:18px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
                <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);margin-bottom:4px">SUGEST√ÉO DE APOSTA${o.odds_suspect ? ' (‚ö†Ô∏è VERIFICAR CASA/FORA)' : ''}</div>
                <div style="font-size:20px;font-weight:800;color:${o.odds_suspect ? 'var(--accent-yellow)' : 'var(--accent-green)'}">${o.selection}</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:2px">${o.market} ‚Äî Odd <strong style="color:var(--accent-yellow)">${o.market_odd.toFixed(2)}</strong> (${o.bookmaker})</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                ${o.odds_suspect ? '<span style="background:rgba(255,165,0,0.15);color:var(--accent-yellow);padding:5px 12px;border-radius:6px;font-size:11px;font-weight:700;border:1px solid rgba(255,165,0,0.3)">‚ö†Ô∏è VERIFICAR</span>' : ''}
                <span class="badge ${confClass}" style="font-size:12px;padding:5px 12px">${o.confidence}</span>
                <span style="background:var(--accent-green-dim);color:var(--accent-green);padding:5px 14px;border-radius:6px;font-weight:800;font-size:16px;font-family:'JetBrains Mono'">${o.edge_pct}</span>
                <span style="background:rgba(255,255,255,0.05);padding:5px 12px;border-radius:6px;font-size:12px;color:${dqColor};font-weight:700;border:1px solid ${dqColor}40">Dados: ${dqPct}%</span>
            </div>
        </div>

        <!-- ‚ïê‚ïê ONDE APOSTAR (topo) ‚ïê‚ïê -->
        <div style="margin-bottom:16px;padding:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm)">
            <div class="detail-label" style="margin-bottom:8px">üè¶ ONDE APOSTAR</div>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px">
                ${bookmakerBadgeHtml(o.bookmaker, o.home_team, o.away_team, o.market, o.selection, false, o.league_country, o.league_name)}
                ${(() => {
                    const info = getBookmakerInfo(o.bookmaker);
                    if (info.footballUrl) {
                        return '<a href="' + info.footballUrl + '" target="_blank" rel="noopener" style="font-size:12px;color:var(--accent-cyan);text-decoration:none" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">Abrir ' + info.name + ' ‚Üí</a>';
                    }
                    return '';
                })()}
            </div>
            ${(() => {
                // Mostrar odds alternativas de outras casas para este mesmo mercado
                if (!m) return '';
                const mkts = m.all_markets || {};
                const oppMkt = o.market.toLowerCase();
                let foundMk = null;
                const mktMapping = {
                    '1x2': '1x2', 'dupla chance': 'double_chance',
                    'gols o/u': 'goals_ou', 'btts': 'btts', 'ambas marcam': 'btts',
                    'escanteios': 'corners_ou', 'cartoes': 'cards_ou', 'cart√µes': 'cards_ou',
                    'gols casa': 'home_goals_ou', 'gols fora': 'away_goals_ou',
                    'clean sheet casa': 'cs_home', 'clean sheet fora': 'cs_away',
                    'vit. s/ sofrer casa': 'wtn_home', 'vit. s/ sofrer fora': 'wtn_away',
                    'par/impar': 'odd_even', '1o tempo': 'ht_result',
                    'finaliz. gol 1x2': 'sot_1x2', 'finaliz. 1x2': 'shots_1x2',
                    'finaliz. gol o/u': 'sot_ou', 'finaliz. totais o/u': 'shots_ou',
                };
                for (const [label, key] of Object.entries(mktMapping)) {
                    if (oppMkt.includes(label)) { foundMk = key; break; }
                }
                if (!foundMk) {
                    for (const k of Object.keys(mkts)) {
                        if (oppMkt.includes(k.replace(/_/g,' '))) { foundMk = k; break; }
                    }
                }
                if (!foundMk || !mkts[foundMk]) return '';
                const bkData = mkts[foundMk]._bookmakers;
                if (!bkData || Object.keys(bkData).length <= 1) return '';
                const probs = (m && m.model_probs) || {};

                const selLower = o.selection.toLowerCase();
                // Extrair linha num√©rica da sele√ß√£o (ex: "Under 2.5 Gols" ‚Üí "2.5")
                const lineMatch = selLower.match(/(\d+\.?\d*)/);
                const lineNum = lineMatch ? lineMatch[1] : null;
                const selMapping = {
                    'vit√≥ria casa': 'home', 'vit√≥ria fora': 'away', 'empate': 'draw',
                    'casa ou empate': 'home/draw', 'fora ou empate': 'draw/away',
                    'sim': 'yes', 'n√£o': 'no',
                };
                let selKey = null;
                for (const [label, key] of Object.entries(selMapping)) {
                    if (selLower.includes(label)) { selKey = key; break; }
                }
                // Para mercados Over/Under: incluir a linha no selKey (ex: "over_2.5", "under_2.5")
                if (!selKey && (selLower.includes('over') || selLower.includes('under'))) {
                    const ouDir = selLower.includes('over') ? 'over' : 'under';
                    selKey = lineNum ? `${ouDir}_${lineNum}` : ouDir;
                }
                if (!selKey) {
                    selKey = selLower.replace(/ /g, '_');
                }

                let altHtml = '<div style="margin-top:10px;padding:10px 14px;background:rgba(46,213,115,0.04);border:1px solid rgba(46,213,115,0.15);border-radius:8px">';
                altHtml += '<div style="font-size:11px;font-weight:700;color:var(--accent-green);margin-bottom:8px">üìä Mesma aposta em outras casas:</div>';
                altHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px">';
                let hasAlts = false;

                const entries = [];
                for (const [bkn, vals] of Object.entries(bkData)) {
                    let val = vals[selKey];
                    if (val == null || val === 0) {
                        // Busca exata primeiro: se selKey = "under_2.5", buscar exatamente essa chave
                        // Fallback parcial somente se n√£o houver linha num√©rica
                        for (const [k2, v2] of Object.entries(vals)) {
                            if (typeof v2 === 'number' && v2 > 1.0 && k2 === selKey) { val = v2; break; }
                        }
                        // Se ainda n√£o encontrou e N√ÉO tem linha num√©rica, tentar parcial
                        if ((val == null || val === 0) && !lineNum) {
                            for (const [k2, v2] of Object.entries(vals)) {
                                if (typeof v2 === 'number' && v2 > 1.0 && k2.includes(selKey)) { val = v2; break; }
                                if (typeof v2 === 'number' && v2 > 1.0 && selKey.includes(k2)) { val = v2; break; }
                            }
                        }
                    }
                    if (typeof val === 'number' && val > 1.0) {
                        entries.push([bkn, val]);
                    }
                }
                entries.sort((a, b) => b[1] - a[1]);
                const bestVal = entries.length > 0 ? entries[0][1] : 0;

                for (const [bkn, val] of entries) {
                    if (bkn === o.bookmaker) continue;
                    hasAlts = true;
                    const info2 = getBookmakerInfo(bkn);
                    const link2 = info2.footballUrl;
                    const isBest = val === bestVal;
                    const borderColor = isBest ? 'var(--accent-green)' : 'var(--border)';
                    const mp = probs[`${foundMk}__${selKey}`];
                    const isEV3 = mp && (mp * val - 1) > 0.03;
                    altHtml += `<div style="padding:6px 12px;background:var(--bg-primary);border:1px solid ${borderColor};border-radius:8px;text-align:center;min-width:90px">`;
                    if (link2) {
                        altHtml += `<a href="${link2}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="font-size:11px;font-weight:700;color:${info2.color || 'var(--accent-cyan)'};text-decoration:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${info2.name}</a>`;
                    } else {
                        altHtml += `<div style="font-size:11px;font-weight:700;color:var(--text-secondary)">${bkn}</div>`;
                    }
                    altHtml += `<div style="font-size:16px;font-weight:800;color:${isBest ? 'var(--accent-green)' : 'var(--text-primary)'};font-family:'JetBrains Mono',monospace;margin-top:2px">${val.toFixed(2)}${isBest ? ' ‚òÖ' : ''}</div>`;
                    if (isEV3) altHtml += `<div style="font-size:9px;color:var(--accent-green);font-weight:700">EV+</div>`;
                    altHtml += '</div>';
                }
                altHtml += '</div></div>';
                return hasAlts ? altHtml : '';
            })()}
            <div style="padding:10px 14px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;font-size:12px;margin-top:10px">
                <div style="color:var(--accent-cyan);font-weight:700;margin-bottom:4px">Como encontrar:</div>
                <div style="color:var(--text-secondary);line-height:1.6">
                    Futebol ‚Üí <strong style="color:var(--accent-yellow)">${o.league_country || '?'}</strong> ‚Üí <strong style="color:var(--accent-yellow)">${o.league_name || '?'}</strong> ‚Üí <strong style="color:var(--text-primary)">${o.home_team} vs ${o.away_team}</strong> ‚Üí <strong style="color:var(--accent-green)">${o.market}: ${o.selection}</strong>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê TABS ‚ïê‚ïê -->
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchModalTab(this, 'tab-teams')">‚öîÔ∏è Comparativo</button>
            <button class="modal-tab" onclick="switchModalTab(this, 'tab-stats')">üìä Estat√≠sticas</button>
            <button class="modal-tab" onclick="switchModalTab(this, 'tab-odds')">üí∞ Odds & Valor</button>
            <button class="modal-tab" onclick="switchModalTab(this, 'tab-context')">üåç Contexto</button>
            <button class="modal-tab" onclick="switchModalTab(this, 'tab-analysis')">üß† An√°lise T√©cnica</button>
        </div>

        <!-- ‚ïê‚ïê TAB 1: COMPARATIVO ‚ïê‚ïê -->
        <div id="tab-teams" class="modal-tab-content active">
            <div class="team-compare">
                <div class="team-col team-col-home">
                    <div class="team-name-lg" style="color:var(--accent-green)">${o.home_team}</div>
                    <div class="team-badge-info">${m ? (v(m.home_league_pos,'') ? m.home_league_pos + '¬∞ lugar' : '') + (v(m.home_league_pts,'') !== '' ? ' ‚Ä¢ ' + m.home_league_pts + ' pts' : '') + (v(m.home_games_played,'') !== '' ? ' ‚Ä¢ ' + m.home_games_played + ' jogos' : '') : 'N/D'}</div>
                    <div style="margin-bottom:6px"><span style="font-size:10px;color:var(--text-muted)">${m ? formLabel(m.home_form) : 'FORMA RECENTE'}</span></div>
                    <div class="form-dots" style="justify-content:flex-end">${m ? formHtml(m.home_form) : 'N/D'}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">${m ? formSummary(m.home_form) : ''}</div>
                </div>
                <div class="team-col-vs">VS</div>
                <div class="team-col team-col-away">
                    <div class="team-name-lg" style="color:var(--accent-blue)">${o.away_team}</div>
                    <div class="team-badge-info">${m ? (v(m.away_league_pos,'') ? m.away_league_pos + '¬∞ lugar' : '') + (v(m.away_league_pts,'') !== '' ? ' ‚Ä¢ ' + m.away_league_pts + ' pts' : '') + (v(m.away_games_played,'') !== '' ? ' ‚Ä¢ ' + m.away_games_played + ' jogos' : '') : 'N/D'}</div>
                    <div style="margin-bottom:6px"><span style="font-size:10px;color:var(--text-muted)">${m ? formLabel(m.away_form) : 'FORMA RECENTE'}</span></div>
                    <div class="form-dots">${m ? formHtml(m.away_form) : 'N/D'}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px">${m ? formSummary(m.away_form) : ''}</div>
                </div>
            </div>

            ${m ? `
            <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:16px 20px">
                ${statBar(m.home_attack, m.away_attack, 'Ataque (Œ±)', '', 2)}
                ${statBar(m.home_defense, m.away_defense, 'Defesa (Œ≤)', '', 2)}
                ${statBar(m.home_goals_scored_avg, m.away_goals_scored_avg, 'Gols Marcados/Jogo', '')}
                ${statBar(m.home_goals_conceded_avg, m.away_goals_conceded_avg, 'Gols Sofridos/Jogo', '')}
                ${statBar(m.home_xg, m.away_xg, 'xG Esperado (Modelo)', '')}
                ${statBar(m.home_shots_total_avg ?? null, m.away_shots_total_avg ?? null, 'Finaliza√ß√µes Totais/Jogo', '')}
                ${statBar(m.home_shots_on_target_avg, m.away_shots_on_target_avg, 'Finaliza√ß√µes no Gol/Jogo', '')}
                ${statBar(m.home_corners_avg, m.away_corners_avg, 'Escanteios/Jogo', '')}
                ${statBar(m.home_cards_avg, m.away_cards_avg, 'Cart√µes/Jogo', '')}
                ${statBar(m.home_fouls_avg, m.away_fouls_avg, 'Faltas/Jogo', '')}
                ${statBar(m.home_possession, m.away_possession, 'Posse Ter√ßo Final', '')}
                ${statBar(m.home_form_points, m.away_form_points, 'Pontos de Forma', '', 2)}
            </div>
            ` : '<div style="color:var(--text-muted);padding:16px;text-align:center">Dados da partida n√£o dispon√≠veis no cache</div>'}

            ${m && (m.injuries_home?.length > 0 || m.injuries_away?.length > 0) ? `
            <div class="m-section">üè• Les√µes & Desfalques</div>
            <div class="ctx-grid">
                <div class="ctx-card">
                    <div class="ctx-card-title">${o.home_team}</div>
                    <div class="ctx-card-body">${m.injuries_home?.length > 0 ? m.injuries_home.map(i => '<div style="color:var(--accent-red);margin-bottom:3px">‚Ä¢ ' + i + '</div>').join('') : '<span style="color:var(--accent-green)">Sem desfalques reportados</span>'}</div>
                </div>
                <div class="ctx-card">
                    <div class="ctx-card-title">${o.away_team}</div>
                    <div class="ctx-card-body">${m.injuries_away?.length > 0 ? m.injuries_away.map(i => '<div style="color:var(--accent-red);margin-bottom:3px">‚Ä¢ ' + i + '</div>').join('') : '<span style="color:var(--accent-green)">Sem desfalques reportados</span>'}</div>
                </div>
            </div>
            ` : ''}

            <!-- ‚ïê‚ïê HIST√ìRICO DE JOGOS (carregado sob demanda) ‚ïê‚ïê -->
            ${m ? `
            <div class="m-section" style="margin-top:20px">üìã Historico de Jogos Recentes</div>
            <div id="history-container" style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:12px;padding:16px 20px">
                <div style="display:flex;gap:8px;margin-bottom:16px">
                    <button id="btn-load-history" onclick="loadTeamHistory(${m.home_team_id ?? 0}, ${m.away_team_id ?? 0}, ${m.league_id ?? 0}, '${(o.home_team||'').replace(/'/g,"\\'")}', '${(o.away_team||'').replace(/'/g,"\\'")}', '${(o.league_name||'').replace(/'/g,"\\'")}' )" style="flex:1;padding:10px 16px;background:var(--accent-green-dim);color:var(--accent-green);border:1px solid var(--accent-green)40;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px">
                        Carregar Historico Detalhado + Confronto Direto
                    </button>
                </div>
                <div id="history-content" style="color:var(--text-muted);font-size:12px;text-align:center">
                    Clique acima para carregar historico e confronto direto (usa cache)
                </div>
            </div>
            ` : ''}
        </div>

        <!-- ‚ïê‚ïê TAB 2: ESTAT√çSTICAS DETALHADAS ‚ïê‚ïê -->
        <div id="tab-stats" class="modal-tab-content">
            ${m ? `
            <div class="m-section">üìà Estat√≠sticas Detalhadas por Time</div>
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse;min-width:auto">
                    <thead>
                        <tr>
                            <th style="text-align:left;padding:8px 12px;font-size:11px;background:var(--bg-secondary);border-bottom:1px solid var(--border);color:var(--text-muted)">M√âTRICA</th>
                            <th style="text-align:center;padding:8px 12px;font-size:11px;background:var(--bg-secondary);border-bottom:1px solid var(--border);color:var(--accent-green)">${o.home_team}</th>
                            <th style="text-align:center;padding:8px 12px;font-size:11px;background:var(--bg-secondary);border-bottom:1px solid var(--border);color:var(--accent-blue)">${o.away_team}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${buildStatsTableRows(m)}
                    </tbody>
                </table>
            </div>

            <div class="m-section" style="margin-top:24px">üìä Probabilidades do Modelo</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
                <div style="text-align:center;padding:16px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Vit√≥ria Casa</div>
                    <div style="font-size:24px;font-weight:800;color:var(--accent-green);font-family:'JetBrains Mono'">${m.prob_home}%</div>
                </div>
                <div style="text-align:center;padding:16px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Empate</div>
                    <div style="font-size:24px;font-weight:800;color:var(--text-secondary);font-family:'JetBrains Mono'">${m.prob_draw}%</div>
                </div>
                <div style="text-align:center;padding:16px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Vit√≥ria Fora</div>
                    <div style="font-size:24px;font-weight:800;color:var(--accent-blue);font-family:'JetBrains Mono'">${m.prob_away}%</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:9px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px">Over 2.5</div>
                    <div style="font-size:18px;font-weight:800;color:var(--accent-purple);font-family:'JetBrains Mono'">${m.prob_over25}%</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:9px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px">BTTS</div>
                    <div style="font-size:18px;font-weight:800;color:var(--accent-cyan);font-family:'JetBrains Mono'">${m.prob_btts}%</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:9px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px">Escanteios Exp.</div>
                    <div style="font-size:18px;font-weight:800;color:var(--accent-yellow);font-family:'JetBrains Mono'">${m.corners_expected}</div>
                </div>
                <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border)">
                    <div style="font-size:9px;text-transform:uppercase;color:var(--text-muted);margin-bottom:4px">Cart√µes Exp.</div>
                    <div style="font-size:18px;font-weight:800;color:var(--accent-red);font-family:'JetBrains Mono'">${m.cards_expected}</div>
                </div>
            </div>
            ` : '<div style="color:var(--text-muted);padding:16px;text-align:center">Dados n√£o dispon√≠veis</div>'}
        </div>

        <!-- ‚ïê‚ïê TAB 3: ODDS & VALOR ‚ïê‚ïê -->
        <div id="tab-odds" class="modal-tab-content">
            <div class="m-section">üí∞ An√°lise de Valor</div>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Odd de Mercado</div>
                    <div class="detail-value" style="font-family:'JetBrains Mono';font-size:22px;color:var(--accent-yellow)">${o.market_odd.toFixed(2)}</div>
                    <div style="font-size:11px;color:var(--text-muted)">${o.bookmaker}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Odd Justa (Modelo)</div>
                    <div class="detail-value" style="font-family:'JetBrains Mono';font-size:22px;color:var(--accent-green)">${o.fair_odd.toFixed(2)}</div>
                    <div style="font-size:11px;color:var(--text-muted)">Dixon-Coles + Monte Carlo</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Prob. do Modelo</div>
                    <div class="detail-value" style="font-size:22px">${o.model_prob}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Prob. Impl√≠cita (De-Vig)</div>
                    <div class="detail-value" style="font-size:22px;color:var(--text-secondary)">${o.implied_prob}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Edge</div>
                    <div class="detail-value" style="font-family:'JetBrains Mono';font-size:22px;color:var(--accent-green)">${o.edge_pct}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kelly Sugerido</div>
                    <div class="detail-value" style="font-size:22px">${o.kelly_bet_pct}</div>
                </div>
            </div>

            ${m ? `
            <div class="m-section">üìã Todas as Odds & Probabilidades do Modelo (Principal: ${m.bookmaker})</div>
            ${buildAllMarketsOdds(m)}
            ` : ''}

            ${matchOpps.length > 0 ? `
            <div class="m-section" style="margin-top:20px">üéØ Outras Oportunidades neste Jogo</div>
            ${matchOpps.map(op => {
                const opConf = op.confidence === 'ALTO' ? 'badge-high' : op.confidence === 'M√âDIO' ? 'badge-med' : 'badge-low';
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px"><div style="display:flex;align-items:center;gap:8px"><span class="badge ' + opConf + '">' + op.confidence + '</span><span style="font-size:13px">' + op.market + ': <strong>' + op.selection + '</strong></span><span style="font-family:\'JetBrains Mono\';font-size:12px;color:var(--text-secondary)">@' + op.market_odd.toFixed(2) + '</span></div><span style="font-weight:800;color:var(--accent-green);font-family:\'JetBrains Mono\'">' + op.edge_pct + '</span></div>';
            }).join('')}
            ` : ''}
        </div>

        <!-- ‚ïê‚ïê TAB 4: CONTEXTO ‚ïê‚ïê -->
        <div id="tab-context" class="modal-tab-content">
            <div class="m-section">üèüÔ∏è Informa√ß√µes do Jogo</div>
            <div class="ctx-grid">
                <div class="ctx-card">
                    <div class="ctx-card-title">üìç Est√°dio</div>
                    <div class="ctx-card-body">${m?.venue || 'N/D'}</div>
                </div>
                <div class="ctx-card">
                    <div class="ctx-card-title">üë®‚Äç‚öñÔ∏è √Årbitro</div>
                    <div class="ctx-card-body">
                        ${m && m.referee && m.referee !== 'Desconhecido' ? m.referee : '<span style="color:var(--text-muted)">N√£o identificado</span>'}
                        ${m && m.referee_cards_avg != null ? '<br><span style="font-size:11px;color:var(--text-muted)">' + m.referee_cards_avg + ' cart√µes/jogo ‚Ä¢ ' + (m.referee_fouls_avg ?? '?') + ' faltas/jogo</span>' : ''}
                    </div>
                </div>
                <div class="ctx-card">
                    <div class="ctx-card-title">üå§Ô∏è Clima</div>
                    <div class="ctx-card-body">
                        ${m ? m.weather_desc + '<br>' + m.weather_temp + '¬∞C ‚Ä¢ Vento: ' + (m.weather_wind ? m.weather_wind.toFixed(0) : '?') + ' km/h' + (m.weather_rain > 0 ? ' ‚Ä¢ Chuva: ' + m.weather_rain + 'mm' : '') : o.weather_note}
                    </div>
                </div>
                <div class="ctx-card">
                    <div class="ctx-card-title">‚ö° Fadiga</div>
                    <div class="ctx-card-body">
                        ${m ? (m.home_fatigue ? '<span style="color:var(--accent-yellow)">' + o.home_team + ' ‚Äî jogou nas √∫ltimas 72h</span><br>' : '') + (m.away_fatigue ? '<span style="color:var(--accent-yellow)">' + o.away_team + ' ‚Äî jogou nas √∫ltimas 72h</span>' : '') + (!m.home_fatigue && !m.away_fatigue ? '<span style="color:var(--accent-green)">Nenhum time com fadiga</span>' : '') : 'N/D'}
                    </div>
                </div>
            </div>

            ${m ? `
            <div class="m-section">üèÜ Contexto Competitivo</div>
            <div class="ctx-grid">
                <div class="ctx-card">
                    <div class="ctx-card-title" style="color:var(--accent-green)">${o.home_team}</div>
                    <div class="ctx-card-body">
                        <div style="margin-bottom:6px"><strong>${v(m.home_league_pos, '?')}¬∞ lugar</strong> ‚Äî ${v(m.home_league_pts, '?')} pts</div>
                        <div style="margin-bottom:4px">Jogos: ${v(m.home_games_played, '?')} disputados, ${v(m.home_games_remaining, '?')} restantes</div>
                        <div style="margin-bottom:4px">Dist√¢ncia p/ t√≠tulo: <strong style="color:${(v(m.home_points_to_title, 99) <= 10) ? 'var(--accent-green)' : 'var(--text-secondary)'}">${v(m.home_points_to_title, 99) !== 99 ? m.home_points_to_title + ' pts' : 'N/D'}</strong></div>
                        <div>Dist√¢ncia p/ rebaixamento: <strong style="color:${(v(m.home_points_to_relegation, 99) <= 5) ? 'var(--accent-red)' : 'var(--text-secondary)'}">${v(m.home_points_to_relegation, 99) !== 99 ? m.home_points_to_relegation + ' pts' : 'N/D'}</strong></div>
                        <div style="margin-top:6px">Urg√™ncia: <strong>${v(m.urgency_home, 0).toFixed ? m.urgency_home.toFixed(1) : v(m.urgency_home, '?')}</strong>/1.0</div>
                    </div>
                </div>
                <div class="ctx-card">
                    <div class="ctx-card-title" style="color:var(--accent-blue)">${o.away_team}</div>
                    <div class="ctx-card-body">
                        <div style="margin-bottom:6px"><strong>${v(m.away_league_pos, '?')}¬∞ lugar</strong> ‚Äî ${v(m.away_league_pts, '?')} pts</div>
                        <div style="margin-bottom:4px">Jogos: ${v(m.away_games_played, '?')} disputados, ${v(m.away_games_remaining, '?')} restantes</div>
                        <div style="margin-bottom:4px">Dist√¢ncia p/ t√≠tulo: <strong style="color:${(v(m.away_points_to_title, 99) <= 10) ? 'var(--accent-green)' : 'var(--text-secondary)'}">${v(m.away_points_to_title, 99) !== 99 ? m.away_points_to_title + ' pts' : 'N/D'}</strong></div>
                        <div>Dist√¢ncia p/ rebaixamento: <strong style="color:${(v(m.away_points_to_relegation, 99) <= 5) ? 'var(--accent-red)' : 'var(--text-secondary)'}">${v(m.away_points_to_relegation, 99) !== 99 ? m.away_points_to_relegation + ' pts' : 'N/D'}</strong></div>
                        <div style="margin-top:6px">Urg√™ncia: <strong>${v(m.urgency_away, 0).toFixed ? m.urgency_away.toFixed(1) : v(m.urgency_away, '?')}</strong>/1.0</div>
                    </div>
                </div>
            </div>
            ` : ''}

            <div class="m-section">üìä Qualidade dos Dados</div>
            <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:16px">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="font-size:28px;font-weight:800;color:${dqColor};font-family:'JetBrains Mono'">${dqPct}%</div>
                    <div>
                        <div style="font-size:13px;font-weight:700;color:${dqColor}">${dqLabel}</div>
                        <div style="font-size:11px;color:var(--text-muted)">√çndice de confian√ßa dos dados</div>
                    </div>
                </div>
                ${m ? `
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.8">
                    ${m.has_real_odds ? '‚úÖ' : '‚ùå'} Odds Reais ${m.has_real_odds ? '(' + m.bookmaker + ')' : '‚Äî Estimadas'}<br>
                    ${m.has_real_standings ? '‚úÖ' : '‚ùå'} Standings Reais<br>
                    ${m.home_has_real_data ? '‚úÖ' : '‚ö†Ô∏è'} ${o.home_team}: ${m.home_has_real_data ? 'Dados reais da API' : 'Estimado'}<br>
                    ${m.away_has_real_data ? '‚úÖ' : '‚ö†Ô∏è'} ${o.away_team}: ${m.away_has_real_data ? 'Dados reais da API' : 'Estimado'}<br>
                    ${m.has_real_weather ? '‚úÖ' : '‚ùå'} Clima Real<br>
                    ${m.referee && m.referee !== 'Desconhecido' ? '‚úÖ' : '‚ùå'} √Årbitro Identificado
                </div>
                ` : ''}
            </div>
        </div>

        <!-- ‚ïê‚ïê TAB 5: AN√ÅLISE T√âCNICA ‚ïê‚ïê -->
        <div id="tab-analysis" class="modal-tab-content">
            ${buildExecutiveSummary(o)}
            <div style="padding:16px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;overflow-x:auto;margin-top:12px">
                <pre style="font-family:'JetBrains Mono','Fira Code',monospace;font-size:11.5px;line-height:1.7;color:var(--text-secondary);white-space:pre-wrap;word-break:break-word;margin:0">${buildDetailedAnalysis(o)}</pre>
            </div>
        </div>
    `;
    document.getElementById("modal-overlay").classList.add("show");
}

// ‚îÄ‚îÄ MODAL TAB SWITCH ‚îÄ‚îÄ
function switchModalTab(btn, tabId) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.modal-tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// ‚îÄ‚îÄ BUILD STATS TABLE ROWS ‚îÄ‚îÄ
function buildStatsTableRows(m) {
    const rows = [
        ['Posi√ß√£o na Liga', m.home_league_pos ? m.home_league_pos + '¬∞' : 'N/D', m.away_league_pos ? m.away_league_pos + '¬∞' : 'N/D'],
        ['Pontos', m.home_league_pts ?? 'N/D', m.away_league_pts ?? 'N/D'],
        ['Jogos Disputados', m.home_games_played ?? 'N/D', m.away_games_played ?? 'N/D'],
        ['Jogos Restantes', m.home_games_remaining ?? 'N/D', m.away_games_remaining ?? 'N/D'],
        ['For√ßa de Ataque (Œ±)', m.home_attack ?? 'N/D', m.away_attack ?? 'N/D'],
        ['For√ßa de Defesa (Œ≤)', m.home_defense ?? 'N/D', m.away_defense ?? 'N/D'],
        ['xG Esperado', m.home_xg ?? 'N/D', m.away_xg ?? 'N/D'],
        ['Gols Marcados/Jogo', m.home_goals_scored_avg ?? 'N/D', m.away_goals_scored_avg ?? 'N/D'],
        ['Gols Sofridos/Jogo', m.home_goals_conceded_avg ?? 'N/D', m.away_goals_conceded_avg ?? 'N/D'],
        ['Finaliza√ß√µes Totais/Jogo', m.home_shots_total_avg ?? 'N/D', m.away_shots_total_avg ?? 'N/D'],
        ['Finaliza√ß√µes no Gol/Jogo', m.home_shots_on_target_avg ?? 'N/D', m.away_shots_on_target_avg ?? 'N/D'],
        ['Finaliza√ß√µes Bloqueadas/Jogo', m.home_shots_blocked_avg ?? 'N/D', m.away_shots_blocked_avg ?? 'N/D'],
        ['Escanteios/Jogo', m.home_corners_avg ?? 'N/D', m.away_corners_avg ?? 'N/D'],
        ['Cart√µes/Jogo', m.home_cards_avg ?? 'N/D', m.away_cards_avg ?? 'N/D'],
        ['Faltas/Jogo', m.home_fouls_avg ?? 'N/D', m.away_fouls_avg ?? 'N/D'],
        ['Posse Ter√ßo Final', m.home_possession ?? 'N/D', m.away_possession ?? 'N/D'],
        ['Pontos de Forma', m.home_form_points ?? 'N/D', m.away_form_points ?? 'N/D'],
        ['Urg√™ncia', m.urgency_home?.toFixed(1) ?? 'N/D', m.urgency_away?.toFixed(1) ?? 'N/D'],
        ['Fadiga (72h)', m.home_fatigue ? 'SIM' : 'N√ÉO', m.away_fatigue ? 'SIM' : 'N√ÉO'],
    ];
    
    return rows.map((r, i) => {
        const bg = i % 2 === 0 ? 'transparent' : 'rgba(255,255,255,0.02)';
        const hVal = parseFloat(r[1]);
        const aVal = parseFloat(r[2]);
        const hBold = !isNaN(hVal) && !isNaN(aVal) && hVal > aVal;
        const aBold = !isNaN(hVal) && !isNaN(aVal) && aVal > hVal;
        // Invert for "Gols Sofridos" and "Fadiga" (lower is better)
        const invertMetrics = ['Gols Sofridos/Jogo', 'Fadiga (72h)'];
        const inv = invertMetrics.includes(r[0]);
        const hStyle = (inv ? aBold : hBold) ? 'color:var(--accent-green);font-weight:800' : '';
        const aStyle = (inv ? hBold : aBold) ? 'color:var(--accent-blue);font-weight:800' : '';
        return '<tr style="background:' + bg + '"><td style="padding:7px 12px;font-size:12px;color:var(--text-muted);border-bottom:1px solid rgba(255,255,255,0.04)">' + r[0] + '</td><td style="text-align:center;padding:7px 12px;font-family:\'JetBrains Mono\';font-size:13px;border-bottom:1px solid rgba(255,255,255,0.04);' + hStyle + '">' + r[1] + '</td><td style="text-align:center;padding:7px 12px;font-family:\'JetBrains Mono\';font-size:13px;border-bottom:1px solid rgba(255,255,255,0.04);' + aStyle + '">' + r[2] + '</td></tr>';
    }).join('');
}

// ‚îÄ‚îÄ RESUMO EXECUTIVO ‚Äî Por que o modelo v√™ valor? ‚îÄ‚îÄ
function buildExecutiveSummary(o) {
    const m = allMatches.find(x => x.match_id === o.match_id);
    if (!m) return '';

    const modelP = o.model_prob / 100;
    const impliedP = o.implied_prob / 100;
    const edge = parseFloat(o.edge_pct) || 0;
    const xgTotal = (o.home_xg + o.away_xg);
    const fairOdd = o.fair_odd;
    const marketOdd = o.market_odd;
    const hGP = m.home_games_played ?? 0;
    const aGP = m.away_games_played ?? 0;
    const minGP = Math.min(hGP, aGP);
    const alphaH = m.model_alpha_h ?? m.home_attack ?? 1.0;
    const betaH = m.model_beta_h ?? m.home_defense ?? 1.0;
    const alphaA = m.model_alpha_a ?? m.away_attack ?? 1.0;
    const betaA = m.model_beta_a ?? m.away_defense ?? 1.0;
    const leagueAvg = m.league_avg_goals ?? 2.7;

    // ‚îÄ‚îÄ Identificar os DRIVERS (fatores-chave) da an√°lise ‚îÄ‚îÄ
    const drivers = [];
    const warnings = [];

    // 1. Amostra pequena
    if (minGP < 10) {
        warnings.push({
            icon: '‚ö†Ô∏è',
            title: 'Amostra pequena',
            desc: `Apenas ${hGP} jogos (casa) e ${aGP} jogos (fora) disputados. A regress√£o √† m√©dia (peso ${Math.min(100, Math.round(minGP/15*100))}% dados obs.) suaviza, mas campeonatos em fase inicial s√£o naturalmente imprevis√≠veis.`,
            severity: 'high'
        });
    }

    // 2. Analisar por tipo de mercado
    const sel = o.selection.toLowerCase();
    const mkt = o.market.toLowerCase();

    if (mkt.includes('o/u') || mkt.includes('gols')) {
        // Mercado de gols
        if (sel.includes('under')) {
            drivers.push({
                icon: 'üõ°Ô∏è',
                title: 'Defesas s√≥lidas',
                desc: `Œ≤ Casa = ${betaH.toFixed(2)} e Œ≤ Fora = ${betaA.toFixed(2)} (m√©dia da liga = 1.00). Ambas as defesas est√£o ${Math.min(betaH, betaA) < 0.85 ? 'MUITO acima' : 'acima'} da m√©dia, dificultando gols.`
            });
            if (xgTotal < 2.0) {
                drivers.push({
                    icon: 'üìâ',
                    title: 'xG Total muito baixo',
                    desc: `O modelo espera apenas ${xgTotal.toFixed(2)} gols na partida (m√©dia da liga: ${leagueAvg.toFixed(2)}). Com poucos gols esperados, a probabilidade de Under √© naturalmente alta.`
                });
            }
        } else if (sel.includes('over')) {
            if (xgTotal > leagueAvg) {
                drivers.push({
                    icon: '‚ö°',
                    title: 'Ataques acima da m√©dia',
                    desc: `Œ± Casa = ${alphaH.toFixed(2)} e Œ± Fora = ${alphaA.toFixed(2)}. O xG Total de ${xgTotal.toFixed(2)} gols supera a m√©dia da liga (${leagueAvg.toFixed(2)}).`
                });
            }
            if (Math.max(betaH, betaA) > 1.15) {
                drivers.push({
                    icon: 'üîì',
                    title: 'Defesa(s) vulner√°vel(is)',
                    desc: `${betaH > 1.15 ? o.home_team + ' (Œ≤=' + betaH.toFixed(2) + ') ' : ''}${betaA > 1.15 ? o.away_team + ' (Œ≤=' + betaA.toFixed(2) + ')' : ''} ‚Äî acima de 1.00 significa que sofre(m) mais gols que a m√©dia.`
                });
            }
        }
    } else if (mkt.includes('1x2') || mkt.includes('dupla chance')) {
        // Mercado 1x2
        if (sel.includes('casa')) {
            drivers.push({
                icon: 'üèüÔ∏è',
                title: 'Vantagem de mando + ataque forte',
                desc: `Œ± Casa = ${alphaH.toFixed(2)} com fator de mando 1.08. Contra defesa de Œ≤ = ${betaA.toFixed(2)}, o modelo projeta ${o.home_xg.toFixed(2)} gols do mandante.`
            });
        } else if (sel.includes('fora')) {
            drivers.push({
                icon: '‚úàÔ∏è',
                title: 'Visitante com ataque superior',
                desc: `Œ± Fora = ${alphaA.toFixed(2)} contra defesa de Œ≤ = ${betaH.toFixed(2)}. Mesmo sem vantagem de mando, o modelo projeta ${o.away_xg.toFixed(2)} gols do visitante.`
            });
        }
    } else if (mkt.includes('btts') || mkt.includes('ambas')) {
        if (sel.includes('sim') || sel.includes('yes')) {
            drivers.push({
                icon: '‚öΩ',
                title: 'Ambos times com ataque ativo',
                desc: `Œ± Casa = ${alphaH.toFixed(2)}, Œ± Fora = ${alphaA.toFixed(2)}. Com xG Casa = ${o.home_xg.toFixed(2)} e xG Fora = ${o.away_xg.toFixed(2)}, ambos t√™m chances reais de marcar.`
            });
        } else {
            drivers.push({
                icon: 'üõ°Ô∏è',
                title: 'Pelo menos uma defesa forte',
                desc: `${Math.min(betaH, betaA) < 0.85 ? 'Defesa muito s√≥lida presente' : 'Uma defesa dificulta o ataque advers√°rio'}. xG mais baixo = ${Math.min(o.home_xg, o.away_xg).toFixed(2)}.`
            });
        }
    }

    // Drivers gen√©ricos
    // Forma recente
    const hForm = m.home_form || [];
    const aForm = m.away_form || [];
    const hFormW = hForm.filter(x => x === 'W').length;
    const hFormL = hForm.filter(x => x === 'L').length;
    const aFormW = aForm.filter(x => x === 'W').length;
    const aFormL = aForm.filter(x => x === 'L').length;
    if (hForm.length >= 3 || aForm.length >= 3) {
        let formNote = '';
        if (hFormL === 0 && hForm.length >= 3) formNote += `${o.home_team} invicto nos √∫ltimos ${hForm.length} jogos. `;
        if (aFormL === 0 && aForm.length >= 3) formNote += `${o.away_team} invicto nos √∫ltimos ${aForm.length} jogos. `;
        if (hFormW === 0 && hForm.length >= 3) formNote += `${o.home_team} sem vit√≥rias nos √∫ltimos ${hForm.length} jogos. `;
        if (aFormW === 0 && aForm.length >= 3) formNote += `${o.away_team} sem vit√≥rias nos √∫ltimos ${aForm.length} jogos. `;
        if (formNote) {
            drivers.push({ icon: 'üìä', title: 'Forma recente', desc: formNote.trim() });
        }
    }

    // Discrep√¢ncia modelo vs mercado
    const gapPct = ((modelP - impliedP) * 100).toFixed(1);
    drivers.push({
        icon: 'üí∞',
        title: 'Discrep√¢ncia modelo vs mercado',
        desc: `O modelo atribui ${o.model_prob}% ao evento, mas o mercado precifica apenas ${o.implied_prob}% (diferen√ßa de ${gapPct} p.p.). Isso gera a odd justa de ${fairOdd.toFixed(2)} vs a odd real de ${marketOdd.toFixed(2)}.`
    });

    // Urg√™ncia
    if (o.urgency_home >= 0.9 || o.urgency_away >= 0.9) {
        const urgTeams = [];
        if (o.urgency_home >= 0.9) urgTeams.push(o.home_team);
        if (o.urgency_away >= 0.9) urgTeams.push(o.away_team);
        drivers.push({
            icon: 'üî•',
            title: 'Alta urg√™ncia competitiva',
            desc: `${urgTeams.join(' e ')} em disputa por t√≠tulo ou contra rebaixamento ‚Äî fator motivacional elevado.`
        });
    }

    // Odds suspect
    if (o.odds_suspect || m.odds_home_away_suspect) {
        warnings.push({
            icon: 'üîÑ',
            title: 'Poss√≠vel invers√£o Casa/Fora',
            desc: 'As odds sugerem que o mandante designado pela API pode estar incorreto. O modelo usou estat√≠sticas neutras para compensar.',
            severity: 'medium'
        });
    }

    // ‚îÄ‚îÄ Classificar edge ‚îÄ‚îÄ
    let edgeClass = 'normal';
    let edgeLabel = 'Edge moderado';
    let edgeColor = 'var(--accent-green)';
    if (edge >= 30) { edgeClass = 'extreme'; edgeLabel = 'Edge EXTREMO'; edgeColor = '#ff4444'; }
    else if (edge >= 15) { edgeClass = 'high'; edgeLabel = 'Edge muito alto'; edgeColor = 'var(--accent-yellow)'; }
    else if (edge >= 8) { edgeClass = 'good'; edgeLabel = 'Edge bom'; edgeColor = 'var(--accent-green)'; }

    // ‚îÄ‚îÄ Construir HTML ‚îÄ‚îÄ
    let html = `<div style="background:linear-gradient(135deg, rgba(59,130,246,0.06), rgba(139,92,246,0.04));border:1px solid rgba(59,130,246,0.2);border-radius:12px;padding:20px;margin-bottom:4px">`;

    // Header
    html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
        <div style="font-size:20px">üß†</div>
        <div>
            <div style="font-size:15px;font-weight:800;color:var(--text-primary)">RESUMO: Por que o modelo v√™ valor?</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${o.market} ‚Üí ${o.selection} | Edge: <span style="color:${edgeColor};font-weight:700">${o.edge_pct}</span></div>
        </div>
    </div>`;

    // A explica√ß√£o em linguagem natural
    html += `<div style="background:rgba(0,0,0,0.15);border-radius:8px;padding:14px 16px;margin-bottom:14px;border-left:3px solid ${edgeColor}">
        <div style="font-size:12px;font-weight:700;color:${edgeColor};margin-bottom:6px">${edgeLabel}</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7">`;

    // Gerar o par√°grafo explicativo
    html += `O modelo calcula que <strong style="color:var(--text-primary)">${o.selection}</strong> tem
        <strong style="color:var(--accent-green)">${o.model_prob}%</strong> de probabilidade, usando o modelo Dixon-Coles
        com base nos par√¢metros de ataque/defesa dos times (m√©dia da liga: ${leagueAvg.toFixed(2)} gols/jogo).`;

    if (minGP < 10) {
        html += ` <span style="color:var(--accent-yellow)">Como os times jogaram apenas ${minGP}‚Äì${Math.max(hGP,aGP)} partidas,
        o modelo aplica <strong>regress√£o √† m√©dia</strong> (${Math.round(minGP/15*100)}% peso observado, ${100-Math.round(minGP/15*100)}% m√©dia da liga)
        para n√£o superestimar padr√µes de amostra pequena.</span>`;
    }

    html += `<br><br>A odd justa calculada √© <strong style="color:var(--text-primary)">${fairOdd.toFixed(2)}</strong>,
        mas o mercado oferece <strong style="color:var(--accent-green)">${marketOdd.toFixed(2)}</strong>.
        Essa diferen√ßa gera o edge de <strong style="color:${edgeColor}">${o.edge_pct}</strong>.`;

    if (edge >= 30) {
        html += `<br><br><span style="color:#ff4444;font-weight:700">‚ö†Ô∏è ATEN√á√ÉO: Edge acima de 30% √© incomum e pode indicar que o modelo est√° superestimando a probabilidade
        (ex: amostra pequena, dados insuficientes, ou particularidades que o modelo n√£o captura). Recomenda-se cautela.</span>`;
    }

    html += `</div></div>`;

    // ‚îÄ‚îÄ Fatores-chave (drivers) ‚îÄ‚îÄ
    html += `<div style="font-size:11px;font-weight:800;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üìå Fatores-chave</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:8px;margin-bottom:${warnings.length ? '14px' : '0'}">`;
    drivers.forEach(d => {
        html += `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px 12px">
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                <span style="font-size:14px">${d.icon}</span>
                <span style="font-size:11px;font-weight:700;color:var(--text-primary)">${d.title}</span>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);line-height:1.5">${d.desc}</div>
        </div>`;
    });
    html += '</div>';

    // ‚îÄ‚îÄ Avisos ‚îÄ‚îÄ
    if (warnings.length) {
        html += `<div style="font-size:11px;font-weight:800;color:var(--accent-yellow);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">‚ö†Ô∏è Pontos de aten√ß√£o</div>`;
        warnings.forEach(w => {
            const borderC = w.severity === 'high' ? '#ff4444' : 'var(--accent-yellow)';
            html += `<div style="background:rgba(255,200,0,0.04);border:1px solid rgba(255,200,0,0.15);border-left:3px solid ${borderC};border-radius:8px;padding:10px 12px;margin-bottom:6px">
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">
                    <span style="font-size:13px">${w.icon}</span>
                    <span style="font-size:11px;font-weight:700;color:var(--accent-yellow)">${w.title}</span>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);line-height:1.5">${w.desc}</div>
            </div>`;
        });
    }

    // ‚îÄ‚îÄ Mini pipeline visual ‚îÄ‚îÄ
    html += `<div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06)">
        <div style="font-size:10px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üîÑ Como a odd justa √© calculada</div>
        <div style="display:flex;align-items:center;gap:0;flex-wrap:wrap">
            <div style="background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.25);border-radius:6px;padding:6px 10px;font-size:10px;text-align:center">
                <div style="color:var(--accent-cyan);font-weight:700">1. Dados</div>
                <div style="color:var(--text-muted);margin-top:2px">Gols, forma,<br>standings</div>
            </div>
            <div style="color:var(--text-muted);padding:0 4px;font-size:12px">‚Üí</div>
            <div style="background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.25);border-radius:6px;padding:6px 10px;font-size:10px;text-align:center">
                <div style="color:#a78bfa;font-weight:700">2. Œ± / Œ≤</div>
                <div style="color:var(--text-muted);margin-top:2px">Ataque/defesa<br>+ regress√£o</div>
            </div>
            <div style="color:var(--text-muted);padding:0 4px;font-size:12px">‚Üí</div>
            <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.25);border-radius:6px;padding:6px 10px;font-size:10px;text-align:center">
                <div style="color:var(--accent-green);font-weight:700">3. xG</div>
                <div style="color:var(--text-muted);margin-top:2px">Œª=${o.home_xg.toFixed(2)}<br>Œº=${o.away_xg.toFixed(2)}</div>
            </div>
            <div style="color:var(--text-muted);padding:0 4px;font-size:12px">‚Üí</div>
            <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.25);border-radius:6px;padding:6px 10px;font-size:10px;text-align:center">
                <div style="color:var(--accent-yellow);font-weight:700">4. Monte Carlo</div>
                <div style="color:var(--text-muted);margin-top:2px">5.000 sim.<br>‚Üí P=${o.model_prob}%</div>
            </div>
            <div style="color:var(--text-muted);padding:0 4px;font-size:12px">‚Üí</div>
            <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:6px;padding:6px 10px;font-size:10px;text-align:center">
                <div style="color:#f87171;font-weight:700">5. Odd Justa</div>
                <div style="color:var(--text-muted);margin-top:2px">1/P = ${fairOdd.toFixed(2)}<br>vs mkt ${marketOdd.toFixed(2)}</div>
            </div>
        </div>
    </div>`;

    html += '</div>';
    return html;
}

function buildDetailedAnalysis(o) {
    // Buscar partida associada para dados completos
    const m = allMatches.find(x => x.match_id === o.match_id);
    const L = [];

    // ‚îÄ‚îÄ 0. QUALIDADE DOS DADOS ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("üîç  QUALIDADE DOS DADOS (Data Quality Gate)");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    const dq = o.data_quality || (m ? m.data_quality : 0);
    const dqPct = (dq * 100).toFixed(0);
    const dqBar = "‚ñà".repeat(Math.round(dq * 20)) + "‚ñë".repeat(20 - Math.round(dq * 20));
    const dqLabel = dq >= 0.80 ? "EXCELENTE" : dq >= 0.60 ? "BOA" : dq >= 0.40 ? "MODERADA" : "BAIXA";
    L.push(`  Score:     [${dqBar}] ${dqPct}% ‚Äî ${dqLabel}`);
    L.push("");
    if (m) {
        L.push(`  ‚úÖ Odds REAIS:      ${m.has_real_odds ? 'SIM (' + o.bookmaker + ')' : '‚ùå N√ÉO ‚Äî Estimadas pelo modelo (N√ÉO CONFI√ÅVEL)'}`);
        L.push(`  ‚úÖ Standings REAIS:  ${m.has_real_standings ? 'SIM' : '‚ùå N√ÉO ‚Äî Usando defaults (N√ÉO CONFI√ÅVEL)'}`);
        L.push(`    ‚îú‚îÄ ${o.home_team}: ${m.home_has_real_data ? '‚úÖ Dados reais da API' : '‚ö†Ô∏è ESTIMADO (defaults)'}`);
        L.push(`    ‚îî‚îÄ ${o.away_team}: ${m.away_has_real_data ? '‚úÖ Dados reais da API' : '‚ö†Ô∏è ESTIMADO (defaults)'}`);
        L.push(`  ‚úÖ Clima REAL:       ${m.has_real_weather ? 'SIM' : '‚ùå N√ÉO ‚Äî Sem dados meteorol√≥gicos'}`);
        L.push(`  ‚úÖ √Årbitro:          ${m.referee && m.referee !== 'Desconhecido' ? 'SIM (' + m.referee + ')' : '‚ùå N√ÉO IDENTIFICADO'}`);
        if (m.odds_home_away_suspect || o.odds_suspect) {
            L.push("");
            L.push(`  ‚ö†Ô∏è INVERS√ÉO CASA/FORA DETECTADA:`);
            L.push(`     As odds indicam que "${o.home_team}" (designado como mandante`);
            L.push(`     pela API) √© na verdade o visitante/underdog.`);
            L.push(`     Odds: ${o.home_team}=${m.odds_home.toFixed(2)} vs ${o.away_team}=${m.odds_away.toFixed(2)}`);
            L.push(`     ‚Üí Modelo ajustado: stats neutras + sem vantagem de mando.`);
        }
    } else {
        L.push(`  ‚ö†Ô∏è Dados detalhados da partida n√£o dispon√≠veis no cache`);
    }
    L.push("");
    L.push("  ‚ö†Ô∏è NOTA: Campos de Escanteios, Cart√µes, Faltas e Posse de Bola");
    L.push("  s√£o ESTIMADOS a partir da for√ßa de ataque/defesa, pois a API de");
    L.push("  standings n√£o fornece esses dados granulares diretamente.");
    L.push("");

    // ‚îÄ‚îÄ 1. MODELO ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("üìê  MODELO ESTAT√çSTICO UTILIZADO");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("  Modelo:         Dixon-Coles (Poisson Bivariada Ajustada, 1997)");
    L.push("  Simula√ß√£o:      Monte Carlo ‚Äî 5.000 itera√ß√µes por jogo");
    L.push("  Matriz placar:  9√ó9 (0 a 8 gols por equipe)");
    L.push("  De-Vigging:     Power Method (M√©todo da Pot√™ncia)");
    L.push("  Kelly:          Fracion√°rio (Kelly/4) ‚Äî m√°x. 5% da banca");
    L.push("");

    // ‚îÄ‚îÄ 2. FOR√áA DOS TIMES ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("‚öîÔ∏è  FOR√áA DOS TIMES (Ataque Œ± / Defesa Œ≤)");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    if (m) {
        // Verificar se os dados s√£o reais ou estimados
        const homeHasReal = m.home_has_real_data !== false;
        const awayHasReal = m.away_has_real_data !== false;
        
        // Usar Œ±/Œ≤ REAIS do modelo (n√£o attack_strength/defense_strength gen√©ricos)
        const alphaH = (m.model_alpha_h ?? m.home_attack ?? 1.0).toFixed(2);
        const betaH = (m.model_beta_h ?? m.home_defense ?? 1.0).toFixed(2);
        const alphaA = (m.model_alpha_a ?? m.away_attack ?? 1.0).toFixed(2);
        const betaA = (m.model_beta_a ?? m.away_defense ?? 1.0).toFixed(2);
        L.push(`  M√©dia de gols da liga: ${(m.league_avg_goals ?? 2.7).toFixed(2)} gols/jogo`);
        const hGP = m.home_games_played ?? 0;
        const aGP = m.away_games_played ?? 0;
        if (hGP < 15 || aGP < 15) {
            L.push(`  ‚ö†Ô∏è Amostra pequena (Casa:${hGP} jogos, Fora:${aGP} jogos) ‚Äî regress√£o √† m√©dia aplicada`);
        }
        L.push("");
        L.push(`  ${o.home_team} (CASA):`);
        if (homeHasReal) {
            L.push(`    ‚îú‚îÄ Ataque (Œ±):     ${alphaH}`);
            L.push(`    ‚îú‚îÄ Defesa (Œ≤):     ${betaH}`);
            L.push(`    ‚îú‚îÄ Gols/jogo (casa):  marcados ${m.home_goals_scored_avg ?? 'N/D'} | sofridos ${m.home_goals_conceded_avg ?? 'N/D'}`);
            L.push(`    ‚îú‚îÄ Posi√ß√£o:        ${m.home_league_pos ?? 'N/D'}¬∞ (${m.home_league_pts ?? 'N/D'} pts)`);
            L.push(`    ‚îî‚îÄ Forma (pontos): ${m.home_form_points ?? 'N/D'}`);
        } else {
            L.push(`    ‚ö†Ô∏è  DADOS ESTIMADOS (n√£o reais da API) - an√°lise n√£o confi√°vel`);
            L.push(`    ‚îú‚îÄ Ataque (Œ±):     ${alphaH} (estimado)`);
            L.push(`    ‚îú‚îÄ Defesa (Œ≤):     ${betaH} (estimado)`);
        }
        L.push("");
        L.push(`  ${o.away_team} (FORA):`);
        if (awayHasReal) {
            L.push(`    ‚îú‚îÄ Ataque (Œ±):     ${alphaA}`);
            L.push(`    ‚îú‚îÄ Defesa (Œ≤):     ${betaA}`);
            L.push(`    ‚îú‚îÄ Gols/jogo (fora):  marcados ${m.away_goals_scored_avg ?? 'N/D'} | sofridos ${m.away_goals_conceded_avg ?? 'N/D'}`);
            L.push(`    ‚îú‚îÄ Posi√ß√£o:        ${m.away_league_pos ?? 'N/D'}¬∞ (${m.away_league_pts ?? 'N/D'} pts)`);
            L.push(`    ‚îî‚îÄ Forma (pontos): ${m.away_form_points ?? 'N/D'}`);
        } else {
            L.push(`    ‚ö†Ô∏è  DADOS ESTIMADOS (n√£o reais da API) - an√°lise n√£o confi√°vel`);
            L.push(`    ‚îú‚îÄ Ataque (Œ±):     ${alphaA} (estimado)`);
            L.push(`    ‚îú‚îÄ Defesa (Œ≤):     ${betaA} (estimado)`);
        }
    } else {
        L.push(`  ‚ö†Ô∏è Dados da partida n√£o encontrados no cache`);
        L.push(`  ‚ö†Ô∏è Esta an√°lise n√£o pode ser exibida - dados insuficientes`);
    }
    L.push("");

    // ‚îÄ‚îÄ 3. FORMA RECENTE ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("  FORMA RECENTE");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    if (m) {
        const hf = m.home_form || [];
        const af = m.away_form || [];
        if (hf.length) {
            const hW = hf.filter(x=>x==='W').length, hD = hf.filter(x=>x==='D').length, hL = hf.filter(x=>x==='L').length;
            L.push(`  ${o.home_team} (ult. ${hf.length} jogos): ${hf.join(' ')} -> ${hW}V ${hD}E ${hL}D`);
        } else {
            L.push(`  ${o.home_team}: Dados de forma indisponiveis`);
        }
        if (af.length) {
            const aW = af.filter(x=>x==='W').length, aD = af.filter(x=>x==='D').length, aL = af.filter(x=>x==='L').length;
            L.push(`  ${o.away_team} (ult. ${af.length} jogos): ${af.join(' ')} -> ${aW}V ${aD}E ${aL}D`);
        } else {
            L.push(`  ${o.away_team}: Dados de forma indisponiveis`);
        }
    }
    L.push("");

    // ‚îÄ‚îÄ 4. C√ÅLCULO DE xG ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("‚öΩ  C√ÅLCULO DE xG (Gols Esperados)");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    const isSuspect = o.odds_suspect || (m && m.odds_home_away_suspect);
    if (isSuspect) {
        L.push("  ‚ö†Ô∏è  ATEN√á√ÉO: Poss√≠vel invers√£o Casa/Fora detectada.");
        L.push("  As odds sugerem que o mandante designado pode estar incorreto.");
        L.push("  ‚Üí Modelo usou estat√≠sticas NEUTRAS (m√©dia casa+fora de cada time).");
        L.push("  ‚Üí Vantagem de mando REMOVIDA (fator = 1.0 em vez de 1.08).");
        L.push("");
        L.push("  F√≥rmula AJUSTADA (campo neutro):");
        L.push("    Œª = Œ±_avg √ó Œ≤_avg √ó 1.00 √ó fator_forma");
        L.push("    Œº = Œ±_avg √ó Œ≤_avg √ó fator_forma");
    } else {
        L.push("  F√≥rmula (Dixon-Coles):");
        L.push("    Œª (Casa) = Œ±_casa √ó Œ≤_fora √ó vantagem_mando(1.08) √ó fator_forma");
        L.push("    Œº (Fora) = Œ±_fora √ó Œ≤_casa √ó fator_forma");
    }
    L.push("");
    if (m) {
        const hFormFactor = (0.85 + (m.home_form_points ?? 0.5) * 0.30).toFixed(2);
        const aFormFactor = (0.85 + (m.away_form_points ?? 0.5) * 0.30).toFixed(2);
        const homeHasReal = m.home_has_real_data !== false;
        const awayHasReal = m.away_has_real_data !== false;
        const hmAdv = isSuspect ? '1.00' : '1.08';
        
        if (homeHasReal && awayHasReal) {
            // Usar Œ±/Œ≤ REAIS do modelo (consistentes com o xG calculado)
            const fAlphaH = (m.model_alpha_h ?? m.home_attack ?? 1.0).toFixed(2);
            const fBetaA = (m.model_beta_a ?? m.away_defense ?? 1.0).toFixed(2);
            const fAlphaA = (m.model_alpha_a ?? m.away_attack ?? 1.0).toFixed(2);
            const fBetaH = (m.model_beta_h ?? m.home_defense ?? 1.0).toFixed(2);
            const rawLambda = parseFloat(fAlphaH) * parseFloat(fBetaA) * parseFloat(hmAdv) * parseFloat(hFormFactor);
            const rawMu = parseFloat(fAlphaA) * parseFloat(fBetaH) * parseFloat(aFormFactor);
            L.push(`  C√°lculo Œª (${o.home_team}):`);
            L.push(`    = ${fAlphaH} √ó ${fBetaA} √ó ${hmAdv} √ó ${hFormFactor}`);
            L.push(`    = ${rawLambda.toFixed(2)}${rawLambda > 3.5 ? ' ‚Üí clamped 3.5' : ''}`);
            L.push(`    ‚Üí xG Casa = ${o.home_xg.toFixed(2)}`);
            L.push("");
            L.push(`  C√°lculo Œº (${o.away_team}):`);
            L.push(`    = ${fAlphaA} √ó ${fBetaH} √ó ${aFormFactor}`);
            L.push(`    = ${rawMu.toFixed(2)}${rawMu > 3.0 ? ' ‚Üí clamped 3.0' : ''}`);
            L.push(`    ‚Üí xG Fora = ${o.away_xg.toFixed(2)}`);
        } else {
            L.push(`  ‚ö†Ô∏è  C√°lculo de xG baseado em dados ESTIMADOS (n√£o reais)`);
            L.push(`  ‚ö†Ô∏è  Resultados podem n√£o ser confi√°veis`);
            L.push(`  ‚Üí xG Casa = ${o.home_xg.toFixed(2)} (estimado)`);
            L.push(`  ‚Üí xG Fora = ${o.away_xg.toFixed(2)} (estimado)`);
        }
    } else {
        L.push(`  ‚ö†Ô∏è  Dados insuficientes para exibir c√°lculo detalhado`);
        L.push(`  ‚Üí xG Casa = ${o.home_xg.toFixed(2)}`);
        L.push(`  ‚Üí xG Fora = ${o.away_xg.toFixed(2)}`);
    }
    L.push(`  ‚Üí xG Total = ${(o.home_xg + o.away_xg).toFixed(2)}`);
    L.push("");

    // ‚îÄ‚îÄ 5. PROBABILIDADES DO MODELO ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("üéØ  PROBABILIDADES (Matriz Dixon-Coles + Monte Carlo)");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    if (m) {
        L.push(`  Vit√≥ria Casa:   ${m.prob_home}%`);
        L.push(`  Empate:         ${m.prob_draw}%`);
        L.push(`  Vit√≥ria Fora:   ${m.prob_away}%`);
        L.push(`  Over 2.5 Gols:  ${m.prob_over25}%`);
        L.push(`  BTTS (Ambas):   ${m.prob_btts}%`);
        L.push(`  Escanteios:     ${m.corners_expected} esperados`);
        L.push(`  Cart√µes:        ${m.cards_expected} esperados`);
        if (m.model_total_shots) {
            L.push(`  Finaliza√ß√µes:   ${m.model_total_shots} esperadas (${m.home_team}: ${m.model_home_shots ?? '?'} | ${m.away_team}: ${m.model_away_shots ?? '?'})`);
            L.push(`  Fin. ao Gol:    ${m.model_total_sot} esperadas (${m.home_team}: ${m.model_home_sot ?? '?'} | ${m.away_team}: ${m.model_away_sot ?? '?'})`);
        }
    }
    L.push("");

    // ‚îÄ‚îÄ 6. ODDS DE MERCADO ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push(`üí∞  ODDS DE MERCADO (${o.bookmaker})`);
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    if (m) {
        L.push(`  1x2:    Casa=${m.odds_home}  |  Empate=${m.odds_draw}  |  Fora=${m.odds_away}`);
        L.push(`  O/U 2.5: Over=${m.odds_over25 ?? '?'}  |  Under=${m.odds_under25 ?? '?'}`);
        L.push(`  BTTS:   Sim=${m.odds_btts_yes ?? '?'}  |  N√£o=${m.odds_btts_no ?? '?'}`);
    }
    L.push("");

    // ‚îÄ‚îÄ 7. C√ÅLCULO DO VALOR (EDGE) ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("üìà  C√ÅLCULO DO EDGE (Valor Esperado)");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("  M√©todo de de-vigging: Power Method (M√©todo da Pot√™ncia)");
    L.push("  O Power Method remove a margem (vig) da casa de apostas");
    L.push("  distribuindo-a proporcionalmente (favoritos recebem menos vig).");
    L.push("");
    L.push("  F√≥rmula do Edge:");
    L.push("    Edge = (Prob_Modelo √ó Odd_Mercado) ‚àí 1");
    L.push("");
    L.push(`  Neste mercado (${o.market} ‚Üí ${o.selection}):`);
    L.push(`    Prob. do Modelo:    ${o.model_prob}%`);
    L.push(`    Prob. Impl√≠cita:    ${o.implied_prob}% (ap√≥s de-vig)`);
    L.push(`    Odd de Mercado:     ${o.market_odd.toFixed(2)}`);
    L.push(`    Odd Justa (Modelo): ${o.fair_odd.toFixed(2)}`);
    L.push("");
    L.push(`    Edge = (${(o.model_prob/100).toFixed(3)} √ó ${o.market_odd.toFixed(2)}) ‚àí 1`);
    L.push(`         = ${((o.model_prob/100) * o.market_odd).toFixed(3)} ‚àí 1`);
    L.push(`         = ${o.edge_pct}`);
    L.push("");
    L.push("  Kelly Criterion (gest√£o de risco):");
    L.push("    f* = (p √ó b ‚àí 1) / (b ‚àí 1)   |   aplicado: Kelly/4");
    L.push(`    Aposta sugerida: ${o.kelly_bet_pct} da banca`);
    L.push("");

    // ‚îÄ‚îÄ 8. AJUSTES CONTEXTUAIS ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("üåê  AJUSTES CONTEXTUAIS APLICADOS");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

    // Clima
    if (m && m.weather_desc && m.weather_desc !== "N/D") {
        L.push(`  ‚òÅÔ∏è Clima: ${m.weather_desc ?? 'N/D'} | ${m.weather_temp != null ? m.weather_temp.toFixed(0) : '?'}¬∞C | Vento: ${m.weather_wind != null ? m.weather_wind.toFixed(0) : '?'} km/h${m.weather_rain > 0 ? ' | Chuva: ' + m.weather_rain + 'mm' : ''}`);
        if (m.weather_wind > 20)
            L.push("    ‚Üí Penalidade: xG reduzido ~8% (degrada√ß√£o de passes longos/bolas paradas)");
        if (m.weather_rain > 5)
            L.push("    ‚Üí Ajuste: +5% vari√¢ncia de erros (superf√≠cie molhada)");
        if (m.weather_temp > 30)
            L.push("    ‚Üí Ajuste: pressing reduzido no 2¬∞ tempo (calor extremo)");
    } else {
        L.push("  ‚òÅÔ∏è Clima: Dados n√£o dispon√≠veis");
    }
    L.push("");

    // Fadiga
    if (m) {
        if (m.home_fatigue)
            L.push(`  ‚ö° ${o.home_team}: jogou nas √∫ltimas 72h ‚Üí penalidade de 15% nos ratings`);
        if (m.away_fatigue)
            L.push(`  ‚ö° ${o.away_team}: jogou nas √∫ltimas 72h ‚Üí penalidade de 15% nos ratings`);
        if (!m.home_fatigue && !m.away_fatigue)
            L.push("  ‚ö° Fadiga: Nenhum time com sobrecarga (<72h) ‚Äî sem penalidade");
    }
    L.push("");

    // Les√µes
    if (m) {
        if (m.injuries_home && m.injuries_home.length > 0)
            L.push(`  üè• Les√µes ${o.home_team} (${m.injuries_home.length}): ${m.injuries_home.slice(0,4).join(', ')}`);
        if (m.injuries_away && m.injuries_away.length > 0)
            L.push(`  üè• Les√µes ${o.away_team} (${m.injuries_away.length}): ${m.injuries_away.slice(0,4).join(', ')}`);
        if ((!m.injuries_home || m.injuries_home.length === 0) && (!m.injuries_away || m.injuries_away.length === 0))
            L.push("  üè• Les√µes: Nenhuma les√£o reportada");
    }
    L.push("");

    // Urg√™ncia
    L.push(`  üî• Urg√™ncia (LUS ‚Äî League Urgency Score):`);
    L.push(`     ${o.home_team}: ${o.urgency_home.toFixed(1)} ${o.urgency_home >= 0.9 ? '‚Üê M√ÅXIMA (t√≠tulo/rebaixamento)' : o.urgency_home <= 0.4 ? '‚Üê BAIXA (meio de tabela)' : ''}`);
    L.push(`     ${o.away_team}: ${o.urgency_away.toFixed(1)} ${o.urgency_away >= 0.9 ? '‚Üê M√ÅXIMA (t√≠tulo/rebaixamento)' : o.urgency_away <= 0.4 ? '‚Üê BAIXA (meio de tabela)' : ''}`);
    L.push("");

    // √Årbitro
    if (m && m.referee && m.referee !== "Desconhecido") {
        L.push(`  üë®‚Äç‚öñÔ∏è √Årbitro: ${m.referee}`);
        L.push(`     M√©dia: ${m.referee_cards_avg ?? '?'} cart√µes/jogo | ${m.referee_fouls_avg ?? '?'} faltas/jogo`);
    }
    L.push("");

    // ‚îÄ‚îÄ 9. CONCLUS√ÉO ‚îÄ‚îÄ
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push("‚úÖ  CONCLUS√ÉO");
    L.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    L.push(`  O modelo Dixon-Coles atribui ${o.model_prob}% de probabilidade`);
    L.push(`  ao evento "${o.selection}" (mercado ${o.market}),`);
    L.push(`  enquanto o mercado (${o.bookmaker}) implica apenas ${o.implied_prob}%.`);
    L.push("");
    L.push(`  A odd de mercado (${o.market_odd.toFixed(2)}) est√° acima da odd justa`);
    L.push(`  calculada pelo modelo (${o.fair_odd.toFixed(2)}), gerando um`);
    L.push(`  edge de ${o.edge_pct} ‚Äî oportunidade de valor positivo (+EV).`);
    L.push("");
    L.push(`  Confian√ßa: ${o.confidence}`);
    if (o.confidence === "ALTO")
        L.push("  Crit√©rio: Edge >8% + Prob >35% + condi√ß√µes favor√°veis");
    else if (o.confidence === "M√âDIO")
        L.push("  Crit√©rio: Edge >5% mas com algum fator adverso");
    else
        L.push("  Crit√©rio: Edge moderado com incertezas nos dados");

    return L.join("\n");
}

function showMatchDetail(matchId) {
    const m = allMatches.find(x => x.match_id === matchId);
    if (!m) return;

    document.getElementById("modal-title").textContent = `${m.home_team} vs ${m.away_team}`;
    document.getElementById("modal-subtitle").textContent = `${m.league_name} ‚Äî ${m.league_country} | ${m.match_date} ${m.match_time}`;

    const formHtml = (form) => form.map(f => `<div class="form-dot form-${f}">${f}</div>`).join("");
    const matchOpps = allOpps.filter(o => o.match_id === matchId);
    const oppsHtml = matchOpps.length > 0 ? matchOpps.map(o => {
        const confClass = o.confidence === "ALTO" ? "badge-high" : o.confidence === "M√âDIO" ? "badge-med" : "badge-low";
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                <span class="badge ${confClass}">${o.confidence}</span>
                <span>${o.market}: <strong>${o.selection}</strong></span>
                <span style="font-family:'JetBrains Mono';font-size:12px;color:var(--text-secondary)">@${o.market_odd.toFixed(2)}</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
                <span style="font-weight:800;color:var(--accent-green);font-family:'JetBrains Mono'">${o.edge_pct}</span>
                ${bookmakerBadgeHtml(o.bookmaker, o.home_team, o.away_team, o.market, o.selection, true, o.league_country, o.league_name)}
            </div>
        </div>`;
    }).join("") : '<div style="color:var(--text-muted);padding:8px 0">Nenhuma oportunidade +EV identificada para este jogo</div>';

    document.getElementById("modal-body").innerHTML = `
        <div class="detail-grid">
            <div class="detail-item">
                <div class="detail-label">xG Casa</div>
                <div class="detail-value" style="color:var(--accent-green);font-family:'JetBrains Mono';font-size:28px">${m.home_xg}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">xG Fora</div>
                <div class="detail-value" style="color:var(--accent-blue);font-family:'JetBrains Mono';font-size:28px">${m.away_xg}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Probabilidades 1x2</div>
                <div class="detail-value">${m.prob_home}% / ${m.prob_draw}% / ${m.prob_away}%</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Over 2.5 / BTTS</div>
                <div class="detail-value">${m.prob_over25}% / ${m.prob_btts}%</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Odds (H/D/A)</div>
                <div class="detail-value" style="font-family:'JetBrains Mono'">${m.odds_home} / ${m.odds_draw} / ${m.odds_away}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Escanteios / Cart√µes</div>
                <div class="detail-value">${m.corners_expected} / ${m.cards_expected}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Clima</div>
                <div class="detail-value">${m.weather_desc} | ${m.weather_temp}¬∞C | üí®${m.weather_wind.toFixed(0)}km/h${m.weather_rain > 0 ? ' | üåßÔ∏è' + m.weather_rain + 'mm' : ''}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">√Årbitro</div>
                <div class="detail-value">${m.referee} (${m.referee_cards_avg} cart√µes/jogo)</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Est√°dio</div>
                <div class="detail-value">${m.venue}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Urg√™ncia (H/A)</div>
                <div class="detail-value">${m.urgency_home.toFixed(1)} / ${m.urgency_away.toFixed(1)}</div>
            </div>
        </div>

        <div style="margin-bottom:16px">
            <div class="detail-label" style="margin-bottom:8px">Forma Recente ‚Äî ${m.home_team}</div>
            <div class="form-dots">${formHtml(m.home_form)}</div>
        </div>
        <div style="margin-bottom:16px">
            <div class="detail-label" style="margin-bottom:8px">Forma Recente ‚Äî ${m.away_team}</div>
            <div class="form-dots">${formHtml(m.away_form)}</div>
        </div>

        ${m.injuries_home.length > 0 ? `<div style="margin-bottom:12px"><div class="detail-label" style="margin-bottom:6px">üè• Les√µes ${m.home_team}</div><div style="font-size:13px;color:var(--accent-red)">${m.injuries_home.join('<br>')}</div></div>` : ''}
        ${m.injuries_away.length > 0 ? `<div style="margin-bottom:12px"><div class="detail-label" style="margin-bottom:6px">üè• Les√µes ${m.away_team}</div><div style="font-size:13px;color:var(--accent-red)">${m.injuries_away.join('<br>')}</div></div>` : ''}
        ${m.home_fatigue || m.away_fatigue ? `<div style="margin-bottom:12px;padding:10px;background:var(--accent-yellow-dim);border-radius:8px;font-size:13px;color:var(--accent-yellow)">‚ö° Fadiga: ${m.home_fatigue ? m.home_team + ' (Casa)' : ''} ${m.away_fatigue ? m.away_team + ' (Fora)' : ''} ‚Äî jogou nas √∫ltimas 72h</div>` : ''}

        <div style="margin-top:16px;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-sm)">
            <div class="detail-label" style="margin-bottom:6px">üè¶ Odds fornecidas por</div>
            <div>${bookmakerBadgeHtml(m.bookmaker, m.home_team, m.away_team, '1x2', '', false, m.league_country, m.league_name)}</div>
        </div>

        <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:16px">
            <div class="detail-label" style="margin-bottom:12px">üéØ Oportunidades de Valor (+EV)</div>
            ${oppsHtml}
        </div>
    `;
    document.getElementById("modal-overlay").classList.add("show");
}

function closeModal(e) {
    if (e && e.target !== document.getElementById("modal-overlay")) return;
    document.getElementById("modal-overlay").classList.remove("show");
}
document.addEventListener("keydown", e => { if (e.key === "Escape") closeModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORICO DE TIMES ‚Äî Carregamento sob demanda
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Troca de aba de mercado no painel de an√°lise ‚îÄ‚îÄ
function switchMktTab(uid, tabId) {
    document.querySelectorAll('[data-mkt-uid="' + uid + '"]').forEach(el => el.style.display = 'none');
    const p = document.getElementById(uid + '_' + tabId);
    if (p) p.style.display = 'block';
    document.querySelectorAll('[data-mkt-btn="' + uid + '"]').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.color = 'var(--text-secondary)';
        btn.style.borderColor = 'rgba(255,255,255,0.08)';
    });
    const ab = document.getElementById(uid + '_btn_' + tabId);
    if (ab) { ab.style.background = 'var(--accent-green)'; ab.style.color = '#000'; ab.style.borderColor = 'var(--accent-green)'; }
}

async function loadTeamHistory(homeId, awayId, leagueId, homeName, awayName, leagueName) {
    const btn = document.getElementById('btn-load-history');
    const container = document.getElementById('history-content');
    if (!btn || !container) return;

    btn.disabled = true;
    btn.textContent = 'Carregando...';
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Buscando historico + confronto direto... (usa cache se disponivel)</div>';

    try {
        const [homeRes, awayRes, h2hRes] = await Promise.all([
            fetch(`/api/team-history/${homeId}?league_id=${leagueId}&last=10`).then(r => r.json()),
            fetch(`/api/team-history/${awayId}?league_id=${leagueId}&last=10`).then(r => r.json()),
            fetch(`/api/h2h/${homeId}/${awayId}`).then(r => r.json()),
        ]);

        btn.style.display = 'none';
        container.innerHTML = renderTeamHistory(homeRes, awayRes, h2hRes, leagueId, homeName, awayName, leagueName);
    } catch (err) {
        container.innerHTML = `<div style="color:var(--accent-red);padding:12px">Erro ao carregar: ${err.message}</div>`;
        btn.disabled = false;
        btn.textContent = 'Tentar Novamente';
    }
}

function renderTeamHistory(homeData, awayData, h2hData, leagueId, homeName, awayName, leagueName) {

    // ‚îÄ‚îÄ Helpers reutilizaveis ‚îÄ‚îÄ
    const calcSummary = (matches) => {
        if (!matches.length) return null;
        const w = matches.filter(m => m.result === 'W').length;
        const d = matches.filter(m => m.result === 'D').length;
        const l = matches.filter(m => m.result === 'L').length;
        const goalsFor = matches.reduce((s, m) => s + (m.is_home ? m.score_home : m.score_away), 0);
        const goalsAgainst = matches.reduce((s, m) => s + (m.is_home ? m.score_away : m.score_home), 0);
        const over25 = matches.filter(m => m.total_goals > 2.5).length;
        const tCorners = matches.filter(m => m.stats?.total_corners != null).reduce((s, m) => s + (m.stats.total_corners || 0), 0);
        const nCorners = matches.filter(m => m.stats?.total_corners != null).length;
        const tCards = matches.filter(m => m.stats?.total_cards != null).reduce((s, m) => s + (m.stats.total_cards || 0), 0);
        const nCards = matches.filter(m => m.stats?.total_cards != null).length;
        const favW = matches.filter(m => m.was_favorite && m.result === 'W').length;
        const favT = matches.filter(m => m.was_favorite === true).length;
        return { w, d, l, goalsFor, goalsAgainst, over25, tCorners, nCorners, tCards, nCards, favW, favT, total: matches.length };
    };

    const badge = (text, bg, fg) => `<span style="padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;background:${bg};color:${fg}">${text}</span>`;

    const summaryBadges = (s) => {
        if (!s) return '';
        const avg = ((s.goalsFor + s.goalsAgainst) / s.total).toFixed(1);
        const avgC = s.nCorners > 0 ? (s.tCorners / s.nCorners).toFixed(1) : '-';
        const avgK = s.nCards > 0 ? (s.tCards / s.nCards).toFixed(1) : '-';
        const o25 = ((s.over25 / s.total) * 100).toFixed(0);
        const fPct = s.favT > 0 ? ((s.favW / s.favT) * 100).toFixed(0) + '%' : '';
        return `<div style="display:flex;flex-wrap:wrap;gap:5px;margin:6px 0 10px">
            ${badge(s.w+'V','rgba(0,255,136,0.12)','var(--accent-green)')}
            ${badge(s.d+'E','rgba(255,200,0,0.12)','var(--accent-yellow)')}
            ${badge(s.l+'D','rgba(255,80,80,0.12)','var(--accent-red)')}
            ${badge(s.goalsFor+'GP '+s.goalsAgainst+'GC','rgba(255,255,255,0.05)','var(--text-secondary)')}
            ${badge('Media '+avg+'g/j','rgba(255,255,255,0.05)','var(--text-secondary)')}
            ${badge('O2.5: '+o25+'%','rgba(255,255,255,0.05)','var(--text-secondary)')}
            ${badge('Esc: '+avgC+'/j','rgba(255,255,255,0.05)','var(--text-secondary)')}
            ${badge('Cart: '+avgK+'/j','rgba(255,255,255,0.05)','var(--text-secondary)')}
            ${fPct ? badge('Fav: '+fPct,'rgba(255,255,255,0.05)','var(--accent-yellow)') : ''}
        </div>`;
    };

    const thStyle = 'padding:6px 8px;text-align:left;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)';
    const tdStyle = 'padding:6px 8px;font-size:12px;border-bottom:1px solid rgba(255,255,255,0.04)';

    const matchRowBase = (m, showLeague) => {
        const rc = m.result === 'W' ? 'var(--accent-green)' : m.result === 'L' ? 'var(--accent-red)' : 'var(--accent-yellow)';
        const rl = m.result === 'W' ? 'V' : m.result === 'L' ? 'D' : 'E';
        const hac = m.is_home ? 'var(--accent-green)' : 'var(--accent-blue)';
        const ha = m.is_home ? 'C' : 'F';
        const fav = m.was_favorite === true ? ' <span title="Favorito" style="color:var(--accent-yellow)">‚òÖ</span>' : m.was_favorite === false ? ' <span title="Underdog" style="color:var(--text-muted)">‚òÜ</span>' : '';
        const ou = m.total_goals > 2.5 ? '<span style="color:var(--accent-green)">O2.5</span>' : '<span style="color:var(--accent-red)">U2.5</span>';
        const s = m.stats || {};
        const esc = s.total_corners != null ? s.total_corners : '-';
        const cart = s.total_cards != null ? s.total_cards : '-';
        const xi = m.lineup_type === 'disponivel' ? '<span style="font-size:9px;padding:1px 4px;border-radius:3px;background:rgba(0,255,136,0.1);color:var(--accent-green)">XI</span>' : '';
        const leagueCol = showLeague ? `<td style="${tdStyle};font-size:10px;color:var(--text-muted);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${m.league_name || ''}">${m.league_name || '-'}</td>` : '';
        return `<tr>
            <td style="${tdStyle};color:var(--text-muted);white-space:nowrap">${m.date}</td>
            ${leagueCol}
            <td style="${tdStyle};text-align:center"><span style="color:${hac};font-weight:700;font-size:10px">${ha}</span></td>
            <td style="${tdStyle};max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${m.opponent}">${m.opponent}${fav}</td>
            <td style="${tdStyle};text-align:center;font-weight:800;font-family:'JetBrains Mono'"><span style="color:${rc}">${m.score_home}-${m.score_away}</span></td>
            <td style="${tdStyle};text-align:center"><span style="background:${rc}20;color:${rc};padding:2px 6px;border-radius:4px;font-weight:800;font-size:10px">${rl}</span></td>
            <td style="${tdStyle};text-align:center;font-size:10px">${ou}</td>
            <td style="${tdStyle};text-align:center;color:var(--text-muted)">${esc}</td>
            <td style="${tdStyle};text-align:center;color:var(--text-muted)">${cart}</td>
            <td style="${tdStyle};text-align:center">${xi}</td>
        </tr>`;
    };
    const matchRow = (m) => matchRowBase(m, false);
    const matchRowFull = (m) => matchRowBase(m, true);

    const tableWrap = (rows) => `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;min-width:600px">
        <thead><tr>
            <th style="${thStyle}">Data</th>
            <th style="${thStyle};text-align:center">C/F</th>
            <th style="${thStyle}">Adversario</th>
            <th style="${thStyle};text-align:center">Placar</th>
            <th style="${thStyle};text-align:center">Res</th>
            <th style="${thStyle};text-align:center">O/U</th>
            <th style="${thStyle};text-align:center">Esc</th>
            <th style="${thStyle};text-align:center">Cart</th>
            <th style="${thStyle};text-align:center">XI</th>
        </tr></thead><tbody>${rows}</tbody></table></div>`;

    const tableWrapFull = (rows) => `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;min-width:700px">
        <thead><tr>
            <th style="${thStyle}">Data</th>
            <th style="${thStyle}">Campeonato</th>
            <th style="${thStyle};text-align:center">C/F</th>
            <th style="${thStyle}">Adversario</th>
            <th style="${thStyle};text-align:center">Placar</th>
            <th style="${thStyle};text-align:center">Res</th>
            <th style="${thStyle};text-align:center">O/U</th>
            <th style="${thStyle};text-align:center">Esc</th>
            <th style="${thStyle};text-align:center">Cart</th>
            <th style="${thStyle};text-align:center">XI</th>
        </tr></thead><tbody>${rows}</tbody></table></div>`;

    const sectionTitle = (icon, text, color) => `<div style="font-size:15px;font-weight:800;color:${color};margin:20px 0 4px;padding-bottom:6px;border-bottom:2px solid ${color}30">${icon} ${text}</div>`;
    const subTitle = (text) => `<div style="font-size:11px;font-weight:700;color:var(--text-secondary);margin:12px 0 4px;text-transform:uppercase;letter-spacing:1px">${text}</div>`;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AN√ÅLISE POR MERCADO ‚Äî painel completo com tabs
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const buildMarketAnalysis = (matches, uid) => {
        const ms = matches.filter(m => m.stats && Object.keys(m.stats).length > 0);
        const n = ms.length;
        if (!n) return '<div style="color:var(--text-muted);padding:12px;font-size:11px;text-align:center">Estatisticas detalhadas indisponiveis para analise de mercados</div>';

        const parsePoss = (v) => { if (v == null) return null; if (typeof v === 'string') return parseFloat(v.replace('%','')); return parseFloat(v); };
        const si = (v) => v != null ? parseInt(v) : null;

        // ‚îÄ‚îÄ Helpers visuais ‚îÄ‚îÄ
        const kpi = (label, value, color) => `<div style="background:rgba(255,255,255,0.03);padding:8px 10px;border-radius:6px;text-align:center;min-width:80px;flex:1">
            <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px">${label}</div>
            <div style="font-size:17px;font-weight:800;color:${color}">${value}</div>
        </div>`;

        const pctBar = (label, count, total, color) => {
            const pct = total > 0 ? ((count / total) * 100) : 0;
            return `<div style="display:flex;align-items:center;gap:8px;margin:3px 0">
                <div style="min-width:48px;font-size:11px;color:var(--text-secondary);text-align:right;font-weight:600">${label}</div>
                <div style="flex:1;height:22px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden;position:relative">
                    <div style="height:100%;width:${pct.toFixed(0)}%;background:${color};border-radius:4px;transition:width .3s"></div>
                    <span style="position:absolute;right:8px;top:3px;font-size:10px;font-weight:700;color:var(--text-primary)">${count}/${total} (${pct.toFixed(0)}%)</span>
                </div>
            </div>`;
        };

        const evBar = (label, count, total, color) => {
            const pct = total > 0 ? (count / total) : 0;
            const pctStr = (pct * 100).toFixed(0);
            const fairOdd = pct > 0 ? (1 / pct).toFixed(2) : '‚àû';
            const evColor = pct >= 0.55 ? 'var(--accent-green)' : pct >= 0.40 ? 'var(--accent-yellow)' : 'var(--text-muted)';
            return `<div style="display:flex;align-items:center;gap:8px;margin:3px 0">
                <div style="min-width:48px;font-size:11px;color:var(--text-secondary);text-align:right;font-weight:600">${label}</div>
                <div style="flex:1;height:22px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden;position:relative">
                    <div style="height:100%;width:${pctStr}%;background:${color};border-radius:4px;transition:width .3s"></div>
                    <span style="position:absolute;right:8px;top:3px;font-size:10px;font-weight:700;color:var(--text-primary)">${count}/${total} (${pctStr}%)</span>
                </div>
                <div style="min-width:68px;text-align:center;font-size:10px;font-weight:700;color:${evColor};background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:4px" title="Odd justa calculada (se mercado oferece odd MAIOR que esta, pode ser EV+)">Fair: ${fairOdd}</div>
            </div>`;
        };

        const detailOpen = `<details style="margin-top:10px"><summary style="cursor:pointer;font-size:10px;color:var(--accent-green);font-weight:700;padding:4px 0">‚ñ∂ VER JOGO A JOGO</summary><div style="overflow-x:auto;margin-top:6px">`;
        const detailClose = `</div></details>`;
        const _th = thStyle;
        const _td = tdStyle;

        // ‚ïê‚ïê‚ïê TAB 1: GOLS & BTTS (COMPLETO) ‚ïê‚ïê‚ïê
        const goalsPanel = (() => {
            let teamG = 0, oppG = 0, btts = 0, cs = 0, fts = 0;
            const lines = [0.5, 1.5, 2.5, 3.5, 4.5, 5.5];
            const oc = lines.map(() => 0);
            // Gols do Time O/U
            const teamLines = [0.5, 1.5, 2.5, 3.5];
            const teamOC = teamLines.map(() => 0);
            const oppLines = [0.5, 1.5, 2.5];
            const oppOC = oppLines.map(() => 0);

            ms.forEach(m => {
                const my = m.is_home ? m.score_home : m.score_away;
                const op = m.is_home ? m.score_away : m.score_home;
                teamG += my; oppG += op;
                if (my > 0 && op > 0) btts++;
                if (op === 0) cs++;
                if (my === 0) fts++;
                lines.forEach((l, i) => { if (m.total_goals > l) oc[i]++; });
                teamLines.forEach((l, i) => { if (my > l) teamOC[i]++; });
                oppLines.forEach((l, i) => { if (op > l) oppOC[i]++; });
            });
            let h = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
                ${kpi('Media Gols/J', ((teamG + oppG) / n).toFixed(1), 'var(--text-primary)')}
                ${kpi('Gols Pro/J', (teamG / n).toFixed(1), 'var(--accent-green)')}
                ${kpi('Gols Contra/J', (oppG / n).toFixed(1), 'var(--accent-red)')}
                ${kpi('BTTS (Ambas)', ((btts / n) * 100).toFixed(0) + '%', 'var(--accent-yellow)')}
                ${kpi('Clean Sheet', ((cs / n) * 100).toFixed(0) + '%', 'var(--accent-blue)')}
                ${kpi('Falhou Marcar', ((fts / n) * 100).toFixed(0) + '%', 'var(--accent-red)')}
            </div>`;

            h += '<div style="font-size:10px;font-weight:700;color:var(--accent-green);margin-bottom:4px;text-transform:uppercase">‚ö° EV+ Over/Under Gols Totais</div>';
            h += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Se a casa oferece odd MAIOR que a "Fair", historicamente e EV+</div>';
            lines.forEach((l, i) => { h += evBar('O ' + l, oc[i], n, 'var(--accent-green)'); });

            h += '<div style="font-size:10px;font-weight:700;color:var(--accent-blue);margin:12px 0 4px;text-transform:uppercase">‚ö° EV+ Gols do Time (Over/Under)</div>';
            teamLines.forEach((l, i) => { h += evBar('O ' + l, teamOC[i], n, 'var(--accent-blue)'); });

            h += '<div style="font-size:10px;font-weight:700;color:var(--accent-red);margin:12px 0 4px;text-transform:uppercase">‚ö° EV+ Gols Adversario (Over/Under)</div>';
            oppLines.forEach((l, i) => { h += evBar('O ' + l, oppOC[i], n, 'var(--accent-red)'); });

            h += '<div style="font-size:10px;font-weight:700;color:var(--accent-yellow);margin:12px 0 4px;text-transform:uppercase">‚ö° EV+ BTTS (Ambas Marcam)</div>';
            h += evBar('BTTS Sim', btts, n, 'var(--accent-yellow)');
            h += evBar('BTTS Nao', n - btts, n, 'var(--accent-cyan)');

            h += detailOpen + `<table style="width:100%;border-collapse:collapse;font-size:11px">
            <thead><tr>
                <th style="${_th}">Data</th><th style="${_th}">Adversario</th>
                <th style="${_th};text-align:center">GP</th><th style="${_th};text-align:center">GC</th>
                <th style="${_th};text-align:center">Total</th><th style="${_th};text-align:center">O/U 2.5</th>
                <th style="${_th};text-align:center">BTTS</th>
            </tr></thead><tbody>`;
            ms.forEach(m => {
                const my = m.is_home ? m.score_home : m.score_away;
                const op = m.is_home ? m.score_away : m.score_home;
                const ou = m.total_goals > 2.5 ? '<span style="color:var(--accent-green)">Over</span>' : '<span style="color:var(--accent-red)">Under</span>';
                const bt = (my > 0 && op > 0) ? '<span style="color:var(--accent-green)">Sim</span>' : '<span style="color:var(--accent-red)">Nao</span>';
                h += `<tr><td style="${_td};color:var(--text-muted)">${m.date}</td><td style="${_td}">${m.opponent}</td>
                    <td style="${_td};text-align:center;color:var(--accent-green)">${my}</td>
                    <td style="${_td};text-align:center;color:var(--accent-red)">${op}</td>
                    <td style="${_td};text-align:center;font-weight:700">${m.total_goals}</td>
                    <td style="${_td};text-align:center">${ou}</td>
                    <td style="${_td};text-align:center">${bt}</td></tr>`;
            });
            h += '</tbody></table>' + detailClose;
            return h;
        })();

        // ‚ïê‚ïê‚ïê TAB 2: ESCANTEIOS ‚ïê‚ïê‚ïê
        const cornersPanel = (() => {
            const valid = ms.filter(m => m.stats?.total_corners != null);
            if (!valid.length) return '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Dados de escanteios indisponiveis</div>';
            const vn = valid.length;
            let tc = 0, oc_ = 0;
            const lines = [7.5, 8.5, 9.5, 10.5, 11.5];
            const ovc = lines.map(() => 0);
            valid.forEach(m => {
                const t = si(m.stats.team_corners) || 0;
                const o = si(m.stats.opp_corners) || 0;
                tc += t; oc_ += o;
                lines.forEach((l, i) => { if (m.stats.total_corners > l) ovc[i]++; });
            });
            let h = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
                ${kpi('Media Total/J', ((tc + oc_) / vn).toFixed(1), 'var(--text-primary)')}
                ${kpi('Media Time/J', (tc / vn).toFixed(1), 'var(--accent-green)')}
                ${kpi('Media Advers./J', (oc_ / vn).toFixed(1), 'var(--accent-red)')}
                ${kpi('Jogos c/ Dados', vn + '/' + n, 'var(--text-muted)')}
            </div>`;
            h += '<div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase">Over/Under Escanteios</div>';
            lines.forEach((l, i) => { h += pctBar('O ' + l, ovc[i], vn, 'var(--accent-blue)'); });

            h += detailOpen + `<table style="width:100%;border-collapse:collapse;font-size:11px">
            <thead><tr>
                <th style="${_th}">Data</th><th style="${_th}">Adversario</th>
                <th style="${_th};text-align:center">Time</th><th style="${_th};text-align:center">Advers.</th>
                <th style="${_th};text-align:center">Total</th><th style="${_th};text-align:center">O/U 9.5</th>
            </tr></thead><tbody>`;
            valid.forEach(m => {
                const t = si(m.stats.team_corners) ?? '-';
                const o = si(m.stats.opp_corners) ?? '-';
                const tot = m.stats.total_corners;
                const ou = tot > 9.5 ? '<span style="color:var(--accent-green)">Over</span>' : '<span style="color:var(--accent-red)">Under</span>';
                h += `<tr><td style="${_td};color:var(--text-muted)">${m.date}</td><td style="${_td}">${m.opponent}</td>
                    <td style="${_td};text-align:center">${t}</td><td style="${_td};text-align:center">${o}</td>
                    <td style="${_td};text-align:center;font-weight:700">${tot}</td>
                    <td style="${_td};text-align:center">${ou}</td></tr>`;
            });
            h += '</tbody></table>' + detailClose;
            return h;
        })();

        // ‚ïê‚ïê‚ïê TAB 3: CART√ïES ‚ïê‚ïê‚ïê
        const cardsPanel = (() => {
            const valid = ms.filter(m => m.stats?.total_cards != null);
            if (!valid.length) return '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Dados de cartoes indisponiveis</div>';
            const vn = valid.length;
            let ty = 0, tr_ = 0, oy = 0, or_ = 0;
            const lines = [2.5, 3.5, 4.5, 5.5, 6.5];
            const ovc = lines.map(() => 0);
            valid.forEach(m => {
                ty += si(m.stats.team_cards_yellow) || 0;
                tr_ += si(m.stats.team_cards_red) || 0;
                oy += si(m.stats.opp_cards_yellow) || 0;
                or_ += si(m.stats.opp_cards_red) || 0;
                lines.forEach((l, i) => { if (m.stats.total_cards > l) ovc[i]++; });
            });
            const totalC = ty + tr_ + oy + or_;
            let h = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
                ${kpi('Media Total/J', (totalC / vn).toFixed(1), 'var(--text-primary)')}
                ${kpi('üü® Time/J', (ty / vn).toFixed(1), 'var(--accent-yellow)')}
                ${kpi('üü• Time/J', (tr_ / vn).toFixed(1), 'var(--accent-red)')}
                ${kpi('üü® Advers./J', (oy / vn).toFixed(1), 'var(--accent-yellow)')}
                ${kpi('üü• Advers./J', (or_ / vn).toFixed(1), 'var(--accent-red)')}
            </div>`;
            h += '<div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase">Over/Under Cartoes</div>';
            lines.forEach((l, i) => { h += pctBar('O ' + l, ovc[i], vn, 'var(--accent-yellow)'); });

            h += detailOpen + `<table style="width:100%;border-collapse:collapse;font-size:11px">
            <thead><tr>
                <th style="${_th}">Data</th><th style="${_th}">Adversario</th>
                <th style="${_th};text-align:center">üü® T</th><th style="${_th};text-align:center">üü• T</th>
                <th style="${_th};text-align:center">üü® A</th><th style="${_th};text-align:center">üü• A</th>
                <th style="${_th};text-align:center">Total</th><th style="${_th};text-align:center">O/U 4.5</th>
            </tr></thead><tbody>`;
            valid.forEach(m => {
                const _ty = si(m.stats.team_cards_yellow) ?? '-';
                const _tr = si(m.stats.team_cards_red) ?? '-';
                const _oy = si(m.stats.opp_cards_yellow) ?? '-';
                const _or = si(m.stats.opp_cards_red) ?? '-';
                const tot = m.stats.total_cards;
                const ou = tot > 4.5 ? '<span style="color:var(--accent-green)">Over</span>' : '<span style="color:var(--accent-red)">Under</span>';
                h += `<tr><td style="${_td};color:var(--text-muted)">${m.date}</td><td style="${_td}">${m.opponent}</td>
                    <td style="${_td};text-align:center">${_ty}</td><td style="${_td};text-align:center">${_tr}</td>
                    <td style="${_td};text-align:center">${_oy}</td><td style="${_td};text-align:center">${_or}</td>
                    <td style="${_td};text-align:center;font-weight:700">${tot}</td>
                    <td style="${_td};text-align:center">${ou}</td></tr>`;
            });
            h += '</tbody></table>' + detailClose;
            return h;
        })();

        // ‚ïê‚ïê‚ïê TAB 4: FINALIZA√á√ïES ‚ïê‚ïê‚ïê
        const shotsPanel = (() => {
            const valid = ms.filter(m => m.stats?.team_shots != null);
            if (!valid.length) return '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Dados de finalizacoes indisponiveis</div>';
            const vn = valid.length;
            let tShots = 0, tSoT = 0, oShots = 0, oSoT = 0, tSaves = 0, oSaves = 0;
            valid.forEach(m => {
                tShots += si(m.stats.team_shots) || 0;
                tSoT += si(m.stats.team_shots_on_target) || 0;
                oShots += si(m.stats.opp_shots) || 0;
                oSoT += si(m.stats.opp_shots_on_target) || 0;
                tSaves += si(m.stats.team_saves) || 0;
                oSaves += si(m.stats.opp_saves) || 0;
            });
            let h = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
                ${kpi('Finaliz. Time/J', (tShots / vn).toFixed(1), 'var(--accent-green)')}
                ${kpi('No Alvo Time/J', (tSoT / vn).toFixed(1), 'var(--accent-green)')}
                ${kpi('Finaliz. Adv./J', (oShots / vn).toFixed(1), 'var(--accent-red)')}
                ${kpi('No Alvo Adv./J', (oSoT / vn).toFixed(1), 'var(--accent-red)')}
                ${kpi('Defesas Gol./J', (tSaves / vn).toFixed(1), 'var(--accent-blue)')}
                ${kpi('% Acerto Time', tShots > 0 ? ((tSoT / tShots) * 100).toFixed(0) + '%' : '-', 'var(--accent-yellow)')}
            </div>`;

            // ‚îÄ‚îÄ EV+ Finaliza√ß√µes do TIME (Over/Under) ‚îÄ‚îÄ
            h += '<div style="font-size:10px;font-weight:700;color:var(--accent-green);margin:12px 0 4px;text-transform:uppercase">‚ö° EV+ Finalizacoes do Time (Over/Under)</div>';
            h += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:6px">Se a casa oferece odd MAIOR que a "Fair", historicamente e EV+</div>';
            const teamShotLines = [7.5, 8.5, 9.5, 10.5, 11.5, 12.5];
            const tslOvc = teamShotLines.map(() => 0);
            valid.forEach(m => {
                const ts = si(m.stats.team_shots) || 0;
                teamShotLines.forEach((l, i) => { if (ts > l) tslOvc[i]++; });
            });
            teamShotLines.forEach((l, i) => { h += evBar('O ' + l, tslOvc[i], vn, 'var(--accent-green)'); });

            // ‚îÄ‚îÄ EV+ Finaliza√ß√µes em GOL do TIME ‚îÄ‚îÄ
            h += '<div style="font-size:10px;font-weight:700;color:var(--accent-green);margin:14px 0 4px;text-transform:uppercase">‚ö° EV+ Finalizacoes em Gol do Time (Over/Under)</div>';
            const teamSoTLines = [1.5, 2.5, 3.5, 4.5, 5.5];
            const tsotOvc = teamSoTLines.map(() => 0);
            valid.forEach(m => {
                const sot = si(m.stats.team_shots_on_target) || 0;
                teamSoTLines.forEach((l, i) => { if (sot > l) tsotOvc[i]++; });
            });
            teamSoTLines.forEach((l, i) => { h += evBar('O ' + l, tsotOvc[i], vn, 'var(--accent-blue)'); });

            // ‚îÄ‚îÄ Over/Under Totais no Jogo ‚îÄ‚îÄ
            h += '<div style="font-size:10px;font-weight:700;color:var(--text-muted);margin:14px 0 4px;text-transform:uppercase">Over/Under Finalizacoes Totais no Jogo</div>';
            const totalLines = [17.5, 19.5, 21.5, 23.5, 25.5];
            const ovc = totalLines.map(() => 0);
            valid.forEach(m => {
                const tot = (si(m.stats.team_shots) || 0) + (si(m.stats.opp_shots) || 0);
                totalLines.forEach((l, i) => { if (tot > l) ovc[i]++; });
            });
            totalLines.forEach((l, i) => { h += pctBar('O ' + l, ovc[i], vn, 'var(--accent-green)'); });

            h += detailOpen + `<table style="width:100%;border-collapse:collapse;font-size:11px">
            <thead><tr>
                <th style="${_th}">Data</th><th style="${_th}">Adversario</th>
                <th style="${_th};text-align:center">Fin. T</th><th style="${_th};text-align:center">Alvo T</th>
                <th style="${_th};text-align:center">Fin. A</th><th style="${_th};text-align:center">Alvo A</th>
                <th style="${_th};text-align:center">Total</th><th style="${_th};text-align:center">Def. T</th>
            </tr></thead><tbody>`;
            valid.forEach(m => {
                const ts = si(m.stats.team_shots) ?? '-';
                const tst = si(m.stats.team_shots_on_target) ?? '-';
                const os = si(m.stats.opp_shots) ?? '-';
                const ost = si(m.stats.opp_shots_on_target) ?? '-';
                const tot = (si(m.stats.team_shots) || 0) + (si(m.stats.opp_shots) || 0);
                const sv = si(m.stats.team_saves) ?? '-';
                h += `<tr><td style="${_td};color:var(--text-muted)">${m.date}</td><td style="${_td}">${m.opponent}</td>
                    <td style="${_td};text-align:center">${ts}</td><td style="${_td};text-align:center">${tst}</td>
                    <td style="${_td};text-align:center">${os}</td><td style="${_td};text-align:center">${ost}</td>
                    <td style="${_td};text-align:center;font-weight:700">${tot}</td>
                    <td style="${_td};text-align:center">${sv}</td></tr>`;
            });
            h += '</tbody></table>' + detailClose;
            return h;
        })();

        // ‚ïê‚ïê‚ïê TAB EV+ JOGADORES ‚ïê‚ïê‚ïê
        const playersPanel = (() => {
            // Agregar dados de jogadores por todos os jogos
            const matchesWithPlayers = ms.filter(m => m.players && m.players.length > 0);
            if (!matchesWithPlayers.length) return '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Dados de finalizacoes de jogadores indisponiveis.<br><span style="font-size:9px">Estes dados sao buscados via API ao carregar o historico.</span></div>';

            const playerMap = {};
            matchesWithPlayers.forEach((m, mi) => {
                m.players.forEach(p => {
                    if (!p.name || !p.minutes || p.minutes < 1) return;
                    const key = p.id || p.name;
                    if (!playerMap[key]) {
                        playerMap[key] = {
                            id: p.id, name: p.name, position: p.position,
                            matches: 0, totalShots: 0, totalSOT: 0, totalGoals: 0,
                            totalAssists: 0, totalMinutes: 0,
                            shotsPerMatch: [], sotPerMatch: [],
                            matchDetails: [],
                        };
                    }
                    const pl = playerMap[key];
                    pl.matches++;
                    pl.totalShots += p.total_shots;
                    pl.totalSOT += p.shots_on_target;
                    pl.totalGoals += p.goals;
                    pl.totalAssists += p.assists;
                    pl.totalMinutes += p.minutes;
                    pl.shotsPerMatch.push(p.total_shots);
                    pl.sotPerMatch.push(p.shots_on_target);
                    pl.matchDetails.push({
                        date: m.date, opponent: m.opponent, minutes: p.minutes,
                        shots: p.total_shots, sot: p.shots_on_target,
                        goals: p.goals, substitute: p.substitute,
                    });
                });
            });

            // Filtrar e ordenar por m√©dia de finaliza√ß√µes
            const players = Object.values(playerMap)
                .filter(p => p.matches >= 2)
                .sort((a, b) => (b.totalShots / b.matches) - (a.totalShots / a.matches));

            if (!players.length) return '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Insuficientes dados de jogadores (minimo 2 partidas)</div>';

            let h = '';

            // ‚îÄ‚îÄ 1. RANKING DE FINALIZA√á√ïES ‚îÄ‚îÄ
            h += '<div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">üèÜ Ranking de Finalizacoes por Jogador</div>';
            h += `<div style="overflow-x:auto;margin-bottom:16px"><table style="width:100%;border-collapse:collapse;font-size:11px">
            <thead><tr>
                <th style="${_th}">Jogador</th><th style="${_th};text-align:center">Pos</th>
                <th style="${_th};text-align:center">Jogos</th><th style="${_th};text-align:center">Min</th>
                <th style="${_th};text-align:center">Fin. Total</th><th style="${_th};text-align:center;color:var(--accent-green)">Fin/J</th>
                <th style="${_th};text-align:center">No Alvo</th><th style="${_th};text-align:center;color:var(--accent-blue)">Alvo/J</th>
                <th style="${_th};text-align:center">Gols</th><th style="${_th};text-align:center">Assist.</th>
            </tr></thead><tbody>`;
            players.slice(0, 15).forEach((p, i) => {
                const avgS = (p.totalShots / p.matches).toFixed(1);
                const avgSOT = (p.totalSOT / p.matches).toFixed(1);
                const posColor = p.position === 'F' ? 'var(--accent-red)' : p.position === 'M' ? 'var(--accent-green)' : p.position === 'D' ? 'var(--accent-blue)' : 'var(--text-muted)';
                const posLabel = p.position === 'F' ? 'ATA' : p.position === 'M' ? 'MEI' : p.position === 'D' ? 'DEF' : p.position === 'G' ? 'GOL' : p.position;
                const rowBg = i < 3 ? 'rgba(0,255,136,0.03)' : 'transparent';
                h += `<tr style="background:${rowBg}">
                    <td style="${_td};font-weight:${i < 3 ? '700' : '400'}">${i < 3 ? '‚≠ê ' : ''}${p.name}</td>
                    <td style="${_td};text-align:center"><span style="color:${posColor};font-weight:700;font-size:9px">${posLabel}</span></td>
                    <td style="${_td};text-align:center">${p.matches}</td>
                    <td style="${_td};text-align:center;color:var(--text-muted)">${p.totalMinutes}</td>
                    <td style="${_td};text-align:center">${p.totalShots}</td>
                    <td style="${_td};text-align:center;font-weight:700;color:var(--accent-green)">${avgS}</td>
                    <td style="${_td};text-align:center">${p.totalSOT}</td>
                    <td style="${_td};text-align:center;font-weight:700;color:var(--accent-blue)">${avgSOT}</td>
                    <td style="${_td};text-align:center;font-weight:700">${p.totalGoals}</td>
                    <td style="${_td};text-align:center">${p.totalAssists}</td>
                </tr>`;
            });
            h += '</tbody></table></div>';

            // ‚îÄ‚îÄ 2. EV+ FINALIZA√á√ïES POR JOGADOR ‚îÄ‚îÄ
            const topPlayers = players.filter(p => p.matches >= 2 && p.totalShots > 0).slice(0, 10);
            if (topPlayers.length) {
                h += '<div style="font-size:10px;font-weight:700;color:var(--accent-green);margin:8px 0 4px;text-transform:uppercase">‚ö° EV+ Finalizacoes por Jogador (Over/Under)</div>';
                h += '<div style="font-size:9px;color:var(--text-muted);margin-bottom:8px">Probabilidade historica de cada jogador ter mais de X finalizacoes. "Fair" = odd justa. Se o mercado oferecer odd MAIOR, pode ser EV+.</div>';

                topPlayers.forEach(p => {
                    const avgS = (p.totalShots / p.matches).toFixed(1);
                    h += `<div style="background:rgba(255,255,255,0.02);border-radius:8px;padding:10px 12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.04)">`;
                    h += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <span style="font-weight:700;font-size:12px;color:var(--text-primary)">${p.name}</span>
                        <span style="font-size:9px;color:var(--text-muted)">${p.matches}j | ${avgS} fin/j | ${(p.totalSOT / p.matches).toFixed(1)} alvo/j</span>
                    </div>`;

                    // O/U Finaliza√ß√µes
                    h += '<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin-bottom:3px">FINALIZACOES</div>';
                    [0.5, 1.5, 2.5, 3.5, 4.5].forEach(line => {
                        const over = p.shotsPerMatch.filter(s => s > line).length;
                        h += evBar('O ' + line, over, p.matches, 'var(--accent-green)');
                    });

                    // O/U Finaliza√ß√µes em Gol
                    h += '<div style="font-size:9px;font-weight:600;color:var(--text-muted);margin:6px 0 3px">FINALIZACOES EM GOL (No Alvo)</div>';
                    [0.5, 1.5, 2.5, 3.5].forEach(line => {
                        const over = p.sotPerMatch.filter(s => s > line).length;
                        h += evBar('O ' + line, over, p.matches, 'var(--accent-blue)');
                    });

                    h += '</div>';
                });
            }

            // ‚îÄ‚îÄ 3. DETALHAMENTO JOGO A JOGO POR JOGADOR ‚îÄ‚îÄ
            h += detailOpen.replace('VER JOGO A JOGO', 'VER HISTORICO COMPLETO POR JOGADOR');
            topPlayers.slice(0, 8).forEach(p => {
                h += `<div style="margin-bottom:10px">
                <div style="font-size:11px;font-weight:700;color:var(--text-primary);margin-bottom:4px">${p.name} <span style="color:var(--text-muted);font-weight:400">(${p.matches} jogos)</span></div>
                <table style="width:100%;border-collapse:collapse;font-size:10px">
                <thead><tr>
                    <th style="${_th}">Data</th><th style="${_th}">Adversario</th>
                    <th style="${_th};text-align:center">Min</th>
                    <th style="${_th};text-align:center">Fin.</th><th style="${_th};text-align:center">Alvo</th>
                    <th style="${_th};text-align:center">Gols</th><th style="${_th};text-align:center">Titular</th>
                </tr></thead><tbody>`;
                p.matchDetails.forEach(md => {
                    const shotsBg = md.shots >= 3 ? 'rgba(0,255,136,0.08)' : 'transparent';
                    const sotBg = md.sot >= 2 ? 'rgba(100,180,255,0.08)' : 'transparent';
                    const titLabel = md.substitute ? '<span style="color:var(--text-muted);font-size:9px">SUB</span>' : '<span style="color:var(--accent-green);font-size:9px">TIT</span>';
                    h += `<tr>
                        <td style="${_td};color:var(--text-muted)">${md.date}</td>
                        <td style="${_td}">${md.opponent}</td>
                        <td style="${_td};text-align:center;color:var(--text-muted)">${md.minutes}'</td>
                        <td style="${_td};text-align:center;font-weight:700;background:${shotsBg}">${md.shots}</td>
                        <td style="${_td};text-align:center;font-weight:700;background:${sotBg}">${md.sot}</td>
                        <td style="${_td};text-align:center;font-weight:700;color:${md.goals > 0 ? 'var(--accent-green)' : 'var(--text-muted)'}">${md.goals}</td>
                        <td style="${_td};text-align:center">${titLabel}</td>
                    </tr>`;
                });
                h += '</tbody></table></div>';
            });
            h += detailClose;

            return h;
        })();

        // ‚ïê‚ïê‚ïê TAB 5: POSSE, FALTAS, xG, PASSES ‚ïê‚ïê‚ïê
        const otherPanel = (() => {
            let html = '';

            // Posse
            const possValid = ms.filter(m => m.stats?.team_possession != null);
            if (possValid.length) {
                const pvn = possValid.length;
                let tp = 0;
                possValid.forEach(m => { tp += parsePoss(m.stats.team_possession) || 0; });
                const avg = (tp / pvn).toFixed(1);
                html += `<div style="margin-bottom:16px">
                    <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">Posse de Bola</div>
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="font-size:28px;font-weight:800;color:var(--accent-green)">${avg}%</div>
                        <div style="flex:1">${pctBar('Media', Math.round(tp / pvn), 100, 'var(--accent-green)')}</div>
                    </div>
                </div>`;
            }

            // xG
            const xgValid = ms.filter(m => m.stats?.team_expected_goals != null);
            if (xgValid.length) {
                const xn = xgValid.length;
                let txg = 0, oxg = 0;
                xgValid.forEach(m => {
                    txg += parseFloat(m.stats.team_expected_goals) || 0;
                    oxg += parseFloat(m.stats.opp_expected_goals) || 0;
                });
                html += `<div style="margin-bottom:16px">
                    <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">Expected Goals (xG)</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px">
                        ${kpi('xG Time/J', (txg / xn).toFixed(2), 'var(--accent-green)')}
                        ${kpi('xG Advers./J', (oxg / xn).toFixed(2), 'var(--accent-red)')}
                        ${kpi('xG Total/J', ((txg + oxg) / xn).toFixed(2), 'var(--text-primary)')}
                        ${kpi('xG Diff/J', ((txg - oxg) / xn > 0 ? '+' : '') + ((txg - oxg) / xn).toFixed(2), (txg - oxg) >= 0 ? 'var(--accent-green)' : 'var(--accent-red)')}
                    </div>
                </div>`;
            }

            // Faltas
            const foulsValid = ms.filter(m => m.stats?.team_fouls != null);
            if (foulsValid.length) {
                const fn_ = foulsValid.length;
                let tf = 0, of_ = 0;
                foulsValid.forEach(m => {
                    tf += si(m.stats.team_fouls) || 0;
                    of_ += si(m.stats.opp_fouls) || 0;
                });
                const fLines = [17.5, 19.5, 21.5, 23.5, 25.5];
                const fOvc = fLines.map(() => 0);
                foulsValid.forEach(m => {
                    const tot = (si(m.stats.team_fouls) || 0) + (si(m.stats.opp_fouls) || 0);
                    fLines.forEach((l, i) => { if (tot > l) fOvc[i]++; });
                });
                html += `<div style="margin-bottom:16px">
                    <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">Faltas</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
                        ${kpi('Media Time/J', (tf / fn_).toFixed(1), 'var(--accent-yellow)')}
                        ${kpi('Media Advers./J', (of_ / fn_).toFixed(1), 'var(--accent-red)')}
                        ${kpi('Total/J', ((tf + of_) / fn_).toFixed(1), 'var(--text-primary)')}
                    </div>
                    <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase">Over/Under Faltas Totais</div>
                    ${fLines.map((l, i) => pctBar('O ' + l, fOvc[i], fn_, 'var(--accent-yellow)')).join('')}
                </div>`;
            }

            // Impedimentos
            const offValid = ms.filter(m => m.stats?.team_offsides != null);
            if (offValid.length) {
                const on_ = offValid.length;
                let to_ = 0, oo_ = 0;
                offValid.forEach(m => {
                    to_ += si(m.stats.team_offsides) || 0;
                    oo_ += si(m.stats.opp_offsides) || 0;
                });
                html += `<div style="margin-bottom:16px">
                    <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">Impedimentos</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px">
                        ${kpi('Media Time/J', (to_ / on_).toFixed(1), 'var(--text-primary)')}
                        ${kpi('Media Advers./J', (oo_ / on_).toFixed(1), 'var(--text-primary)')}
                    </div>
                </div>`;
            }

            // Passes
            const passValid = ms.filter(m => m.stats?.team_passes != null);
            if (passValid.length) {
                const pn = passValid.length;
                let tpass = 0, opass = 0;
                passValid.forEach(m => {
                    tpass += si(m.stats.team_passes) || 0;
                    opass += si(m.stats.opp_passes) || 0;
                });
                const pctV = ms.filter(m => m.stats?.team_passes_pct != null);
                let tpct = 0, opct = 0;
                if (pctV.length) {
                    pctV.forEach(m => {
                        tpct += parsePoss(m.stats.team_passes_pct) || 0;
                        opct += parsePoss(m.stats.opp_passes_pct) || 0;
                    });
                }
                html += `<div style="margin-bottom:16px">
                    <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase">Passes</div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px">
                        ${kpi('Media Time/J', (tpass / pn).toFixed(0), 'var(--accent-green)')}
                        ${kpi('Media Advers./J', (opass / pn).toFixed(0), 'var(--accent-red)')}
                        ${pctV.length ? kpi('Precisao Time', (tpct / pctV.length).toFixed(0) + '%', 'var(--accent-green)') : ''}
                        ${pctV.length ? kpi('Precisao Adv.', (opct / pctV.length).toFixed(0) + '%', 'var(--accent-red)') : ''}
                    </div>
                </div>`;
            }

            if (!html) html = '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Dados gerais indisponiveis</div>';
            return html;
        })();

        // ‚ïê‚ïê‚ïê TAB 6: 1¬∞ TEMPO + CLEAN SHEET + ESPECIAIS ‚ïê‚ïê‚ïê
        const specialsPanel = (() => {
            // ‚îÄ‚îÄ HT (1¬∞ Tempo) ‚îÄ‚îÄ
            const htValid = ms.filter(m => m.ht_total != null);
            let h = '';
            if (htValid.length) {
                const hn = htValid.length;
                let htWin = 0, htDraw = 0, htLoss = 0;
                const htLines = [0.5, 1.5, 2.5];
                const htOvc = htLines.map(() => 0);
                htValid.forEach(m => {
                    const myHT = m.is_home ? m.ht_home : m.ht_away;
                    const opHT = m.is_home ? m.ht_away : m.ht_home;
                    if (myHT > opHT) htWin++; else if (myHT === opHT) htDraw++; else htLoss++;
                    htLines.forEach((l, i) => { if (m.ht_total > l) htOvc[i]++; });
                });
                h += `<div style="font-size:10px;font-weight:700;color:var(--accent-cyan);margin-bottom:6px;text-transform:uppercase">‚è±Ô∏è Resultado no 1¬∞ Tempo</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">
                    ${kpi('Vencendo HT', ((htWin/hn)*100).toFixed(0)+'%', 'var(--accent-green)')}
                    ${kpi('Empatando HT', ((htDraw/hn)*100).toFixed(0)+'%', 'var(--accent-yellow)')}
                    ${kpi('Perdendo HT', ((htLoss/hn)*100).toFixed(0)+'%', 'var(--accent-red)')}
                    ${kpi('Amostra', hn+'j', 'var(--text-muted)')}
                </div>`;
                h += '<div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase">Over/Under Gols 1¬∞ Tempo</div>';
                htLines.forEach((l, i) => { h += evBar('O '+l, htOvc[i], hn, 'var(--accent-cyan)'); });
                h += detailOpen + `<table style="width:100%;border-collapse:collapse;font-size:11px"><thead><tr>
                    <th style="${_th}">Data</th><th style="${_th}">Adversario</th>
                    <th style="${_th};text-align:center">HT Time</th><th style="${_th};text-align:center">HT Adv.</th>
                    <th style="${_th};text-align:center">HT Total</th><th style="${_th};text-align:center">FT</th>
                </tr></thead><tbody>`;
                htValid.forEach(m => {
                    const myHT = m.is_home ? m.ht_home : m.ht_away;
                    const opHT = m.is_home ? m.ht_away : m.ht_home;
                    const myFT = m.is_home ? m.score_home : m.score_away;
                    const opFT = m.is_home ? m.score_away : m.score_home;
                    h += `<tr><td style="${_td};color:var(--text-muted)">${m.date}</td><td style="${_td}">${m.opponent}</td>
                        <td style="${_td};text-align:center">${myHT}</td><td style="${_td};text-align:center">${opHT}</td>
                        <td style="${_td};text-align:center;font-weight:700">${m.ht_total}</td>
                        <td style="${_td};text-align:center;font-weight:700">${myFT}-${opFT}</td></tr>`;
                });
                h += '</tbody></table>' + detailClose;
            } else {
                h += '<div style="color:var(--text-muted);font-size:11px;margin-bottom:16px">Dados de 1¬∞ Tempo indisponiveis</div>';
            }

            // ‚îÄ‚îÄ Clean Sheet & Win to Nil & Especiais ‚îÄ‚îÄ
            const nn = ms.length;
            if (nn) {
                let cs = 0, fts = 0, wtn = 0, oddG = 0;
                ms.forEach(m => {
                    const my = m.is_home ? m.score_home : m.score_away;
                    const op = m.is_home ? m.score_away : m.score_home;
                    if (op === 0) cs++;
                    if (my === 0) fts++;
                    if (my > 0 && op === 0) wtn++;
                    if (m.total_goals % 2 === 1) oddG++;
                });
                h += `<div style="font-size:10px;font-weight:700;color:var(--accent-cyan);margin:16px 0 6px;text-transform:uppercase">üß§ Clean Sheet & Especiais</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                    ${kpi('Clean Sheet', ((cs/nn)*100).toFixed(0)+'%', 'var(--accent-green)')}
                    ${kpi('Falhou Marcar', ((fts/nn)*100).toFixed(0)+'%', 'var(--accent-red)')}
                    ${kpi('Vit s/ Sofrer', ((wtn/nn)*100).toFixed(0)+'%', 'var(--accent-green)')}
                    ${kpi('Gols Impar', ((oddG/nn)*100).toFixed(0)+'%', 'var(--accent-yellow)')}
                    ${kpi('Gols Par', (((nn-oddG)/nn)*100).toFixed(0)+'%', 'var(--accent-blue)')}
                </div>`;
                h += '<div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase">EV+ Especiais</div>';
                h += evBar('CS Sim', cs, nn, 'var(--accent-green)');
                h += evBar('CS Nao', nn-cs, nn, 'var(--accent-red)');
                h += evBar('V s/Sofrer', wtn, nn, 'var(--accent-green)');
                h += evBar('Gols Impar', oddG, nn, 'var(--accent-yellow)');
                h += evBar('Gols Par', nn-oddG, nn, 'var(--accent-blue)');
            }
            if (!h) h = '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:16px">Dados especiais indisponiveis</div>';
            return h;
        })();

        // ‚ïê‚ïê‚ïê Montar tabs ‚ïê‚ïê‚ïê
        const tabs = [
            { id: 'goals',    label: '‚öΩ Gols & BTTS',      content: goalsPanel },
            { id: 'specials', label: '‚è±Ô∏è HT/CS/Especiais',  content: specialsPanel },
            { id: 'corners',  label: 'üèÅ Escanteios',       content: cornersPanel },
            { id: 'cards',    label: 'üü® Cartoes',          content: cardsPanel },
            { id: 'shots',    label: 'üéØ Fin. Time',        content: shotsPanel },
            { id: 'players',  label: '‚ö° EV+ Jogadores',    content: playersPanel },
            { id: 'other',    label: 'üìä Posse/xG/Gerais',  content: otherPanel },
        ];

        const btnStyle = 'padding:6px 14px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,0.08);transition:all .2s';

        let html = `<div style="margin-top:16px;padding:14px;background:rgba(255,255,255,0.015);border-radius:10px;border:1px solid var(--border)">`;
        html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px">
            <div style="font-size:12px;font-weight:800;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px">üìä Analise por Mercado</div>
            <div style="font-size:9px;color:var(--text-muted)">${n} jogos com estatisticas de ${ms.length > 0 ? ms.length : 0} partidas</div>
        </div>`;

        html += `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">`;
        tabs.forEach((t, i) => {
            const bg = i === 0 ? 'var(--accent-green)' : 'rgba(255,255,255,0.05)';
            const fg = i === 0 ? '#000' : 'var(--text-secondary)';
            const bc = i === 0 ? 'var(--accent-green)' : 'rgba(255,255,255,0.08)';
            html += `<button id="${uid}_btn_${t.id}" data-mkt-btn="${uid}" style="${btnStyle};background:${bg};color:${fg};border-color:${bc}" onclick="switchMktTab('${uid}','${t.id}')">${t.label}</button>`;
        });
        html += '</div>';

        tabs.forEach((t, i) => {
            html += `<div id="${uid}_${t.id}" data-mkt-uid="${uid}" style="display:${i === 0 ? 'block' : 'none'}">${t.content}</div>`;
        });

        html += '</div>';
        return html;
    };

    // ‚îÄ‚îÄ Renderizar secao de um time ‚îÄ‚îÄ
    let _mktCounter = 0;
    const renderTeam = (data, name, color) => {
        const lg = data.league_matches || [];
        const all = data.all_matches || [];
        const mktUid = 'mkt_' + (++_mktCounter) + '_' + Date.now();
        let html = sectionTitle('', name, color);

        if (lg.length > 0) {
            html += subTitle('No Campeonato Atual (' + (lg[0]?.league_name || '') + ')');
            html += summaryBadges(calcSummary(lg));
            html += tableWrap(lg.map(matchRow).join(''));
        }
        if (all.length > 0) {
            html += subTitle('Todas as Competicoes (ultimos ' + all.length + ')');
            html += summaryBadges(calcSummary(all));
            html += tableWrapFull(all.map(matchRowFull).join(''));
        }
        if (!lg.length && !all.length) {
            html += '<div style="color:var(--text-muted);padding:12px;text-align:center">Sem dados historicos disponiveis</div>';
        }

        // An√°lise por Mercado ‚Äî usa all_matches (mais dados) ou lg se all vazio
        const mktMatches = all.length > 0 ? all : lg;
        if (mktMatches.length > 0) {
            html += buildMarketAnalysis(mktMatches, mktUid);
        }

        return html;
    };

    // ‚îÄ‚îÄ Renderizar H2H ‚îÄ‚îÄ
    const renderH2H = (matches, hName, aName) => {
        if (!matches || !matches.length) return sectionTitle('‚öîÔ∏è', 'Confronto Direto', 'var(--accent-yellow)') + '<div style="color:var(--text-muted);padding:12px;text-align:center">Sem confrontos diretos encontrados</div>';

        // Estatisticas do H2H
        let hWins = 0, aWins = 0, draws = 0, totalG = 0, over25 = 0;
        matches.forEach(m => {
            totalG += m.total_goals;
            if (m.total_goals > 2.5) over25++;
            if (m.score_home > m.score_away) {
                // Verificar quem eh quem
                if (m.home_team === hName || m.home_id === (homeData?.team_id)) hWins++; else aWins++;
            } else if (m.score_away > m.score_home) {
                if (m.away_team === hName || m.away_id === (homeData?.team_id)) hWins++; else aWins++;
            } else {
                draws++;
            }
        });

        const avgG = (totalG / matches.length).toFixed(1);
        const o25Pct = ((over25 / matches.length) * 100).toFixed(0);

        let html = sectionTitle('‚öîÔ∏è', 'Confronto Direto ‚Äî ' + hName + ' vs ' + aName, 'var(--accent-yellow)');
        html += `<div style="display:flex;flex-wrap:wrap;gap:5px;margin:6px 0 10px">
            ${badge(hWins + ' vit. ' + hName, 'rgba(0,255,136,0.12)', 'var(--accent-green)')}
            ${badge(draws + ' empates', 'rgba(255,200,0,0.12)', 'var(--accent-yellow)')}
            ${badge(aWins + ' vit. ' + aName, 'rgba(100,180,255,0.12)', 'var(--accent-blue)')}
            ${badge('Media ' + avgG + ' gols/j', 'rgba(255,255,255,0.05)', 'var(--text-secondary)')}
            ${badge('O2.5: ' + o25Pct + '%', 'rgba(255,255,255,0.05)', 'var(--text-secondary)')}
        </div>`;

        // Tabela H2H
        const h2hRows = matches.map(m => {
            const tg = m.total_goals;
            const ou = tg > 2.5 ? '<span style="color:var(--accent-green)">O2.5</span>' : '<span style="color:var(--accent-red)">U2.5</span>';
            const hc = m.score_home > m.score_away ? 'var(--accent-green)' : m.score_home < m.score_away ? 'var(--accent-red)' : 'var(--accent-yellow)';
            const ac = m.score_away > m.score_home ? 'var(--accent-green)' : m.score_away < m.score_home ? 'var(--accent-red)' : 'var(--accent-yellow)';
            return `<tr>
                <td style="${tdStyle};color:var(--text-muted);white-space:nowrap">${m.date}</td>
                <td style="${tdStyle};font-size:11px">${m.league_name || ''}</td>
                <td style="${tdStyle};text-align:right;font-weight:600"><span style="color:${hc}">${m.home_team}</span></td>
                <td style="${tdStyle};text-align:center;font-weight:800;font-family:'JetBrains Mono';font-size:14px">${m.score_home} - ${m.score_away}</td>
                <td style="${tdStyle};font-weight:600"><span style="color:${ac}">${m.away_team}</span></td>
                <td style="${tdStyle};text-align:center;font-size:10px">${ou}</td>
            </tr>`;
        }).join('');

        html += `<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;min-width:500px">
            <thead><tr>
                <th style="${thStyle}">Data</th>
                <th style="${thStyle}">Competicao</th>
                <th style="${thStyle};text-align:right">Mandante</th>
                <th style="${thStyle};text-align:center">Placar</th>
                <th style="${thStyle}">Visitante</th>
                <th style="${thStyle};text-align:center">O/U</th>
            </tr></thead><tbody>${h2hRows}</tbody></table></div>`;

        return html;
    };

    // ‚îÄ‚îÄ Painel EV+ Summary (top oportunidades pre-computadas) ‚îÄ‚îÄ
    const renderEvSummary = (homeData, awayData, homeName, awayName) => {
        const homeEv = homeData.ev_analysis || {};
        const awayEv = awayData.ev_analysis || {};
        const homeOpps = homeEv.top_opportunities || [];
        const awayOpps = awayEv.top_opportunities || [];
        const homePlayerRank = homeEv.player_rankings || [];
        const awayPlayerRank = awayEv.player_rankings || [];
        if (!homeOpps.length && !awayOpps.length && !homePlayerRank.length && !awayPlayerRank.length) return '';

        const _thr = 'padding:6px 8px;font-size:10px;text-align:left;border-bottom:1px solid var(--border);color:var(--text-muted);text-transform:uppercase;font-weight:700';
        const _tdr = 'padding:5px 8px;font-size:11px;border-bottom:1px solid rgba(255,255,255,0.03)';

        const fairOddClass = (fair) => {
            if (fair <= 1.30) return 'color:var(--accent-green);font-weight:700';
            if (fair <= 1.60) return 'color:var(--accent-yellow);font-weight:700';
            return 'color:var(--text-secondary)';
        };

        const renderOppsTable = (opps, teamName, color) => {
            if (!opps.length) return '';
            let h = `<div style="margin-bottom:14px">
                <div style="font-size:11px;font-weight:800;color:${color};margin-bottom:6px">${teamName}</div>
                <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">
                <thead><tr>
                    <th style="${_thr}">Mercado</th><th style="${_thr}">Linha</th>
                    <th style="${_thr};text-align:center">Prob. Hist.</th>
                    <th style="${_thr};text-align:center">Fair Odd</th>
                    <th style="${_thr};text-align:center">Amostra</th>
                    <th style="${_thr};text-align:center">Veredicto</th>
                </tr></thead><tbody>`;
            opps.forEach(o => {
                const badge = o.pct >= 70 ? '<span style="background:var(--accent-green);color:#000;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700">FORTE</span>'
                    : o.pct >= 55 ? '<span style="background:var(--accent-yellow);color:#000;padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700">PROVAVEL</span>'
                    : '<span style="color:var(--text-muted);font-size:9px">NEUTRO</span>';
                h += `<tr>
                    <td style="${_tdr}">${o.market}</td>
                    <td style="${_tdr};font-weight:600">${o.line}</td>
                    <td style="${_tdr};text-align:center;font-weight:700;color:${o.pct >= 65 ? 'var(--accent-green)' : 'var(--text-primary)'}">${o.pct}%</td>
                    <td style="${_tdr};text-align:center;${fairOddClass(o.fair_odd)}">${o.fair_odd}</td>
                    <td style="${_tdr};text-align:center;color:var(--text-muted)">${o.sample}j</td>
                    <td style="${_tdr};text-align:center">${badge}</td>
                </tr>`;
            });
            h += '</tbody></table></div></div>';
            return h;
        };

        const renderPlayerRanking = (players, teamName, color) => {
            if (!players.length) return '';
            let h = `<div style="margin-bottom:10px">
                <div style="font-size:10px;font-weight:700;color:${color};margin-bottom:6px;text-transform:uppercase">Ranking Jogadores ‚Äî ${teamName}</div>
                <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:10px">
                <thead><tr>
                    <th style="${_thr}">Jogador</th><th style="${_thr};text-align:center">Pos</th>
                    <th style="${_thr};text-align:center">Jogos</th>
                    <th style="${_thr};text-align:center">Fin/J</th><th style="${_thr};text-align:center">Alvo/J</th>
                    <th style="${_thr};text-align:center">O0.5 Fin</th><th style="${_thr};text-align:center">O1.5 Fin</th>
                    <th style="${_thr};text-align:center">O0.5 Gol</th><th style="${_thr};text-align:center">O1.5 Gol</th>
                    <th style="${_thr};text-align:center">Gols</th>
                </tr></thead><tbody>`;
            players.slice(0, 10).forEach(p => {
                const s05 = p.shots_lines?.['o0.5'];
                const s15 = p.shots_lines?.['o1.5'];
                const g05 = p.sot_lines?.['o0.5'];
                const g15 = p.sot_lines?.['o1.5'];
                const cellEv = (d) => {
                    if (!d) return `<td style="${_tdr};text-align:center;color:var(--text-muted)">-</td>`;
                    const c = d.pct >= 70 ? 'var(--accent-green)' : d.pct >= 50 ? 'var(--accent-yellow)' : 'var(--text-muted)';
                    return `<td style="${_tdr};text-align:center"><span style="color:${c};font-weight:700">${d.pct}%</span><br><span style="font-size:8px;color:var(--text-muted)">@${d.fair_odd}</span></td>`;
                };
                const posLabel = p.position === 'F' ? 'ATA' : p.position === 'M' ? 'MEI' : p.position === 'D' ? 'DEF' : p.position === 'G' ? 'GOL' : p.position || '?';
                h += `<tr>
                    <td style="${_tdr};font-weight:600">${p.name}</td>
                    <td style="${_tdr};text-align:center;font-size:9px">${posLabel}</td>
                    <td style="${_tdr};text-align:center">${p.matches}</td>
                    <td style="${_tdr};text-align:center;font-weight:700;color:var(--accent-green)">${p.avg_shots}</td>
                    <td style="${_tdr};text-align:center;font-weight:700;color:var(--accent-blue)">${p.avg_sot}</td>
                    ${cellEv(s05)}${cellEv(s15)}${cellEv(g05)}${cellEv(g15)}
                    <td style="${_tdr};text-align:center;font-weight:700">${p.total_goals}</td>
                </tr>`;
            });
            h += '</tbody></table></div></div>';
            return h;
        };

        let html = `<div style="background:linear-gradient(135deg, rgba(0,255,136,0.04), rgba(100,180,255,0.04));border:1px solid rgba(0,255,136,0.15);border-radius:12px;padding:16px;margin-bottom:12px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                <span style="font-size:18px">‚ö°</span>
                <div>
                    <div style="font-size:13px;font-weight:800;color:var(--accent-green);text-transform:uppercase;letter-spacing:1px">Oportunidades EV+ Identificadas</div>
                    <div style="font-size:10px;color:var(--text-muted)">Analise baseada em historico recente. "Fair Odd" = odd justa. Se o bookmaker oferece odd MAIOR, historicamente ha valor (+EV).</div>
                </div>
                <div style="margin-left:auto;font-size:9px;color:var(--text-muted);background:rgba(0,255,136,0.08);padding:4px 10px;border-radius:6px">
                    üì¶ Dados salvos no Supabase
                </div>
            </div>`;

        html += renderOppsTable(homeOpps.slice(0, 15), homeName, 'var(--accent-green)');
        html += renderOppsTable(awayOpps.slice(0, 15), awayName, 'var(--accent-blue)');

        // Player rankings side by side
        if (homePlayerRank.length || awayPlayerRank.length) {
            html += '<div style="font-size:11px;font-weight:700;color:var(--text-secondary);margin:8px 0 6px;text-transform:uppercase">üéØ Finalizacoes por Jogador</div>';
            html += renderPlayerRanking(homePlayerRank, homeName, 'var(--accent-green)');
            html += renderPlayerRanking(awayPlayerRank, awayName, 'var(--accent-blue)');
        }

        html += '</div>';
        return html;
    };

    // ‚îÄ‚îÄ Montar tudo verticalmente ‚îÄ‚îÄ
    return `<div>
        ${renderEvSummary(homeData, awayData, homeName || 'Casa', awayName || 'Fora')}
        ${renderTeam(homeData, homeName || 'Casa', 'var(--accent-green)')}
        <div style="height:8px"></div>
        ${renderTeam(awayData, awayName || 'Fora', 'var(--accent-blue)')}
        <div style="height:8px"></div>
        ${renderH2H(h2hData, homeName || 'Casa', awayName || 'Fora')}
    </div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:12px;text-align:center;padding-top:8px;border-top:1px solid var(--border)">
        ‚òÖ Favorito pelas odds &nbsp;|&nbsp; ‚òÜ Underdog &nbsp;|&nbsp; C = Casa &nbsp;|&nbsp; F = Fora &nbsp;|&nbsp; XI = Escalacao disponivel &nbsp;|&nbsp; O2.5/U2.5 = Over/Under 2.5 gols &nbsp;|&nbsp; Esc = Escanteios &nbsp;|&nbsp; Cart = Cartoes &nbsp;|&nbsp; üì¶ = Salvo no Supabase
    </div>`;
}

// START ‚Äî s√≥ carrega status, N√ÉO roda pipeline
init();
</script>

</body>
</html>
